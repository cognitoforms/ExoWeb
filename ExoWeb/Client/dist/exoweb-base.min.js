
Type.registerNamespace("ExoWeb");Type.registerNamespace("ExoWeb.Model");Type.registerNamespace("ExoWeb.Mapper");(function(){var overridableNonEnumeratedMethods;for(var m in{}){if(m=="toString"){overridableNonEnumeratedMethods=[];break;}}
if(!overridableNonEnumeratedMethods)
overridableNonEnumeratedMethods=["toString","toLocaleString","valueOf"];Function.prototype.mixin=function mixin(methods,object){if(!object){object=this.prototype;}
for(var m in methods){if(methods.hasOwnProperty(m))
object[m]=methods[m];}
overridableNonEnumeratedMethods.forEach(function(m){if(methods.hasOwnProperty(m))
object[m]=methods[m];});};Function.prototype.dontDoubleUp=function Function$dontDoubleUp(options){var proceed=this;var calls=[];return function dontDoubleUp(){var origCallback;var origThisPtr;if(options.callbackArg<arguments.length){origCallback=arguments[options.callbackArg];}
if(options.thisPtrArg<arguments.length){origThisPtr=arguments[options.thisPtrArg];}
var groupBy;if(options.groupBy){groupBy=options.groupBy.apply(this,arguments);}
else{groupBy=[this];for(var i=0;i<arguments.length;++i){if(i!==options.callbackArg&&i!==options.thisPtrArg){groupBy.push(arguments[i]);}}}
var callInProgress;for(var c=0;!callInProgress&&c<calls.length;++c){var call=calls[c];if(groupBy.length!=call.groupBy.length){continue;}
callInProgress=call;for(var j=0;j<groupBy.length;++j){if(groupBy[j]!==call.groupBy[j]){callInProgress=null;break;}}}
if(!callInProgress){var call={callback:Functor(),groupBy:groupBy};calls.push(call);call.callback.add(function(){Array.remove(calls,call);if(origCallback){origCallback.apply(origThisPtr||this,arguments);}});arguments[options.callbackArg]=call.callback;proceed.apply(this,arguments);}
else if(origCallback){var batch=Batch.suspendCurrent("dontDoubleUp");callInProgress.callback.add(function(){ExoWeb.Batch.resume(batch);origCallback.apply(origThisPtr||this,arguments);});}};};Function.prototype.cached=function Function$cached(options){var proceed=this;var cache={};return function cached(){var key=options.key.apply(this,arguments);var result=cache[key];if(result===undefined){result=proceed.apply(this,arguments);cache[key]=result;}
return result;};};function bind(obj){var slice=[].slice,args=slice.call(arguments,1),self=this,nop=function(){},bound=function(){return self.apply(this instanceof nop?this:(obj||{}),args.concat(slice.call(arguments)));};nop.prototype=self.prototype;bound.prototype=new nop();return bound;}
if(!Function.prototype.bind)
Function.prototype.bind=bind;Function.prototype.prepare=function prepare(thisPtr,args){var func=this;return function prepare$fn(){return func.apply(thisPtr||this,args||[]);};};Function.prototype.prependArguments=function prependArguments(){var func=this;var additional=Array.prototype.slice.call(arguments);return function prependArguments$fn(){var args=[];args.addRange(additional);args.addRange(Array.prototype.slice.call(arguments));return func.apply(this,args);};};Function.prototype.appendArguments=function appendArguments(){var func=this;var additional=Array.prototype.slice.call(arguments);return function appendArguments$fn(){var args=Array.prototype.slice.call(arguments);args.addRange(additional);return func.apply(this,args);};};Function.prototype.spliceArguments=function spliceArguments(){var func=this;var spliceArgs=arguments;return function spliceArguments$fn(){var args=Array.prototype.slice.call(arguments);args.splice.apply(args,spliceArgs);return func.apply(this,args);};};Function.prototype.sliceArguments=function sliceArguments(){var func=this;var sliceArgs=arguments;return function spliceArguments$fn(){var args=Array.prototype.slice.call(arguments);args=args.slice.apply(args,sliceArgs);return func.apply(this,args);};};function mergeFunctions(fn1,fn2,options){if(!fn1&&!fn2)return;if(!fn2)return fn1;if(!fn1)return fn2;if(options&&options.async===true){return function(){var idx=options.callbackIndex||0;var callback=arguments[idx];if(!callback||!(callback instanceof Function))
ExoWeb.trace.throwAndLog("functions","Unable to merge async functions: the argument at index {0}{1} is not a function.",[idx,options.callbackIndex?"":" (default)"]);var signal=new Signal("mergeFunctions");var args1=Array.prototype.slice.call(arguments);args1.splice(idx,1,signal.pending());fn1.apply(this,args1);var args2=Array.prototype.slice.call(arguments);args2.splice(idx,1,signal.pending());fn2.apply(this,args2);signal.waitForAll(callback,(options.thisPtrIndex&&arguments[options.thisPtrIndex])||this);};}
else{return function(){fn1.apply(this,arguments);fn2.apply(this,arguments);};}}
function equals(obj){return function(other){return obj===other;};}
function not(fn){return function(){return!fn.apply(this,arguments);};}
function before(original,fn){return function(){fn.apply(this,arguments);original.apply(this,arguments);};}
function after(original,fn){return function(){original.apply(this,arguments);fn.apply(this,arguments);};}
function assertArrayArg(arr,functionName){if(!(arr instanceof Array))
throw new TypeError("An array must be passed to \""+functionName+"\".");}
function assertFunctionArg(fun,allowNull,functionName){if(allowNull.constructor!==Boolean){functionName=allowNull;allowNull=false;}
if(allowNull&&(fun===null||fun===undefined))
return;if(!(fun instanceof Function))
throw new TypeError("A callback function must be passed to \""+functionName+"\".");}
function addRange(arr,items){assertArrayArg(arr,"addRange");assertArrayArg(items,"addRange");Array.prototype.push.apply(arr,items);}
function contains(arr,elt,from){assertArrayArg(arr,"contains");return indexOf(arr,elt,from)>-1?true:false;}
function distinct(arr){assertArrayArg(arr,"distinct");var result=[];for(var i=0,len=arr.length;i<len;i++)
if(result.indexOf(arr[i])<0)
result.push(arr[i]);return result;}
function every(arr,callback,thisPtr){assertArrayArg(arr,"every");assertFunctionArg(callback,"every");for(var i=0,len=arr.length;i<len;i++)
if(i in arr&&!callback.call(thisPtr||this,arr[i],i,arr))
return false;return true;}
function filter(arr,callback,thisPtr){assertArrayArg(arr,"filter");assertFunctionArg(callback,"filter");var result=[];for(var i=0,len=arr.length;i<len;i++){if(i in arr){var val=arr[i];if(callback.call(thisPtr||this,val,i,arr)===true)
result.push(val);}}
return result;}
function first(arr,callback,thisPtr){assertArrayArg(arr,"first");assertFunctionArg(callback,true,"first");for(var i=0,len=arr.length;i<len;i++){if(i in arr){var val=arr[i];if(!callback||callback.call(thisPtr||this,val,i,arr)===true){return val;}}}
return null;}
function forEach(arr,callback,thisPtr){assertArrayArg(arr,"forEach");assertFunctionArg(callback,"forEach");for(var i=0,len=arr.length;i<len;i++)
if(i in arr)
callback.call(thisPtr||this,arr[i],i,arr);}
function indexOf(arr,elt,from){assertArrayArg(arr,"indexOf");var len=arr.length;var from=Number(from)||0;from=(from<0)?Math.ceil(from):Math.floor(from);if(from<0)from+=len;for(;from<len;from++)
if(from in arr&&arr[from]===elt)
return from;return-1;}
function intersect(arr1,arr2){return distinct(filter(arr1,function(item){return arr2.indexOf(item)>=0;}));}
function lastIndexOf(arr,item,from){assertArrayArg(arr,"lastIndexOf");var len=arr.length;if(len===0)return-1;var n=len;if(from){n=Number(from);if(n!==n)
n=0;else if(n!==0&&n!==(1/0)&&n!==-(1/0))
n=(n>0||-1)*Math.floor(Math.abs(n));}
var k=n>=0?Math.min(n,len-1):len-Math.abs(n);while(k>=0)
if(k in t&&t[k]===searchElement)
return k;return-1;}
function map(arr,callback,thisPtr){assertArrayArg(arr,"map");assertFunctionArg(callback,"map");var result=[];for(var i=0,len=arr.length;i<len;i++)
if(i in arr)
result[i]=callback.call(thisPtr||this,arr[i],i,arr);return result;}
function mapToArray(arr,callback,thisPtr){var result=[];forEach(arr,function(item,i,a){addRange(result,callback.call(thisPtr||this,item,i,a));});return result;}
function peek(arr){var peekVal=arr.pop();arr.push(peekVal);return peekVal;}
function purge(arr,callback,thisPtr){assertArrayArg(arr,"purge");assertFunctionArg(callback,"purge");var result;for(var i=arr.length-1;i>=0;i--){if(callback.call(thisPtr||this,arr[i],i)===true){if(arr.removeAt)
arr.removeAt(i);else
arr.splice(i,1);if(!result)result=[];result.splice(0,0,i);}}
return result;}
function remove(arr,item){var idx=arr.indexOf(item);if(idx<0)
return false;arr.splice(idx,1);return true;}
function some(arr,callback,thisPtr){assertArrayArg(arr,"some");assertFunctionArg(callback,true,"some");for(var i=0,len=arr.length;i<len;i++)
if(i in arr&&callback.call(thisPtr||this,arr[i],i,arr))
return true;return false;}
if(!Array.prototype.addRange)
Array.prototype.addRange=function(items){addRange(this,items);};if(!Array.prototype.copy)
Array.prototype.copy=function(){return Array.prototype.splice.apply([],[0,0].concat(this));};if(!Array.prototype.clear)
Array.prototype.clear=function(){this.length=0;};if(!Array.prototype.contains)
Array.prototype.contains=function(elt){return contains(this,elt,arguments[1]);};if(!Array.prototype.dequeue)
Array.prototype.dequeue=function(){return this.shift();};if(!Array.prototype.distinct)
Array.prototype.distinct=function(){return distinct(this);};if(!Array.prototype.every)
Array.prototype.every=function(fun){return every(this,fun,arguments[1]);};if(!Array.prototype.filter)
Array.prototype.filter=function(fun){return filter(this,fun,arguments[1]);};if(!Array.prototype.first)
Array.prototype.first=function(fun){return first(this,fun,arguments[1]);};if(!Array.prototype.forEach)
Array.prototype.forEach=function(fun){forEach(this,fun,arguments[1]);};if(!Array.prototype.indexOf)
Array.prototype.indexOf=function(elt){return indexOf(this,elt,arguments[1]);};if(!Array.prototype.intersect)
Array.prototype.intersect=function(items){return intersect(this,items);};if(!Array.prototype.lastIndexOf)
Array.prototype.lastIndexOf=function(item){return lastIndexOf(this,item,arguments[1]);};if(!Array.prototype.map)
Array.prototype.map=function(fun){return map(this,fun,arguments[1]);};if(!Array.prototype.mapToArray)
Array.prototype.mapToArray=function(fun){return mapToArray(this,fun,arguments[1]);};if(!Array.prototype.peek)
Array.prototype.peek=function(){return peek(this);};if(!Array.prototype.purge)
Array.prototype.purge=function(fun){return purge(this,fun,arguments[1]);};if(!Array.prototype.remove)
Array.prototype.remove=function(item){return remove(this,item);};if(!Array.prototype.some)
Array.prototype.some=function(fun){return some(this,fun,arguments[1]);};if(!String.prototype.endsWith){String.prototype.endsWith=function endsWith(text){return this.length===(this.indexOf(text)+text.length);};}
function isNullOrEmpty(str){return str===null||str===undefined||str==="";}
var errorHandler=function noOpErrorHandler(message,e){};function setErrorHandler(fn){errorHandler=fn;}
ExoWeb.setErrorHandler=setErrorHandler;ExoWeb.config={debug:false,signalTimeout:false,signalDebug:false,individualQueryLoading:false,appInstanceId:"?"};ExoWeb.trace={flags:{all:false,batch:false,signal:false,typeInit:false,objectInit:false,propInit:false,listInit:false,lazyLoad:false,markupExt:false,"~":false,"@":false,context:false,tests:false,mocks:false,server:false,ui:false,templates:false,rule:false,model:false,conditions:false,responseHandler:false},_isEnabled:function _isEnabled(category){if(ExoWeb.trace.flags.all){return true;}
if(category instanceof Array){for(var i=0;i<category.length;++i){if(ExoWeb.trace.flags[category[i]]){return true;}}
return false;}
else{return!!ExoWeb.trace.flags[category];}},_formatMessage:function _formatMessage(category,message,args){if(!(category instanceof Array)){category=[category];}
var catStr=category.join(", ");return"["+catStr+"]: "+$format(message,args);},log:function trace$log(category,message,args){if(typeof(console)==="undefined"){return;}
if(ExoWeb.trace._isEnabled(category)){console.log(ExoWeb.trace._formatMessage(category,message,args));}},logWarning:function trace$logWarning(category,message,args){if(!(category instanceof Array)){category=[category,"warning"];}
else{category.push("warning");}
if(typeof(console)!=="undefined"){console.warn(ExoWeb.trace._formatMessage(category,message,args));}},logError:function trace$logError(category,message,args){if(!(category instanceof Array)){category=[category,"error"];}
else{category.push("error");}
var msg=ExoWeb.trace._formatMessage(category,message,args);errorHandler(msg,message instanceof Error?message:null);if(typeof(console)!=="undefined"){console.error(msg);}},throwAndLog:function trace$throwAndLog(category,message,args){ExoWeb.trace.logError(category,message,args);throw $format(message,args);},getCallStack:function getCallStack(){var result=[];for(var f=arguments.callee,depth=0,_f=null;f&&depth<25;_f=f,f=f.arguments.callee.caller,depth++){var name=parseFunctionName(f);var args=Array.prototype.slice.call(f.arguments).map(function formatArg(arg){try{if(arg===undefined){return"undefined";}
else if(arg===null){return"null";}
else if(arg instanceof Array){return"["+arg.map(arguments.callee).join(", ")+"]";}
else if(arg instanceof Function){return parseFunctionName(arg)+"()";}
else if(arg.constructor===String){return"\""+arg+"\"";}
else{var fmt=arg.constructor&&arg.constructor.formats&&arg.constructor.formats.$system;return fmt?fmt.convert(arg):(arg.toString?arg.toString():"~unknown");}}
catch(e){return"ERROR ("+parseFunctionName(arg.constructor)+"): "+e.toString();}}).join(", ");result.push(name+"("+args+")");if(_f!==null&_f===f){result.push("non-terminating loop detected...");break;}}
return result;}};var funcRegex=/function\s*([\w_\$]*)/i;function parseFunctionName(f){var result=funcRegex.exec(f);return result?(result[1]||"{anonymous}"):"{anonymous}";}
ExoWeb.parseFunctionName=parseFunctionName;var log=ExoWeb.trace.log;var logError=ExoWeb.trace.logError;var throwAndLog=ExoWeb.trace.throwAndLog;var cacheInited=false;if(window.localStorage){ExoWeb.cache=function(key,value){if(!cacheInited){cacheInited=true;if(window.localStorage["cacheHash"])
window.localStorage.clear();if(ExoWeb.cache("cacheHash")!=cacheHash){ExoWeb.clearCache();ExoWeb.cache("cacheHash",cacheHash);}}
key="ExoWeb:cache:"+ExoWeb.config.appInstanceId+":"+key;if(arguments.length==1){value=window.localStorage.getItem(key);return value?JSON.parse(value):null;}
else if(arguments.length==2){var json=JSON.stringify(value);try{window.localStorage.setItem(key,json);}
catch(e){ExoWeb.trace.logError("cache",e);}
return value;}};ExoWeb.clearCache=function(){for(var i=localStorage.length-1;i>=0;i--){var key=localStorage.key(i);if(key.substring(0,"ExoWeb:cache".length)=="ExoWeb:cache"){window.localStorage.removeItem(key);}}};}
else{ExoWeb.cache=function(key,value){return null;};ExoWeb.clearCache=function(){};}
var scriptTag=document.getElementsByTagName("script");var referrer=scriptTag[scriptTag.length-1].src;var cacheHash;var match=/[?&]cachehash=([^&]*)/i.exec(referrer);if(match){cacheHash=match[1];}
ExoWeb.cacheHash=cacheHash;var activityCallbacks=[];function registerActivity(callback,thisPtr){if(callback===undefined||callback===null){ExoWeb.trace.throwAndLog("activity","Activity callback cannot be null or undefined.");}
if(!(callback instanceof Function)){ExoWeb.trace.throwAndLog("activity","Activity callback must be a function.");}
var item={callback:callback};if(thisPtr){callback.thisPtr=thisPtr;}
activityCallbacks.push(item);}
ExoWeb.registerActivity=registerActivity;function isBusy(){for(var i=0,len=activityCallbacks.length;i<len;i++){var item=activityCallbacks[i];if(item.callback.call(item.thisPtr||this)===true){return true;}}
return false;}
ExoWeb.isBusy=isBusy;function Batch(label){this._index=batchIndex++;this._labels=[label];this._rootLabel=label;this._subscribers=[];ExoWeb.trace.log("batch","[{0}] {1} - created.",[this._index,this._rootLabel]);allBatches.push(this);}
var batchIndex=0;var allBatches=[];var currentBatch=null;ExoWeb.registerActivity(function(){return Batch.all().length>0;});Batch.all=function Batch_$all(includeEnded){return allBatches.filter(function(e){return includeEnded||!e.isEnded();});};Batch.current=function Batch_$current(){return currentBatch;};Batch.suspendCurrent=function Batch_$suspendCurrent(message){if(currentBatch!==null){var batch=currentBatch;ExoWeb.trace.log("batch","[{0}] {1} - suspending {2}.",[currentBatch._index,currentBatch._rootLabel,message||""]);currentBatch=null;return batch;}};Batch.start=function Batch_$start(label){if(currentBatch){currentBatch._begin(label);}
else{currentBatch=new Batch(label);}
return currentBatch;};Batch.resume=function Batch_$resume(batch){if(batch){(batch._transferredTo||batch)._resume();}};Batch.end=function Batch_$end(batch){(batch._transferredTo||batch)._end();};Batch.whenDone=function Batch_$whenDone(fn){if(currentBatch){currentBatch.whenDone(fn);}
else{fn();}};Batch.current=function Batch_$current(){return currentBatch;};Batch.mixin({_begin:function Batch$_begin(label){ExoWeb.trace.log("batch","[{0}] {1} - beginning label {2}.",[this._index,this._rootLabel,label]);this._labels.push(label);return this;},_end:function Batch$_end(){if(this.isEnded()){ExoWeb.trace.logWarning("batch","[{0}] {1} - already ended.",[this._index,this._rootLabel]);return this;}
var label=this._labels.pop();ExoWeb.trace.log("batch","[{0}] {1} - ending label {2}.",[this._index,this._rootLabel,label]);if(this.isEnded()){ExoWeb.trace.log("batch","[{0}] {1} - complete.",[this._index,this._rootLabel]);if(currentBatch===this){currentBatch=null;}
var subscriber=this._subscribers.dequeue();while(subscriber){subscriber.apply(this,arguments);subscriber=this._subscribers.dequeue();}}
return this;},_transferTo:function Batch$_transferTo(otherBatch){ExoWeb.trace.log("batch","transferring from [{2}] {3} to [{0}] {1}.",[this._index,this._rootLabel,otherBatch._index,otherBatch._rootLabel]);otherBatch._labels.addRange(this._labels);this._labels.clear();otherBatch._subscribers.addRange(this._subscribers);this._subscribers.clear();this._transferredTo=otherBatch;},_resume:function Batch$_resume(){if(this.isEnded()){return;}
if(currentBatch!==null){this._transferTo(currentBatch);return currentBatch;}
ExoWeb.trace.log("batch","[{0}] {1} - resuming.",[this._index,this._rootLabel]);currentBatch=this;return this;},isEnded:function Batch$isEnded(){return this._labels.length===0;},whenDone:function Batch$whenDone(fn){ExoWeb.trace.log("batch","[{0}] {1} - subscribing to batch done.",[this._index,this._rootLabel]);this._subscribers.push(fn);return this;}});ExoWeb.Batch=Batch;var pendingSignalTimeouts;function Signal(debugLabel){this._waitForAll=[];this._pending=0;var _this=this;this._oneDoneFn=function Signal$_oneDoneFn(){ExoWeb.Signal.prototype.oneDone.apply(_this,arguments);};this._debugLabel=debugLabel;}
function doCallback(name,thisPtr,callback,args,executeImmediately){if(executeImmediately===false||(ExoWeb.config.signalTimeout===true&&executeImmediately!==true)){var batch=Batch.suspendCurrent("_doCallback");function timeoutCallback(){ExoWeb.Batch.resume(batch);callback.apply(thisPtr,args||[]);}
if(!pendingSignalTimeouts){pendingSignalTimeouts=[timeoutCallback];window.setTimeout(function(){var callbacks=pendingSignalTimeouts;pendingSignalTimeouts=null;callbacks.forEach(function(cb){cb();});},1);}
else{pendingSignalTimeouts.push(timeoutCallback);}}
else{callback.apply(thisPtr,args||[]);}}
Signal.mixin({pending:function Signal$pending(callback,thisPtr,executeImmediately){if(this._pending===0){Signal.allPending.push(this);}
this._pending++;return this._genCallback(callback,thisPtr,executeImmediately);},orPending:function Signal$orPending(callback,thisPtr,executeImmediately){return this._genCallback(callback,thisPtr,executeImmediately);},_doCallback:function Signal$_doCallback(name,thisPtr,callback,args,executeImmediately){if(ExoWeb.config.signalDebug===true||ExoWeb.config.debug===true){doCallback.apply(this,arguments);}
else{try{doCallback.apply(this,arguments);}
catch(e){logError("signal","({0}) {1} callback threw an exception: {2}",[this._debugLabel,name,e]);}}},_genCallback:function Signal$_genCallback(callback,thisPtr,executeImmediately){if(callback){var signal=this;return function Signal$_genCallback$result(){signal._doCallback("pending",thisPtr||this,function Signal$_genCallback$fn(){callback.apply(this,arguments);signal.oneDone();},arguments,executeImmediately);};}
else{return this._oneDoneFn;}},waitForAll:function Signal$waitForAll(callback,thisPtr,executeImmediately){if(!callback){return;}
if(this._pending===0){this._doCallback("waitForAll",thisPtr,callback,[],executeImmediately);}
else{this._waitForAll.push({"callback":callback,"thisPtr":thisPtr,"executeImmediately":executeImmediately});}},oneDone:function Signal$oneDone(){--this._pending;if(this._pending===0){Signal.allPending.remove(this);}
while(this._pending===0&&this._waitForAll.length>0){var item=this._waitForAll.dequeue();this._doCallback("waitForAll",item.thisPtr,item.callback,[],item.executeImmediately);}},isActive:function Signal$isActive(){return this._pending>0;}});Signal.allPending=[];ExoWeb.Signal=Signal;function Functor(){var funcs=[];var f=function Functor$fn(){for(var i=0;i<funcs.length;++i){var item=funcs[i];if(!item.filter||item.filter.apply(this,arguments)===true){item.fn.apply(this,arguments);if(item.once===true){funcs.splice(i--,1);}}}};f._funcs=funcs;f.add=Functor.add;f.remove=Functor.remove;f.isEmpty=Functor.isEmpty;return f;}
Functor.add=function Functor$add(fn,filter,once){var item={fn:fn};if(filter!==undefined){item.filter=filter;}
if(once!==undefined){item.once=once;}
this._funcs.push(item);};Functor.remove=function Functor$remove(old){for(var i=this._funcs.length-1;i>=0;--i){if(this._funcs[i].fn===old){this._funcs.splice(i,1);break;}}};Functor.isEmpty=function Functor$isEmpty(){return this._funcs.length===0;};var eventsInProgress=0;ExoWeb.registerActivity(function(){return eventsInProgress>0;});Functor.eventing={_addEvent:function Functor$_addEvent(name,func,filter,once){if(!this["_"+name]){this["_"+name]=new Functor();}
this["_"+name].add(func,filter,once);},_removeEvent:function Functor$_removeEvent(name,func){var handler=this["_"+name];if(handler){handler.remove(func);}},_raiseEvent:function Functor$_raiseEvent(name,argsArray){var handler=this["_"+name];if(handler){try{eventsInProgress++;handler.apply(this,argsArray||[]);}
finally{eventsInProgress--;}}},_getEventHandler:function Functor$_getEventHandler(name){return this["_"+name];}};ExoWeb.Functor=Functor;function FunctionChain(steps,thisPtr){if(!(steps instanceof Array)){ExoWeb.trace.throwAndLog("functionChain","Steps must be an array of functions.");}
this._steps=steps;this._thisPtr=thisPtr;}
FunctionChain.prepare=function FunctionChain$_invoke(){var steps=null,thisPtrOuter=null;if(arguments.length===0){steps=[];}
else if(arguments.length===1&&arguments[0]instanceof Array){steps=arguments[0];}
else if(arguments.length===2&&arguments[0]instanceof Array){steps=arguments[0];thisPtrOuter=arguments[1];}
else{steps=Array.prototype.slice.call(arguments);}
return function(callback,thisPtr){var chain=new FunctionChain(steps,thisPtrOuter||this);chain.invoke(callback,thisPtr);};};function doStep(idx,callback,thisPtr){var _callback=callback;var _thisPtr=thisPtr;var nextStep=idx+1<this._steps.length?doStep.prependArguments(idx+1,_callback,_thisPtr):function(){if(_callback&&_callback instanceof Function){_callback.apply(_thisPtr||this,arguments);}};this._steps[idx].call(this._thisPtr||this,nextStep,this);}
FunctionChain.mixin({invoke:function(callback,thisPtr){doStep.call(this,0,callback,thisPtr);}});ExoWeb.FunctionChain=FunctionChain;function EventQueue(raise,areEqual){this._queueing=0;this._queue=[];this._raise=raise;this._areEqual=areEqual;}
EventQueue.prototype={startQueueing:function EventQueue$startQueueing(){++this._queueing;},stopQueueing:function EventQueue$stopQueueing(){if(--this._queueing===0){this.raiseQueue();}},push:function EventQueue$push(item){if(this._queueing){if(this._areEqual){for(var i=0;i<this._queue.length;++i){if(this._areEqual(item,this._queue[i])){return;}}}
this._queue.push(item);}
else{this._raise(item);}},raiseQueue:function EventQueue$raiseQueue(){var nextQueue=[];try{for(var i=0;i<this._queue.length;++i){if(this._raise(this._queue[i])===false){nextQueue.push(this._queue[i]);}}}
finally{if(this._queue.length>0){this._queue=nextQueue;}}}};ExoWeb.EventQueue=EventQueue;function EvalWrapper(value){this.value=value;}
EvalWrapper.mixin({get:function EvalWrapper$get(member){var propValue=getValue(this.value,member);if(propValue===undefined){propValue=window[member];}
if(propValue===undefined){throw new TypeError(member+" is undefined");}
return new EvalWrapper(propValue);}});ExoWeb.EvalWrapper=EvalWrapper;function Transform(root){this.array=root;}
function Transform$compileFilterFunction(filter){var parser=/(([a-z_$][0-9a-z_$]*)([.]?))|(('([^']|\')*')|("([^"]|\")*"))/gi;var skipWords=["true","false","$index","null"];filter=filter.replace(parser,function(match,ignored,name,more,strLiteral){if((strLiteral!==undefined&&strLiteral!==null&&strLiteral.length>0)||skipWords.indexOf(name)>=0){return match;}
if(name==="$item"){return"";}
if(more.length>0){return"get('"+name+"')"+more;}
return"get('"+name+"').value";});return new Function("$item","$index","with(new ExoWeb.EvalWrapper($item)){ return ("+filter+");}");}
var compileFilterFunction=Transform$compileFilterFunction.cached({key:function(filter){return filter;}});function Transform$compileGroupsFunction(groups){return new Function("$item","$index","return ExoWeb.evalPath($item, '"+groups+"');");}
var compileGroupsFunction=Transform$compileGroupsFunction.cached({key:function(groups){return groups;}});function Transform$compileOrderingFunction(ordering){var orderings=[];var parser=/ *([a-z0-9_.]+)( +null)?( +(asc|desc))?( +null)? *(,|$)/gi;ordering.replace(parser,function(match,path,nullsFirst,ws,dir,nullsLast){orderings.push({path:path,ab:dir==="desc"?1:-1,nulls:(nullsLast!==undefined&&nullsLast!==null&&nullsLast.length>0)?1:-1});});return function compare(aObj,bObj){for(var i=0;i<orderings.length;++i){var order=orderings[i];var a=evalPath(aObj,order.path,null,null);var b=evalPath(bObj,order.path,null,null);if(a===null&&b!==null){return order.nulls;}
if(a!==null&&b===null){return-order.nulls;}
if(a<b){return order.ab;}
if(a>b){return-order.ab;}}
return 0;};}
var compileOrderingFunction=Transform$compileOrderingFunction.cached({key:function(ordering){return ordering;}});Transform.mixin({_next:function Transform$_next(fn,args,output){Function.mixin(Transform.prototype,output);output.prior=this;output.transform={fn:fn,args:args};return output;},input:function Transform$input(){return this.array||this;},where:function Transform$where(filter,thisPtr){if(!(filter instanceof Function)){filter=compileFilterFunction(filter);}
var output=[];var input=this.input();var len=input.length;for(var i=0;i<len;++i){var item=input[i];if(filter.apply(thisPtr||item,[item,i])){output.push(item);}}
return this._next(this.where,arguments,output);},groupBy:function Transform$groupBy(groups,thisPtr){if(!(groups instanceof Function)){groups=compileGroupsFunction(groups);}
var output=[];var input=this.input();var len=input.length;for(var i=0;i<len;i++){var item=input[i];var groupKey=groups.apply(thisPtr||item,[item,i]);var group=null;for(var g=0;g<output.length;++g){if(output[g].group==groupKey){group=output[g];group.items.push(item);break;}}
if(!group){output.push({group:groupKey,items:[item]});}}
return this._next(this.groupBy,arguments,output);},orderBy:function Transform$orderBy(ordering,thisPtr){if(!(ordering instanceof Function)){ordering=compileOrderingFunction(ordering);}
var input=this.input();var output=new Array(input.length);var len=input.length;for(var i=0;i<len;i++){output[i]=input[i];}
if(!thisPtr){output.sort(ordering);}
else{output.sort(function(){return ordering.apply(thisPtr,arguments);});}
return this._next(this.orderBy,arguments,output);},live:function Transform$live(){var chain=[];for(var step=this;step;step=step.prior){Array.insert(chain,0,step);}
var input=this.input();var output=Sys.Observer.makeObservable(new Array(input.length));var len=input.length;for(var i=0;i<len;i++){output[i]=input[i];}
Sys.Observer.addCollectionChanged(chain[0].input(),function Transform$live$collectionChanged(){var newResult=$transform(chain[0].input());for(var i=1;i<chain.length;++i){var step=chain[i];newResult=step.transform.fn.apply(newResult,step.transform.args);}
output.beginUpdate();output.clear();Array.addRange(output,newResult);output.endUpdate();});return this._next(this.live,arguments,output);}});ExoWeb.Transform=Transform;window.$transform=function transform(array){return new Transform(array);};function Translator(){this._forwardDictionary={};this._reverseDictionary={};}
Translator.prototype={lookup:function Translator$lookup(source,category,key){if(source[category]){return source[category][key]||null;}},forward:function Translator$forward(category,key){return this.lookup(this._forwardDictionary,category,key);},reverse:function Translator$reverse(category,key){return this.lookup(this._reverseDictionary,category,key);},add:function Translator$addMapping(category,key,value){var suppressReverse=(arguments.length==4&&arguments[3].constructor===Boolean)?arguments[3]:false;if(!this._forwardDictionary[category]){this._forwardDictionary[category]={};}
this._forwardDictionary[category][key]=value;if(!suppressReverse){if(!this._reverseDictionary[category]){this._reverseDictionary[category]={};}
this._reverseDictionary[category][value]=key;}}};ExoWeb.Translator=Translator;function evalPath(obj,path,nullValue,undefinedValue){var steps=path.split(".");if(obj===null){return arguments.length>=3?nullValue:null;}
if(obj===undefined){return arguments.length>=4?undefinedValue:undefined;}
for(var i=0;i<steps.length;++i){var name=steps[i];obj=ExoWeb.getValue(obj,name);if(obj===null){return arguments.length>=3?nullValue:null;}
if(obj===undefined){return arguments.length>=4?undefinedValue:undefined;}}
if(obj===null){return arguments.length>=3?nullValue:null;}
if(obj===undefined){return arguments.length>=4?undefinedValue:undefined;}
return obj;}
ExoWeb.evalPath=evalPath;function getLastTarget(target,propertyPath){var path=propertyPath;var finalTarget=target;if(path.constructor==String){path=path.split(".");}
else if(!(path instanceof Array)){ExoWeb.trace.throwAndLog(["$lastTarget","core"],"invalid parameter propertyPath");}
for(var i=0;i<path.length-1;i++){if(finalTarget){finalTarget=getValue(finalTarget,path[i]);}}
return finalTarget;}
ExoWeb.getLastTarget=getLastTarget;window.$lastTarget=getLastTarget;function isObject(obj){return obj!==null&&obj!==undefined&&(obj instanceof Object||typeof(obj)==="object"||Object.prototype.toString.call(obj)==="[object Object]");}
function getValue(target,property){var getter=target["get_"+property];if(getter){var value=getter.call(target);return value===undefined?null:value;}
else{if((isObject(target)&&property in target)||(target.constructor===String&&/^[0-9]+$/.test(property)&&parseInt(property,10)<target.length)){var value=target[property];return value===undefined?null:value;}
else if(/\./.test(property)){ExoWeb.trace.logWarning("","Possible incorrect usage of \"getValue()\", the path \"{0}\" does not exist on the target and appears to represent a multi-hop path.",[property]);}}}
ExoWeb.getValue=getValue;var ctorProviders=ExoWeb._ctorProviders={};function addCtorProvider(type,provider){var key;if(isType(type,String)){key=type;}
else if(isType(type,Function)){key=parseFunctionName(type);}
else{}
if(!isType(provider,Function)){}
if(key!==undefined&&key!==null){ctorProviders[key]=provider;}}
function getCtor(type){if(type!==undefined&&type!==null){if(isType(type,Function)){return type;}
else{var ctor;if(isType(type,String)){type=type.replace(/(window\.)?(.*)/,"$2");ctor=evalPath(window,type);}
else{var providerKey=parseFunctionName(type.constructor);var provider=ctorProviders[providerKey];if(provider!==undefined&&provider!==null){ctor=provider(type);}}
if(ctor!==undefined&&ctor!==null&&!isType(ctor,Function)){ExoWeb.trace.logWarning("","The given type \"{0}\" is not a function.",[type]);}
else{return ctor;}}}}
ExoWeb.getCtor=getCtor;function isType(val,type){if(val!==undefined&&val!==null&&val===Function&&type!==undefined&&type!==null&&type===Function){return true;}
var ctor=getCtor(type);return val!==undefined&&val!==null&&ctor!==undefined&&ctor!==null&&(val instanceof ctor||val.constructor===ctor);}
ExoWeb.isType=isType;function eachProp(obj,callback,thisPtr){for(var prop in obj)
if(obj.hasOwnProperty(prop))
if(callback.apply(thisPtr||this,[prop,obj[prop]])===false)
break;}
ExoWeb.eachProp=eachProp;function objectToArray(obj){var list=[];eachProp(obj,function(prop,value){list.push(value);});return list;}
ExoWeb.objectToArray=objectToArray;function $format(str,values){if(!values)return str;var source=null,arrayMode=false;if(arguments.length>2){source=Array.prototype.slice.call(arguments,1);arrayMode=true;}
else{source=values;if(values&&values instanceof Array){arrayMode=true;}}
return str.replace(/{([a-z0-9_.]+)}/ig,function $format$token(match,expr){if(arrayMode===false&&expr==="0"){var allOneIndex=true;str.replace(/{([a-z0-9_.]+)}/ig,function $format$token(match,expr){if(expr!=="0"){allOneIndex=false;}});if(allOneIndex===true){source=[values];arrayMode=true;}}
return evalPath(source,expr,"",match).toString();});}
window.$format=$format;function makeHumanReadable(text){return text.replace(/([^A-Z]+)([A-Z])/g,"$1 $2");}
ExoWeb.makeHumanReadable=makeHumanReadable;function isNullOrUndefined(obj){return obj===null||obj===undefined;}
ExoWeb.isNullOrUndefined=isNullOrUndefined;ExoWeb.isNullOrUndefined=isNullOrUndefined;function TimeSpan(ms){this.totalMilliseconds=ms;this.totalSeconds=this.totalMilliseconds/1000;this.totalMinutes=this.totalSeconds/60;this.totalHours=this.totalMinutes/60;this.totalDays=this.totalHours/24;this.milliseconds=Math.floor(ms%1000);ms=ms/1000;this.seconds=Math.floor(ms%60);ms=ms/60;this.minutes=Math.floor(ms%60);ms=ms/60;this.hours=Math.floor(ms%24);ms=ms/24;this.days=Math.floor(ms);}
window.TimeSpan=TimeSpan;Date.mixin({subtract:function Date$subtract(d){return new TimeSpan(this-d);},add:function Date$add(timeSpan){return new Date(this.getTime()+timeSpan.totalMilliseconds);}});Object.copy=function Object$Copy(obj,options){var undefined;if(!options){options={};}
if(!options.maxLevel){options.maxLevel=25;}
var level=arguments.length>2?arguments[2]:0;if(level>=options.maxLevel||typeof obj!=='object'||obj===null||obj===undefined){return obj;}
else{if(obj instanceof Array){var result=[];for(var i=0;i<obj.length;i++){result.push(Object.copy(obj[i]));}
return result;}
else{var value=obj.valueOf();if(obj!=value){return new obj.constructor(value);}else{if(ExoWeb.Model&&obj instanceof ExoWeb.Model.Entity){return obj;}
else{var c={};for(var property in obj){if(options.copyChildren){c[property]=Object.copy(obj[property],options,level+1);}
else{c[property]=obj[property];}}
return c;}}}}};function PropertyObserver(prop){this._source=null;this._prop=prop;this._handler=null;}
PropertyObserver.mixin(Functor.eventing);PropertyObserver.mixin({value:function PropertyObserver$value(){return ExoWeb.getValue(this._source,this._prop);},release:function PropertyObserver$release(value){if(value instanceof Array){Array.forEach(value,function(item){this._raiseEvent("valueReleased",[item]);},this);}
else{this._raiseEvent("valueReleased",[value]);}},capture:function PropertyObserver$capture(value){if(value instanceof Array){Array.forEach(value,function(item){this._raiseEvent("valueCaptured",[item]);},this);var _this=this;if(this._collectionTarget!==undefined&&this._collectionTarget!==null){Sys.Observer.removeCollectionChanged(this._collectionTarget,this._collectionHandler);}
this._collectionTarget=value;this._collectionHandler=function collectionHandler(sender,args){var changes=args.get_changes();_this._handler.apply(this,arguments);Array.forEach(changes.removed||[],function(removed){_this._raiseEvent("valueReleased",[removed]);});Array.forEach(changes.added||[],function(added){_this._raiseEvent("valueCaptured",[added]);});};Sys.Observer.addCollectionChanged(this._collectionTarget,this._collectionHandler);}
else{this._raiseEvent("valueCaptured",[value]);}},start:function PropertyObserver$start(source,handler){if(this._source){ExoWeb.trace.throwAndLog(["observer"],"Cannot start an observer that is already started.");}
var _this=this;this._source=source;this._handler=handler;var value=this.value();this._propHandler=function propHandler(sender,args){_this._handler.apply(this,arguments);if(value!==undefined&&value!==null){_this.release(value);}
value=_this.value();if(value!==undefined&&value!==null){_this.capture(value);}};Sys.Observer.addSpecificPropertyChanged(this._source,this._prop,this._propHandler);if(value!==undefined&&value!==null){this.capture(value);}},stop:function PropertyObserver$stop(){if(this._source){Sys.Observer.removeSpecificPropertyChanged(this._source,this._prop,this._propHandler);if(this._collectionTarget!==undefined&&this._collectionTarget!==null){Sys.Observer.removeCollectionChanged(this._collectionTarget,this._collectionHandler);this.release(this._collectionTarget);}
else{var value=this.value();if(value!==undefined&&value!==null){this.release(value);}}
this._source=null;}}});ExoWeb.PropertyObserver=PropertyObserver;function _raiseSpecificPropertyChanged(target,args){var func=target.__propertyChangeHandlers[args.get_propertyName()];if(func&&func instanceof Function){func.apply(this,arguments);}}
Sys.Observer.addSpecificPropertyChanged=function Sys$Observer$addSpecificPropertyChanged(target,property,handler){if(!target.__propertyChangeHandlers){target.__propertyChangeHandlers={};Sys.Observer.addPropertyChanged(target,_raiseSpecificPropertyChanged);}
var func=target.__propertyChangeHandlers[property];if(!func){target.__propertyChangeHandlers[property]=func=ExoWeb.Functor();}
func.add(handler);};Sys.Observer.removeSpecificPropertyChanged=function Sys$Observer$removeSpecificPropertyChanged(target,property,handler){var func=target.__propertyChangeHandlers?target.__propertyChangeHandlers[property]:null;if(func){func.remove(handler);if(func.isEmpty()){delete target.__propertyChangeHandlers[property];var hasHandlers=false;for(var handler in target.__propertyChangeHandlers){hasHandlers=true;}
if(!hasHandlers){delete target.__propertyChangeHandlers;Sys.Observer.removePropertyChanged(target,_raiseSpecificPropertyChanged);}}}};Sys.Observer.addPathChanged=function Sys$Observer$addPathChanged(target,path,handler,allowNoTarget){if(target===undefined||target===null){if(allowNoTarget===true){return;}
else{ExoWeb.trace.throwAndLog("observer","Cannot watch for changes to \"{0}\" on a null or undefined target.",[path instanceof Array?path.join("."):path]);}}
if(!target.__pathChangeHandlers){target.__pathChangeHandlers={};}
var list=path;if(path instanceof Array){path=path.join(".");}
else{list=path.split(".");}
var roots=[];function processStep(parent,item,index){var observers=[];function addObserver(value){var obs=new PropertyObserver(item);observers.push(obs);if(index===0){roots.push(obs);}
obs.start(value,handler);if(index+1<list.length){processStep(obs,list[index+1],index+1);}}
function removeObserver(value){for(var i=0;i<observers.length;i++){var obs=observers[i];if(obs._source===value){Array.removeAt(observers,i--);if(index===0){Array.remove(roots,obs);}
obs.stop();}}}
if(parent){parent._addEvent("valueCaptured",addObserver);parent._addEvent("valueReleased",removeObserver);}
var source=index===0?target:parent.value();if(source!==undefined&&source!==null){if(source instanceof Array){Array.forEach(source,addObserver);if(index===0){Sys.Observer.addCollectionChanged(source,function(sender,args){var changes=args.get_changes();Array.forEach(changes.removed||[],removeObserver);Array.forEach(changes.added||[],addObserver);handler();});}}
else{addObserver(source);}}}
processStep(null,list[0],0);var pathChangeHandlers=target.__pathChangeHandlers[path];if(!pathChangeHandlers){target.__pathChangeHandlers[path]=pathChangeHandlers=[];}
pathChangeHandlers.push({roots:roots,handler:handler});};Sys.Observer.removePathChanged=function Sys$Observer$removePathChanged(target,path,handler){path=(path instanceof Array)?path.join("."):path;var pathChangeHandlers=target.__pathChangeHandlers?target.__pathChangeHandlers[path]:null;if(pathChangeHandlers){for(var i=0;i<pathChangeHandlers.length;i++){var pathChangeHandler=pathChangeHandlers[i];if(pathChangeHandler.handler===handler){Array.forEach(pathChangeHandler.roots,function(observer){observer.stop();});Array.removeAt(pathChangeHandlers,i--);}}
if(pathChangeHandlers.length===0){delete target.__pathChangeHandlers[path];var hasHandlers=false;for(var handler in target.__pathChangeHandlers){hasHandlers=true;}
if(!hasHandlers){delete target.__pathChangeHandlers;}}}};Sys.Observer._setValue=function Sys$Observer$_setValue$override(target,propertyName,value){var getter,setter,mainTarget=target,path=propertyName.split('.');for(var i=0,l=(path.length-1);i<l;i++){var name=path[i];getter=target["get_"+name];if(typeof(getter)==="function"){target=getter.call(target);}
else{target=target[name];}
var type=typeof(target);if((target===null)||(type==="undefined")){throw Error.invalidOperation(String.format(Sys.Res.nullReferenceInPath,propertyName));}}
var notify=true;var currentValue,lastPath=path[l];getter=target["get_"+lastPath];setter=target["set_"+lastPath];if(typeof(getter)==='function'){currentValue=getter.call(target);}
else{currentValue=target[lastPath];}
if(typeof(setter)==='function'){notify=!setter.__notifies;setter.call(target,value);}
else{target[lastPath]=value;}
if(currentValue!==value){var ctx=Sys.Observer._getContext(mainTarget);if(ctx&&ctx.updating){ctx.dirty=true;return;}
if(notify){Sys.Observer.raisePropertyChanged(mainTarget,path[0]);}}};function Format(options){this._paths=options.paths;this._convert=options.convert;this._convertBack=options.convertBack;this._description=options.description;this._nullString=options.nullString||"";this._undefinedString=options.undefinedString||"";}
Format.fromTemplate=(function Format$fromTemplate(convertTemplate){var paths=[];convertTemplate.replace(/{([a-z0-9_.]+)}/ig,function(match,expr){paths.push(expr);return expr;});return new Format({paths:paths,convert:function convert(obj){if(obj===null||obj===undefined){return"";}
return $format(convertTemplate,obj);}});}).cached({key:function(convertTemplate){return convertTemplate;}});Format.mixin({getPaths:function(){return this._paths||[];},convert:function(val){if(val===undefined){return this._undefinedString;}
if(val===null){return this._nullString;}
if(val instanceof FormatError){return val.get_invalidValue();}
if(!this._convert){return val;}
return this._convert(val);},convertBack:function(val){if(val===null||val==this._nullString){return null;}
if(val===undefined||val==this._undefinedString){return;}
if(val.constructor==String){val=val.trim();if(val.length===0){return null;}}
if(!this._convertBack){return val;}
try{return this._convertBack(val);}
catch(err){return new FormatError(this._description?"{value} must be formatted as "+this._description:"{value} is not properly formatted",val);}}});ExoWeb.Model.Format=Format;Format.registerClass("ExoWeb.Model.Format");function Model(){this._types={};this._validatingQueue=new ExoWeb.EventQueue(function(e){var meta=e.sender;meta._raiseEvent("propertyValidating:"+e.propName,[meta,e.propName]);},function(a,b){return a.sender==b.sender&&a.propName==b.propName;});this._validatedQueue=new ExoWeb.EventQueue(function(e){var meta=e.sender;var propName=e.property;var conditions=[];Sys.Observer.makeObservable(conditions);Array.addRange(conditions,meta._propertyConditions[propName]||[]);meta._raiseEvent("propertyValidated:"+propName,[meta,conditions]);},function(a,b){return a.sender==b.sender&&a.property==b.property;});}
Model.property=function Model$property(path,thisType){var tokens=new PathTokens(path);var firstStep=tokens.steps[0];var isGlobal=firstStep.property!=="this";var type;var lazyLoadTypes=arguments.length>=3&&arguments[2]&&arguments[2].constructor===Boolean?arguments[2]:false;var callback=arguments[3];var thisPtr=arguments[4];if(isGlobal){var typePathSteps=tokens.steps.filter(function(item,i){return i!=tokens.steps.length-1;});var typeName=typePathSteps.map(function(item){return item.property;}).join(".");if(typeName.length===0){ExoWeb.trace.throwAndLog(["model"],"Invalid static property path \"{0}\":  type name must be included.",[path]);}
type=Model.getJsType(typeName,true);if(!type){if(lazyLoadTypes){$extend(typeName,Model.property.prepare(this,Array.prototype.slice.call(arguments)));return;}
else{ExoWeb.trace.throwAndLog(["model"],"Invalid static property path \"{0}\":  type \"{1}\" could not be found.",[path,typeName]);}}
type=type.meta;tokens.steps.splice(0,tokens.steps.length-1);}
else{if(firstStep.cast){var jstype=Model.getJsType(firstStep.cast);if(!jstype){ExoWeb.trace.throwAndLog("model","Path '{0}' references an unknown type: {1}",[path,firstStep.cast]);}
type=jstype.meta;}
else if(thisType instanceof Function){type=thisType.meta;}
else{type=thisType;}
Array.dequeue(tokens.steps);}
if(tokens.steps.length===1){var name=tokens.steps[0].property;if(lazyLoadTypes){if(!LazyLoader.isLoaded(type)){LazyLoader.load(type,null,function(){callback.call(thisPtr||this,type.property(name,true));});}
else{callback.call(thisPtr||this,type.property(name,true));}}
else{return type.property(name,true);}}
else{return new PropertyChain(type,tokens,lazyLoadTypes,thisPtr?callback.bind(thisPtr):callback);}};Model.prototype={dispose:function Model$dispose(){for(var key in this._types){delete window[key];}},addType:function Model$addType(name,base,origin){var type=new Type(this,name,base,origin);this._types[name]=type;return type;},beginValidation:function Model$beginValidation(){this._validatingQueue.startQueueing();this._validatedQueue.startQueueing();},endValidation:function Model$endValidation(){this._validatingQueue.stopQueueing();this._validatedQueue.stopQueueing();},get_types:function(){return Array.prototype.slice.call(this._types);},type:function(name){return this._types[name];},addBeforeContextReady:function(handler){if(!this._contextReady){this._addEvent("beforeContextReady",handler);}
else{handler();}},notifyBeforeContextReady:function(){this._contextReady=true;this._raiseEvent("beforeContextReady",[]);},addAfterPropertySet:function(handler){this._addEvent("afterPropertySet",handler);},notifyAfterPropertySet:function(obj,property,newVal,oldVal){this._raiseEvent("afterPropertySet",[obj,property,newVal,oldVal]);},addObjectRegistered:function(func,objectOrFunction,once){this._addEvent("objectRegistered",func,objectOrFunction?(objectOrFunction instanceof Function?objectOrFunction:equals(objectOrFunction)):null,once);},removeObjectRegistered:function(func){this._removeEvent("objectRegistered",func);},notifyObjectRegistered:function(obj){this._raiseEvent("objectRegistered",[obj]);},addObjectUnregistered:function(func){this._addEvent("objectUnregistered",func);},notifyObjectUnregistered:function(obj){this._raiseEvent("objectUnregistered",[obj]);},addListChanged:function(func){this._addEvent("listChanged",func);},notifyListChanged:function(obj,property,changes){this._raiseEvent("listChanged",[obj,property,changes]);},_ensureNamespace:function Model$_ensureNamespace(name,parentNamespace){var target=parentNamespace;if(target.constructor===String){var nsTokens=target.split(".");target=window;Array.forEach(nsTokens,function(token){target=target[token];if(target===undefined){ExoWeb.trace.throwAndLog("model","Parent namespace \"{0}\" could not be found.",parentNamespace);}});}
else if(target===undefined||target===null){target=window;}
if(!(name in target)){var result=target[name]={};return result;}
else{return target[name];}}};Model.mixin(ExoWeb.Functor.eventing);Model.getJsType=function Model$getJsType(name,allowUndefined){var obj=window;var steps=name.split(".");for(var i=0;i<steps.length;i++){var step=steps[i];obj=obj[step];if(obj===undefined){if(allowUndefined){return;}
else{throw Error($format("The type \"{0}\" could not be found.  Failed on step \"{1}\".",[name,step]));}}}
return obj;};ExoWeb.Model.Model=Model;function Entity(){}
function forEachProperty(obj,callback,thisPtr){for(var prop in obj){callback.call(thisPtr||this,prop,obj[prop]);}}
function getProperties(){if(arguments.length===2){var properties={};properties[arguments[0]]=arguments[1];return properties;}
else{return arguments[0];}}
Entity.mixin({init:function Entity$init(){forEachProperty(getProperties.apply(this,arguments),function(name,value){var prop=this.meta.type.property(name,true);if(!prop){ExoWeb.trace.throwAndLog("propInit","Could not find property \"{0}\" on type \"{1}\".",[name,this.meta.type.get_fullName()]);}
prop.init(this,value);},this);},set:function Entity$set(){forEachProperty(getProperties.apply(this,arguments),function(name,value){this._accessor("set",name).call(this,value);},this);},get:function Entity$get(propName){return this._accessor("get",propName).call(this);},_accessor:function Entity$_accessor(getOrSet,property){var fn=this[getOrSet+"_"+property];if(!fn){ExoWeb.trace.throwAndLog("model","Unknown property: {0}.{1}",[this.meta.type.get_fullName(),property]);}
return fn;},toString:function Entity$toString(formatName){var format;if(formatName){format=this.constructor.formats[formatName];if(!format){ExoWeb.trace.throwAndLog(["formatting"],"Invalid format: {0}",arguments);}}
else{format=this.constructor.formats.$display||this.constructor.formats.$system;}
return format.convert(this);}});Entity.formats={$system:new Format({undefinedString:"",nullString:"",convert:function(obj){return obj.meta.type.toIdString(obj.meta.id);},convertBack:function(str){var ids=str.split("|");var jstype=Model.getJsType(ids[0]);if(jstype&&jstype.meta){return jstype.meta.get(ids[1]);}}}),$display:new Format({convert:function(obj){if(obj.get_Label)
return obj.get_Label();if(obj.get_Name)
return obj.get_Name();if(obj.get_Text)
return obj.get_Text();return $format("{0}|{1}",[obj.meta.type.get_fullName(),obj.meta.id]);}})};ExoWeb.Model.Entity=Entity;Entity.registerClass("ExoWeb.Model.Entity");function Type(model,name,baseType,origin){this._rules={};this._fullName=name;this._origin=origin||"client";this._originForNewProperties=this._origin;this._pool={};this._legacyPool={};this._counter=0;this._properties={};this._instanceProperties={};this._staticProperties={};this._model=model;this._initNewProps=[];this._initExistingProps=[];var jstype=Model.getJsType(name,true);if(jstype){ExoWeb.trace.throwAndLog(["model"],"'{1}' has already been declared",arguments);}
var nameTokens=name.split("."),token=Array.dequeue(nameTokens),namespaceObj=window;while(nameTokens.length>0){namespaceObj=model._ensureNamespace(token,namespaceObj);token=Array.dequeue(nameTokens);}
var finalName=token;jstype=generateClass(this);this._jstype=namespaceObj[finalName]=jstype;this.derivedTypes=[];var baseJsType;if(baseType){baseJsType=baseType._jstype;this.baseType=baseType;baseType.derivedTypes.push(this);inheritBaseTypePropShortcuts(jstype,baseType);}
else{baseJsType=Entity;this.baseType=null;}
disableConstruction=true;this._jstype.prototype=new baseJsType();disableConstruction=false;this._jstype.prototype.constructor=this._jstype;var formats=function(){};formats.prototype=baseJsType.formats;this._jstype.formats=new formats();jstype.meta=this;this._jstype.registerClass(name,baseJsType);}
function inheritBaseTypePropShortcuts(jstype,baseType){for(var propName in baseType._properties){jstype["$"+propName]=baseType._properties[propName];}
if(baseType.baseType){inheritBaseTypePropShortcuts(jstype,baseType.baseType);}}
var disableConstruction=false;var validateId=function Type$validateId(type,id){if(id===null||id===undefined){ExoWeb.trace.throwAndLog("model","Id cannot be {0} (entity = {1}).",[id===null?"null":"undefined",type.get_fullName()]);}
else if(id.constructor!==String){ExoWeb.trace.throwAndLog("model","Id must be a string:  encountered id {0} of type \"{1}\" (entity = {2}).",[id.toString(),ExoWeb.parseFunctionName(id.constructor),type.get_fullName()]);}
else if(id===""){ExoWeb.trace.throwAndLog("model","Id cannot be a blank string (entity = {0}).",[type.get_fullName()]);}};function generateClass(type)
{function construct(idOrProps,props){if(!disableConstruction){if(idOrProps&&idOrProps.constructor===String){var id=idOrProps;var obj=type.get(id);if(obj){if(props){obj.init(props);}
return obj;}
type.register(this,id);type._initProperties(this,"_initExistingProps");if(props){this.init(props);}}
else{type.register(this);type._initProperties(this,"_initNewProps");if(idOrProps){this.set(idOrProps);}}}}
return construct;}
Type.prototype={toIdString:function Type$toIdString(id){if(id){return $format("{0}|{1}",[this.get_fullName(),id]);}},newId:function Type$newId(){for(var nextId,type=this;type;type=type.baseType){nextId=Math.max(nextId||0,type._counter);}
for(var type=this;type;type=type.baseType){type._counter=nextId+1;}
return"+c"+nextId;},register:function Type$register(obj,id){if(arguments.length===2){validateId(this,id);}
obj.meta=new ObjectMeta(this,obj);if(!id){id=this.newId();obj.meta.isNew=true;}
var key=id.toLowerCase();obj.meta.id=id;Sys.Observer.makeObservable(obj);for(var t=this;t;t=t.baseType){if(t._pool.hasOwnProperty(key)){ExoWeb.trace.throwAndLog("model","Object \"{0}|{1}\" has already been registered.",[this.get_fullName(),id]);}
t._pool[key]=obj;if(t._known){t._known.add(obj);}}
this._model.notifyObjectRegistered(obj);},changeObjectId:function Type$changeObjectId(oldId,newId){validateId(this,oldId);validateId(this,newId);var oldKey=oldId.toLowerCase();var newKey=newId.toLowerCase();var obj=this._pool[oldKey];if(obj){for(var t=this;t;t=t.baseType){t._pool[newKey]=obj;delete t._pool[oldKey];t._legacyPool[oldKey]=obj;}
obj.meta.id=newId;return obj;}
else{ExoWeb.trace.logWarning("model","Attempting to change id: Instance of type \"{0}\" with id = \"{1}\" could not be found.",[this.get_fullName(),oldId]);}},unregister:function Type$unregister(obj){this._model.notifyObjectUnregistered(obj);for(var t=this;t;t=t.baseType){delete t._pool[obj.meta.id.toLowerCase()];if(t._known){t._known.remove(obj);}}
delete obj.meta._obj;delete obj.meta;},get:function Type$get(id){validateId(this,id);var key=id.toLowerCase();return this._pool[key]||this._legacyPool[key];},known:function Type$known(){var list=this._known;if(!list){list=this._known=[];for(var id in this._pool){list.push(this._pool[id]);}
Sys.Observer.makeObservable(list);}
return list;},addProperty:function Type$addProperty(def){var format=def.format;if(format&&format.constructor===String){format=def.type.formats[format];if(!format){ExoWeb.trace.throwAndLog("model","Cannot create property {0}.{1} because there is not a '{2}' format defined for {3}",[this._fullName,def.name,def.format,def.type]);}}
var prop=new Property(this,def.name,def.type,def.isList,def.label,format,def.isStatic,def.index);this._properties[def.name]=prop;(def.isStatic?this._staticProperties:this._instanceProperties)[def.name]=prop;function genPropertyShortcut(mtype,overwrite){var shortcutName="$"+def.name;if(!(shortcutName in mtype._jstype)||overwrite){mtype._jstype[shortcutName]=prop;}
mtype.derivedTypes.forEach(function(t){genPropertyShortcut(t,false);});}
genPropertyShortcut(this,true);if(!prop.get_isStatic()){if(prop.get_isList()){this._initNewProps.push({property:prop,valueFn:function(){return[];}});if(prop.get_origin()!=="server"){this._initExistingProps.push({property:prop,valueFn:function(){return[];}});Array.forEach(this.known(),function(obj){prop.init(obj,[]);});}}
else if(prop.get_origin()==="server"){this._initNewProps.push({property:prop,valueFn:function(){return undefined;}});}}
else if(prop.get_isList()&&prop.get_origin()==="client"){prop.init(null,[]);}
if(prop.get_isStatic()){this._jstype["get_"+def.name]=this._makeGetter(prop,prop._getter,true);}
else{this._jstype.prototype["get_"+def.name]=this._makeGetter(prop,prop._getter,true);}
if(!prop.get_isList()){if(prop.get_isStatic()){this._jstype["set_"+def.name]=this._makeSetter(prop);}
else{this._jstype.prototype["set_"+def.name]=this._makeSetter(prop);}}
return prop;},addMethod:function Type$addMethod(def){this._jstype.prototype[def.name]=function()
{var onSuccess;var onFail;var paths=null;if(arguments.length>1)
{onSuccess=arguments[arguments.length-2];if(onSuccess instanceof Function){onFail=arguments[arguments.length-1];}
else{onSuccess=arguments[arguments.length-1];}}
else if(arguments.length>0)
onSuccess=arguments[arguments.length-1];if(!onSuccess instanceof Function)
onSuccess=undefined;var argCount=arguments.length-(onSuccess===undefined?0:1)-(onFail===undefined?0:1);var firstArgCouldBeParameterSet=argCount>0&&arguments[0]instanceof Object&&!(def.parameters.length==0||arguments[0][def.parameters[0]]===undefined);if(argCount>=1&&argCount<=2&&arguments[0]instanceof Object&&((argCount==1&&(def.parameters.length!=1||firstArgCouldBeParameterSet))||((argCount==2&&(def.parameters.length!=2||(firstArgCouldBeParameterSet&&arguments[1]instanceof Array))))))
{context.server.raiseServerEvent(def.name,this,arguments[0],false,function(result){onSuccess(result.event);},onFail,argCount==2?arguments[1]:null);}
else{if(def.parameters.length==argCount-1&&arguments[argCount-1]instanceof Array)
paths=arguments[argCount-1];else if(def.parameters.length!=argCount)
ExoWeb.trace.throwAndLog("type","Invalid number of arguments passed to \"{0}.{1}\" method.",[this._fullName,def.name]);var args={};for(var parameter in def.parameters)
args[def.parameters[parameter]]=arguments[parameter];context.server.raiseServerEvent(def.name,this,args,false,function(result){onSuccess(result.event);},onFail,paths);}};},_makeGetter:function Type$_makeGetter(receiver,fn,skipTypeCheck){return function(){return fn.call(receiver,this,skipTypeCheck);};},_makeSetter:function Type$_makeSetter(prop){var setter=function(val){if(prop.isInited(this))
prop._setter(this,val,true);else
prop.init(this,val);};setter.__notifies=true;return setter;},_initProperties:function Type$_initProperties(obj,initsArrayName){for(var t=this;t!==null;t=t.baseType){var inits=t[initsArrayName];for(var i=0;i<inits.length;++i){var init=inits[i];init.property.init(obj,init.valueFn());}}},get_model:function Type$get_model(){return this._model;},get_fullName:function Type$get_fullName(){return this._fullName;},get_jstype:function Type$get_jstype(){return this._jstype;},get_properties:function Type$get_properties(){return ExoWeb.objectToArray(this._properties);},get_staticProperties:function Type$get_staticProperties(){return this._staticProperties;},get_instanceProperties:function Type$get_instanceProperties(){return this._instanceProperties;},property:function Type$property(name,thisOnly){if(!thisOnly){return new PropertyChain(this,new PathTokens(name));}
var prop;for(var t=this;t&&!prop;t=t.baseType){prop=t._properties[name];if(prop){return prop;}}
return null;},addRule:function Type$addRule(rule){function Type$addRule$init(sender,args){if(!args.wasInited&&(rule.canExecute?rule.canExecute(sender,args.property):Rule.canExecute(rule,sender,args.property))){Type$addRule$fn(sender,args.property,rule.execute);}}
function Type$addRule$changed(sender,args){if(args.wasInited&&(rule.canExecute?rule.canExecute(sender,args.property):Rule.canExecute(rule,sender,args.property))){Type$addRule$fn(sender,args.property,rule.execute);}}
function Type$addRule$get(sender,args){try{if(!args.isInited){Type$addRule$fn(sender,args.property,rule.execute);}}
catch(e){ExoWeb.trace.log("model",e);}}
function Type$addRule$fn(obj,prop,fn){try{prop.get_containingType().get_model().beginValidation();rule._isExecuting=true;ExoWeb.trace.log("rule","executing rule '{0}' that depends on property '{1}'",[rule,prop]);if(prop.get_isStatic()===true){Array.forEach(jstype.meta.known(),function(obj){if(rule.inputs.every(function(input){return!input.get_dependsOnInit()||input.property.isInited(obj);})){fn.call(rule,obj);}});}
else{fn.call(rule,obj);}}
catch(err){ExoWeb.trace.throwAndLog("rules","Error running rule '{0}': {1}",[rule,err]);}
finally{rule._isExecuting=false;prop.get_containingType().get_model().endValidation();}}
var jstype=this.get_jstype();for(var i=0;i<rule.inputs.length;++i){var input=rule.inputs[i];var prop=input.property;var isSameType=this===prop.get_containingType();if(input.get_dependsOnChange()){prop.addChanged(isSameType?Type$addRule$changed:function(sender,args){if(sender instanceof jstype){Type$addRule$changed.apply(this,arguments);}});}
if(input.get_dependsOnInit()){prop.addChanged(isSameType?Type$addRule$init:function(sender,args){if(sender instanceof jstype){Type$addRule$init.apply(this,arguments);}});}
if(input.get_dependsOnGet()){prop.addGet(isSameType?Type$addRule$get:function(obj,prop,value,isInited){if(obj instanceof jstype){Type$addRule$get.apply(this,arguments);}});}
(prop instanceof PropertyChain?prop.lastProperty():prop)._addRule(rule,input.get_isTarget());}},executeRules:function Type$executeRules(obj,prop,callback,start){var processing;if(start===undefined){this._model.beginValidation();}
try{var i=(start?start:0);var rules=prop.get_rules(true);if(rules){processing=(i<rules.length);while(processing){var rule=rules[i];if(!rule._isExecuting&&(rule.canExecute?rule.canExecute(obj):Rule.canExecute(rule,obj))){rule._isExecuting=true;if(rule.isAsync){var _this=this;rule.execute(obj,function(){rule._isExecuting=false;_this.executeRules(obj,prop,callback,i+1);});break;}
else{try{rule.execute(obj);}
finally{rule._isExecuting=false;}}}
++i;processing=(i<rules.length);}}}
finally{if(!processing){this._model.endValidation();}}
if(!processing&&callback&&callback instanceof Function){callback();}
return!processing;},set_originForNewProperties:function Type$set_originForNewProperties(value){this._originForNewProperties=value;},get_originForNewProperties:function Type$get_originForNewProperties(){return this._originForNewProperties;},set_origin:function Type$set_origin(value){this._origin=value;},get_origin:function Type$get_origin(){return this._origin;},eachBaseType:function Type$eachBaseType(callback,thisPtr){for(var baseType=this.baseType;!!baseType;baseType=baseType.baseType){if(callback.call(thisPtr||this,baseType)===false){return;}}},isSubclassOf:function Type$isSubclassOf(mtype){var result=false;this.eachBaseType(function(baseType){if(baseType===mtype){result=true;return false;}});return result;},toString:function Type$toString(){return this.get_fullName();}};Type.mixin(ExoWeb.Functor.eventing);ExoWeb.Model.Type=Type;Type.registerClass("ExoWeb.Model.Type");function Property(containingType,name,jstype,isList,label,format,isStatic,index){this._containingType=containingType;this._name=name;this._fieldName="_"+name;this._jstype=jstype;this._label=label||ExoWeb.makeHumanReadable(name);this._format=format;this._isList=!!isList;this._isStatic=!!isStatic;this._index=index;this._rules=[];if(containingType.get_originForNewProperties()){this._origin=containingType.get_originForNewProperties();}}
Property.mixin({defaultValue:function Property$defaultValue(value){function getValue(){return value;}
this._containingType._initNewProps.push({property:this,valueFn:getValue});this._containingType._initExistingProps.push({property:this,valueFn:getValue});Array.forEach(this._containingType.known(),function(obj){if(!this.isInited(obj)){this.init(obj,value);}},this);return this;},equals:function Property$equals(prop){if(prop!==undefined&&prop!==null){if(prop instanceof Property){return this===prop;}
else if(prop instanceof PropertyChain){var props=prop.all();return props.length===1&&this.equals(props[0]);}}},rule:function(type,onlyTargets){if(!type||!(type instanceof Function)){ExoWeb.trace.throwAndLog("rule","{0} is not a valid rule type.",[type?type:(type===undefined?"undefined":"null")]);}
var rule=first(this._rules,function(rule){if(rule.value instanceof type)
if(!onlyTargets||rule.isTarget===true)
return true;});return rule?rule.value:null;},isDefinedBy:function Property$isDefinedBy(mtype){return this._containingType===mtype||mtype.isSubclassOf(this._containingType);},_addRule:function Property$_addRule(rule,isTarget){this._rules.push({value:rule,isTarget:isTarget});},get_rules:function Property$get_rules(onlyTargets){return this._rules.filter(function(r){return!onlyTargets||r.isTarget===true;}).map(function(r){return r.value;});},toString:function Property$toString(){if(this._isStatic){return this.get_path();}
else{return $format("this<{0}>.{1}",[this.get_containingType(),this.get_name()]);}},get_containingType:function Property$get_containingType(){return this._containingType;},get_jstype:function Property$get_jstype(){return this._jstype;},get_index:function Property$get_index(){return this._index;},get_format:function Property$get_format(){return this._format;},format:function(val){return this.get_format()?this.get_format().convert(val):val;},get_origin:function Property$get_origin(){return this._origin?this._origin:this._containingType.get_origin();},_assertType:function Property$_assertType(obj){if(this._isStatic===true){if(!ExoWeb.isType(obj.meta,Type)){ExoWeb.trace.throwAndLog(["model","entity"],"A model type was expected, found \"{0}\".",[ExoWeb.parseFunctionName(obj.constructor)]);}
if(!this.isDefinedBy(obj.meta)){ExoWeb.trace.throwAndLog(["model","entity"],"Type {0} does not define static property {1}.{2}.",[obj.get_fullName(),this._containingType.get_fullName(),this.get_label()]);}}
else{if(!ExoWeb.isType(obj,Entity)){ExoWeb.trace.throwAndLog(["model","entity"],"An entity was expected, found \"{0}\".",[ExoWeb.parseFunctionName(obj.constructor)]);}
if(!this.isDefinedBy(obj.meta.type)){ExoWeb.trace.throwAndLog(["model","entity"],"Type {0} does not define non-static property {1}.{2}.",[obj.meta.type.get_fullName(),this._containingType.get_fullName(),this.get_label()]);}}},_getter:function Property$_getter(obj,skipTypeCheck){var handler=this._getEventHandler("get");if(handler)
handler(obj,{property:this,value:obj[this._fieldName],isInited:obj.hasOwnProperty(this._fieldName)});return obj[this._fieldName];},_setter:function Property$_setter(obj,val,skipTypeCheck,args){if(!this.canSetValue(obj,val)){ExoWeb.trace.throwAndLog(["model","entity"],"Cannot set {0}={1}. A value of type {2} was expected",[this._name,val===undefined?"<undefined>":val,this._jstype.getName()]);}
var old=obj[this._fieldName];var oldValue=(old===undefined||old===null)?old:old.valueOf();var newValue=(val===undefined||val===null)?val:val.valueOf();if(oldValue!==newValue){var wasInited=this.isInited(obj);obj[this._fieldName]=val;this._containingType.get_model().notifyAfterPropertySet(obj,this,val,old,wasInited);var handler=this._getEventHandler("changed");if(handler)
handler(obj,$.extend({property:this,newValue:val,oldValue:old,wasInited:wasInited},args));Sys.Observer.raisePropertyChanged(obj,this._name);}},get_isEntityType:function Property$get_isEntityType(){return!!this.get_jstype().meta&&!this._isList;},get_isEntityListType:function Property$get_isEntityListType(){return!!this.get_jstype().meta&&this._isList;},get_isValueType:function Property$get_isValueType(){return!this.get_jstype().meta;},get_isList:function Property$get_isList(){return this._isList;},get_isStatic:function Property$get_isStatic(){return this._isStatic;},get_label:function Property$get_label(){return this._label;},get_name:function Property$get_name(){return this._name;},get_path:function Property$get_path(){return this._isStatic?(this._containingType.get_fullName()+"."+this._name):this._name;},canSetValue:function Property$canSetValue(obj,val){if(val===null||val===undefined){return true;}
if(val.constructor){if(val.constructor.meta){for(var valType=val.constructor.meta;valType;valType=valType.baseType){if(valType._jstype===this._jstype){return true;}}
return false;}
else{return val.constructor===this._jstype;}}
else{var valObjectType;switch(typeof(val)){case"string":valObjectType=String;break;case"number":valObjectType=Number;break;case"boolean":valObjectType=Boolean;break;}
return valObjectType===this._jstype;}},value:function Property$value(obj,val,args){var target=(this._isStatic?this._containingType.get_jstype():obj);if(target===undefined||target===null){ExoWeb.trace.throwAndLog(["model"],"Cannot {0} value for {1}static property \"{2}\" on type \"{3}\": target is null or undefined.",[(arguments.length>1?"set":"get"),(this._isStatic?"":"non-"),this.get_path(),this._containingType.get_fullName()]);}
if(arguments.length>1){if(this.isInited(target))
this._setter(target,val,false,args);else
this.init(target,val);}
else{return this._getter(target);}},init:function Property$init(obj,val,force){var target=(this._isStatic?this._containingType.get_jstype():obj);var curVal=target[this._fieldName];if(curVal!==undefined&&!(force===undefined||force)){return;}
target[this._fieldName]=val;if(val instanceof Array){var _this=this;Sys.Observer.makeObservable(val);Sys.Observer.addCollectionChanged(val,function Property$collectionChanged(sender,args){if(!LazyLoader.isLoaded(val)){ExoWeb.trace.logWarning("model","{0} list {1}.{2} was modified but it has not been loaded.",[_this._isStatic?"Static":"Non-static",_this._isStatic?_this._containingType.get_fullName():"this<"+_this._containingType.get_fullName()+">",_this._name]);}
_this._containingType.get_model().notifyListChanged(target,_this,args.get_changes());_this._raiseEvent("changed",[target,{property:_this,newValue:val,oldValue:undefined,changes:args.get_changes(),wasInited:true,collectionChanged:true}]);Sys.Observer.raisePropertyChanged(target,_this._name);});}
var handler=this._getEventHandler("changed");if(handler)
handler(target,{property:this,newValue:val,oldValue:undefined,wasInited:false});Sys.Observer.raisePropertyChanged(target,this._name);return this;},isInited:function Property$isInited(obj){var target=(this._isStatic?this._containingType.get_jstype():obj);return target.hasOwnProperty(this._fieldName);},addGet:function Property$addGet(handler,obj){var f;if(obj){f=function(target,property,value,isInited){if(obj===target){handler(target,property,value,isInited);}};}
else{f=handler;}
this._addEvent("get",f);return this;},addChanged:function Property$addChanged(handler,obj,once){this._addEvent("changed",handler,obj?equals(obj):null,once);return this;},removeChanged:function Property$removeChanged(handler){this._removeEvent("changed",handler);},_addCalculatedRule:function Property$_addCalculatedRule(rootType,calculateFn,isAsync,inputs){var input=new RuleInput(this);input.set_dependsOnGet(true);input.set_dependsOnChange(false);input.set_isTarget(true);inputs.push(input);var rule={prop:this,canExecute:function(sender,property){return(property||this.inputs.filter(function(input){return input.get_dependsOnInit();}).length>0)&&(!sender||Rule.canExecute(this,sender,property||input.property));},execute:function Property$calculated$execute(obj,callback){var signal=new ExoWeb.Signal("calculated rule");var prop=this.prop;if(prop._isList){if(!prop.isInited(obj)){prop.init(obj,[]);}
var newList;if(isAsync){calculateFn.call(obj,signal.pending(function(result){newList=result;}));}
else{newList=calculateFn.apply(obj);}
signal.waitForAll(function(){var curList=prop.value(obj);if(newList.length===curList.length){var noChanges=true;for(var i=0;i<newList.length;++i){if(newList[i]!==curList[i]){noChanges=false;break;}}
if(noChanges){return;}}
curList.beginUpdate();curList.clear();curList.addRange(newList);curList.endUpdate();if(callback){callback(obj);}},null,!isAsync);}
else{var newValue;if(isAsync){calculateFn.call(obj,signal.pending(function(result){newValue=result;}));}
else{newValue=calculateFn.apply(obj);}
signal.waitForAll(function(){prop.value(obj,newValue,{calculated:true});if(callback){callback(obj);}},null,!isAsync);}},toString:function(){return"calculation of "+this.prop._name;}};Rule.register(rule,inputs,isAsync,rootType,function(){if(rule.canExecute()){rootType.known().forEach(function(obj){if(rule.canExecute(obj)){try{rule._isExecuting=true;rule.execute.call(rule,obj);}
catch(err){ExoWeb.trace.throwAndLog("rules","Error running rule '{0}': {1}",[rule,err]);}
finally{rule._isExecuting=false;}}});}},this);},calculated:function Property$calculated(options){var prop=this;var rootType=(options.rootType)?options.rootType.meta:prop._containingType;if(options.basedOn){this._readySignal=new ExoWeb.Signal("calculated property dependencies");var inputs=[];Array.forEach(options.basedOn,function(p,i){var dependsOnChange;var dependsOnInit=true;var parts=p.split(" of ");if(parts.length>=2){var events=parts[0].split(",");dependsOnInit=(events.indexOf("init")>=0);dependsOnChange=(events.indexOf("change")>=0);}
var path=(parts.length>=2)?parts[1]:p;Model.property(path,rootType,true,prop._readySignal.pending(function Property$calculated$chainLoaded(chain){var input=new RuleInput(chain);if(!input.property){ExoWeb.trace.throwAndLog("model","Calculated property {0}.{1} is based on an invalid property: {2}",[rootType.get_fullName(),prop._name,p]);}
input.set_dependsOnInit(dependsOnInit);if(dependsOnChange!==undefined){input.set_dependsOnChange(dependsOnChange);}
inputs.push(input);}));});this._readySignal.waitForAll(function(){ExoWeb.Batch.whenDone(function(){prop._addCalculatedRule(rootType,options.fn,options.isAsync,inputs);});});}
else{var inferredInputs=Rule.inferInputs(rootType,options.fn);inferredInputs.forEach(function(input){input.set_dependsOnInit(true);});prop._addCalculatedRule(rootType,options.fn,options.isAsync,inferredInputs);}
return this;},ifExists:function(path){Model.property(path,this._containingType,true,function(chain){this.calculated({basedOn:[path],fn:function(){return!isNullOrUndefined(chain.value(this));}});},this);return this;},alias:function(path,eventName){Model.property(path,this._containingType,true,function(chain){this.calculated({basedOn:[(eventName?eventName+" of ":"")+path],fn:function(){return chain.value(this);}});},this);return this;},rootedPath:function Property$rootedPath(type){if(this.isDefinedBy(type)){return(this._isStatic?this._containingType.get_fullName():"this")+"."+this._name;}},label:function(label){this._label=label;return this;},required:function(conditionType){new ExoWeb.Model.Rule.required(this._containingType,{property:this._name},conditionType);return this;},allowedValues:function(source,conditionType){new ExoWeb.Model.Rule.allowedValues(this._containingType,{property:this._name,source:source},conditionType);return this;},compare:function(operator,source,conditionType){new ExoWeb.Model.Rule.compare(this._containingType,{property:this._name,compareOperator:operator,compareSource:source},conditionType);return this;},range:function(min,max,conditionType){new ExoWeb.Model.Rule.range(this._containingType,{property:this._name,min:min,max:max},conditionType);return this;},requiredIf:function(source,operator,value,conditionType){if(typeof(source)==="string"){new ExoWeb.Model.Rule.requiredIf(this._containingType,{property:this._name,compareSource:source,compareOperator:operator,compareValue:value},conditionType);}
else{new ExoWeb.Model.Rule.requiredIfExpressions(this._containingType,{property:this._name,fn:source.fn,dependsOn:source.dependsOn},conditionType);}
return this;},requiredIfExpressions:function(options,conditionType){new ExoWeb.Model.Rule.requiredIfExpressions(this._containingType,{property:this._name,fn:options.fn,dependsOn:options.dependsOn},conditionType);return this;},errorIfExpressions:function(options,conditionType){new ExoWeb.Model.Rule.errorIfExpressions(this._containingType,{property:this._name,fn:options.fn,dependsOn:options.dependsOn,errorMessage:options.errorMessage,isWarning:options.isWarning},conditionType);return this;},stringLength:function(min,max,conditionType){new ExoWeb.Model.Rule.stringLength(this._containingType,{property:this._name,min:min,max:max},conditionType);return this;}});Property.mixin(ExoWeb.Functor.eventing);ExoWeb.Model.Property=Property;Property.registerClass("ExoWeb.Model.Property");function PathTokens(expression){this.expression=expression;expression=expression.replace(/<[^>]*>/ig,function(e){return e.replace(/\./ig,function(){return"$_$";});});if(expression.length>0){this.steps=expression.split(".").map(function(step){var parsed=step.match(/^([a-z0-9_]+)(<([a-z0-9_$]+)>)?$/i);if(!parsed){return null;}
var result={property:parsed[1]};if(parsed[3]){result.cast=parsed[3].replace(/\$_\$/ig,function(){return".";});}
return result;});}
else{this.steps=[];}}
PathTokens.normalizePaths=function PathTokens$normalizePaths(paths){var result=[];if(paths){paths.forEach(function(p){var stack=[];var parent;var start=0;var pLen=p.length;for(var i=0;i<pLen;++i){var c=p.charAt(i);if(c==='{'||c===','||c==='}'){var seg=p.substring(start,i).trim();start=i+1;if(c==='{'){if(parent){stack.push(parent);parent+="."+seg;}
else{parent=seg;}}
else{if(seg.length>0){result.push(new PathTokens(parent?parent+"."+seg:seg));}
if(c==='}'){parent=(stack.length===0)?undefined:stack.pop();}}}}
if(stack.length>0){ExoWeb.trace.throwAndLog("model","Unclosed '{' in path: {0}",[p]);}
if(start===0){result.push(new PathTokens(p.trim()));}});}
return result;};PathTokens.mixin({buildExpression:function PathTokens$buildExpression(){var path="";this.steps.forEach(function(step){path+=(path?".":"")+step.property+(step.cast?"<"+step.cast+">":"");});return path;},toString:function PathTokens$toString(){return this.expression;}});ExoWeb.Model.PathTokens=PathTokens;function PropertyChain(rootType,pathTokens){this._rootType=rootType;var type=rootType;var chain=this;this._properties=[];this._filters=[];var lazyLoadTypes=arguments.length>=3&&arguments[2]&&arguments[2].constructor===Boolean?arguments[2]:false;var callback=arguments.length>=4&&arguments[3]&&arguments[3]instanceof Function?arguments[3]:null;var allowAsync=!!(lazyLoadTypes&&callback);var processStep=function PropertyChain$processStep(){var step=Array.dequeue(pathTokens.steps);if(!step){ExoWeb.trace.throwAndLog("model","Syntax error in property path: {0}",[pathTokens.expression]);}
var prop=type.property(step.property,true);if(!prop){ExoWeb.trace.throwAndLog("model","Path '{0}' references an unknown property: {1}.{2}",[pathTokens.expression,type.get_fullName(),step.property]);}
chain._properties.push(prop);if(step.cast){type=type.get_model().type(step.cast);if(!type){ExoWeb.trace.throwAndLog("model","Path '{0}' references an unknown type: {1}",[pathTokens.expression,step.cast]);}
var jstype=type.get_jstype();chain._filters[chain._properties.length]=function(target){return target instanceof jstype;};}
else{type=prop.get_jstype().meta;}
if(pathTokens.steps.length===0){if(chain._properties.length===0){ExoWeb.trace.throwAndLog(["model"],"PropertyChain cannot be zero-length.");}
if(allowAsync){callback(chain);}}
else{if(allowAsync&&!LazyLoader.isLoaded(type)){LazyLoader.load(type,null,processStep);}
else{processStep();}}};if(!LazyLoader.isLoaded(type)){LazyLoader.load(type,null,processStep);}
else{processStep();}}
PropertyChain.prototype={equals:function PropertyChain$equals(prop){if(prop!==undefined&&prop!==null){if(prop instanceof Property){return prop.equals(this);}
else if(prop instanceof PropertyChain){if(prop._properties.length!==this._properties.length){return false;}
for(var i=0;i<this._properties.length;i++){if(!this._properties[i].equals(prop._properties[i])){return false;}}
return true;}}},all:function PropertyChain$all(){return this._properties;},append:function PropertyChain$append(prop){Array.addRange(this._properties,prop.all());},each:function PropertyChain$each(obj,callback,propFilter){if(!callback||typeof(callback)!="function"){ExoWeb.trace.throwAndLog(["model"],"Invalid Parameter: callback function");}
if(!obj){ExoWeb.trace.throwAndLog(["model"],"Invalid Parameter: source object");}
var target=arguments[3]||obj;var lastProp=arguments[5]||null;for(var p=arguments[4]||0;p<this._properties.length;p++){var prop=this._properties[p];var canSkipRemainingProps=propFilter&&lastProp===propFilter;var enableCallback=(!propFilter||lastProp===propFilter);if(target instanceof Array){for(var i=0;i<target.length;++i){if(!this._filters[p]||this._filters[p](target[i])){if(enableCallback&&callback(target[i],prop)===false){return false;}
if(!canSkipRemainingProps&&this.each(obj,callback,propFilter,target[i]["get_"+prop.get_name()](),p+1,prop)===false){return false;}}}
return true;}
else{if(this._filters[p]&&this._filters[p](target)===false){break;}
if(enableCallback&&callback(target,prop)===false){return false;}}
if(canSkipRemainingProps){break;}
target=target["get_"+prop.get_name()]();if(target===undefined||target===null){break;}
lastProp=prop;}
return true;},get_path:function PropertyChain$get_path(){if(!this._path){this._path=this._getPathFromIndex(0);}
return this._path;},_getPathFromIndex:function PropertyChain$_getPathFromIndex(startIndex){var parts=[];if(this._properties[startIndex].get_isStatic()){parts.push(this._properties[startIndex].get_containingType().get_fullName());}
this._properties.slice(startIndex).forEach(function(p){parts.push(p.get_name());});return parts.join(".");},firstProperty:function PropertyChain$firstProperty(){return this._properties[0];},lastProperty:function PropertyChain$lastProperty(){return this._properties[this._properties.length-1];},lastTarget:function PropertyChain$lastTarget(obj,exitEarly){for(var p=0;p<this._properties.length-1;p++){var prop=this._properties[p];if(exitEarly===true&&(obj===undefined||obj===null)){return;}
obj=prop.value(obj);}
return obj;},prepend:function PropertyChain$prepend(prop){var newProps=prop.all();for(var p=newProps.length-1;p>=0;p--){Array.insert(this._properties,0,newProps[p]);}},canSetValue:function PropertyChain$canSetValue(obj,value){return this.lastProperty().canSetValue(this.lastTarget(obj),value);},connects:function PropertyChain$connects(fromRoot,toObj,viaProperty){var connected=false;if(!viaProperty){return fromRoot===toObj;}
this.each(fromRoot,function(target){if(target===toObj){connected=true;return false;}},viaProperty);return connected;},rootedPath:function PropertyChain$rootedPath(rootType){for(var i=0;i<this._properties.length;i++){if(this._properties[i].isDefinedBy(rootType)){var path=this._getPathFromIndex(i);return(this._properties[i]._isStatic?this._properties[i].get_containingType().get_fullName():"this")+"."+path;}}},addGet:function PropertyChain$addGet(handler,obj){var chain=this;this.lastProperty().addGet(function PropertyChain$_raiseGet(sender,property,value,isInited){handler(sender,chain,value,isInited);},obj);return this;},addChanged:function PropertyChain$addChanged(handler,obj,once,tolerateNulls){var chain=this;function raiseHandler(sender,args){var newArgs=Object.copy(args);newArgs.triggeredBy=newArgs.property;newArgs.property=chain;handler(sender,newArgs);}
if(this._properties.length==1){this._properties[0].addChanged(raiseHandler,obj,once);}
else{Array.forEach(this._properties,function(prop,index){var priorProp=(index===0)?undefined:chain._properties[index-1];if(obj){prop.addChanged(function PropertyChain$_raiseChanged$1Obj(sender,args){if(chain.connects(obj,sender,priorProp)){args.originalSender=sender;raiseHandler(obj,args);}},null,once);}
else{prop.addChanged(function PropertyChain$_raiseChanged$Multi(sender,args){Array.forEach(chain._rootType.known(),function(known){if(chain.isInited(known,tolerateNulls)&&chain.connects(known,sender,priorProp)){args.originalSender=sender;raiseHandler(known,args);}});},null,once);}});}
return this;},get_containingType:function PropertyChain$get_containingType(){return this._rootType;},get_jstype:function PropertyChain$get_jstype(){return this.lastProperty().get_jstype();},get_format:function PropertyChain$get_format(){return this.lastProperty().get_format();},get_isList:function PropertyChain$get_isList(){return this.lastProperty().get_isList();},get_isStatic:function PropertyChain$get_isStatic(){return this.lastProperty().get_isStatic();},get_label:function PropertyChain$get_label(){return this.lastProperty().get_label();},get_name:function PropertyChain$get_name(){return this.lastProperty().get_name();},get_isValueType:function PropertyChain$get_isValueType(){return this.lastProperty().get_isValueType();},get_isEntityType:function PropertyChain$get_isEntityType(){return this.lastProperty().get_isEntityType();},get_isEntityListType:function PropertyChain$get_isEntityListType(){return this.lastProperty().get_isEntityListType();},get_rules:function PropertyChain$_get_rules(onlyTargets){return this.lastProperty().get_rules(onlyTargets);},value:function PropertyChain$value(obj,val,customInfo){var target=this.lastTarget(obj,true);var prop=this.lastProperty();if(arguments.length>1){prop.value(target,val,customInfo);}
else{return(target!==undefined&&target!==null)?prop.value(target):null;}},isInited:function PropertyChain$isInited(obj,tolerateNull){var allInited=true;var numProperties=0;var emptyList=false;this.each(obj,function(target,property){numProperties++;if(!property.isInited(target)){allInited=false;return false;}
else if(property.get_isList()===true){var value=property.value(target);if(value.length===0&&LazyLoader.isLoaded(value)){emptyList=true;return false;}}});if(numProperties<this._properties.length&&!tolerateNull&&!emptyList){allInited=false;}
else if(allInited){}
else{}
return allInited;},toString:function PropertyChain$toString(){if(this._isStatic){return this.get_path();}
else{var path=this._properties.map(function(e){return e.get_name();}).join(".");return $format("this<{0}>.{1}",[this.get_containingType(),path]);}}};ExoWeb.Model.PropertyChain=PropertyChain;PropertyChain.registerClass("ExoWeb.Model.PropertyChain");function ObjectMeta(type,obj){this._obj=obj;this.type=type;this._conditions=[];this._propertyConditions={};}
ObjectMeta.mixin({get_entity:function(){return this._obj;},executeRules:function ObjectMeta$executeRules(prop){this.type.get_model()._validatedQueue.push({sender:this,property:prop.get_name()});this._raisePropertyValidating(prop.get_name());this.type.executeRules(this._obj,prop);},property:function ObjectMeta$property(propName,thisOnly){return this.type.property(propName,thisOnly);},clearConditions:function ObjectMeta$clearConditions(origin){var conditions=this._conditions;for(var i=conditions.length-1;i>=0;--i){var condition=conditions[i];if(!origin||condition.get_origin()==origin){this._removeCondition(i);this._raisePropertiesValidated(condition.get_properties());}}},conditionIf:function ObjectMeta$conditionIf(condition,when){var idx=-1;for(var i=0;i<this._conditions.length;i++){if(this._conditions[i].get_type()===condition.get_type()){idx=i;break;}}
if(idx>=0){this._removeCondition(idx);}
if(when){this._addCondition(condition);}
if((idx<0&&when)||(idx>=0&&!when)){this._raisePropertiesValidated(condition.get_properties());}},_addCondition:function(condition){condition.get_targets().add(this);this._conditions.push(condition);var props=condition.get_properties();for(var i=0;i<props.length;++i){var propName=props[i].get_name();var pi=this._propertyConditions[propName];if(!pi){pi=[];this._propertyConditions[propName]=pi;}
pi.push(condition);}
this._raiseEvent("conditionsChanged",[this,{condition:condition,add:true,remove:false}]);},_removeCondition:function(idx){var condition=this._conditions[idx];condition.get_targets().remove(this);this._conditions.splice(idx,1);var props=condition.get_properties();for(var i=0;i<props.length;++i){var propName=props[i].get_name();var pi=this._propertyConditions[propName];var piIdx=$.inArray(condition,pi);pi.splice(piIdx,1);}
this._raiseEvent("conditionsChanged",[this,{condition:condition,add:false,remove:true}]);},_isAllowedOne:function ObjectMeta$_isAllowedOne(code){var conditionType=ConditionType.get(code);if(conditionType!==undefined){if(!(conditionType instanceof ConditionType.Permission)){ExoWeb.trace.throwAndLog(["conditions"],"Condition type \"{0}\" should be a Permission.",[code]);}
for(var i=0;i<this._conditions.length;i++){var condition=this._conditions[i];if(condition.get_type()==conditionType){return conditionType.get_isAllowed();}}
return!conditionType.get_isAllowed();}
return undefined;},isAllowed:function ObjectMeta$isAllowed(){if(arguments.length===0){return undefined;}
for(var i=0;i<arguments.length;i++){var allowed=this._isAllowedOne(arguments[i]);if(!allowed){return allowed;}}
return true;},conditions:function ObjectMeta$conditions(propOrOptions){if(!propOrOptions)return this._conditions;var options=(propOrOptions instanceof Property||propOrOptions instanceof PropertyChain)?{property:propOrOptions}:propOrOptions;return filter(this._conditions,function(condition){return(!options.property||condition.get_properties().some(function(p){return p.equals(options.property);}))&&(!options.set||condition.get_type().get_sets().indexOf(options.set)>=0)&&(!options.target||condition.get_targets().some(function(t){return t.get_entity()===options.target;}))&&(!options.type||condition.get_type()===options.type);});},_raisePropertiesValidated:function(properties){var queue=this.type.get_model()._validatedQueue;for(var i=0;i<properties.length;++i){queue.push({sender:this,property:properties[i].get_name()});}},addPropertyValidated:function(propName,handler){this._addEvent("propertyValidated:"+propName,handler);},_raisePropertyValidating:function(propName){var queue=this.type.get_model()._validatingQueue;queue.push({sender:this,propName:propName});},addPropertyValidating:function(propName,handler){this._addEvent("propertyValidating:"+propName,handler);},destroy:function(){this.type.unregister(this.obj);},addConditionsChanged:function ObjectMeta$addConditionsChanged(handler,obj){var filter;if(obj){if(obj.constructor===String)
obj=ConditionType.get(obj);if(!obj)
throw obj+" not found";filter=function(target,args){if(args.condition._type===obj){handler.apply(this,arguments);}};}
this._addEvent("conditionsChanged",handler,filter);;return this;},removeConditionsChanged:function ObjectMeta$removeConditionsChanged(handler){this._removeEvent("conditionsChanged",handler);}});ObjectMeta.mixin(ExoWeb.Functor.eventing);ExoWeb.Model.ObjectMeta=ObjectMeta;ObjectMeta.registerClass("ExoWeb.Model.ObjectMeta");function Rule(){}
Rule.register=function Rule$register(rule,inputs,isAsync,typeFilter,callback,thisPtr){rule.isAsync=!!isAsync;rule.inputs=inputs.map(function(item){if(item instanceof RuleInput){return item;}
else{var input=new RuleInput(item);if(item.get_origin()==="client")
input.set_dependsOnInit(true);input.set_isTarget(true);return input;}});if(arguments.length<4){typeFilter=rule.inputs[0].property.get_containingType();}
typeFilter.get_model().addBeforeContextReady(function(){typeFilter.addRule(rule);if(callback)
callback.apply(thisPtr||this);});};Rule.canExecute=function(rule,sender,property){return rule.inputs.every(function(input){return input.property===property||!input.get_dependsOnInit()||input.property.isInited(sender,true);});};Rule.ensureError=function Rule$ensureError(ruleName,prop){var generatedCode=$format("{0}.{1}.{2}",[prop.get_containingType().get_fullName(),prop.get_label(),ruleName]);var counter="";while(ConditionType.get(generatedCode+counter))
counter++;return new ConditionType.Error(generatedCode+counter,$format("Generated condition type for {0} rule.",[ruleName]));};Rule.ensureWarning=function Rule$ensureWarning(ruleName,prop,dependsOn){var generatedCode=$format("{0}.{1}.{2}",[prop.get_containingType().get_fullName(),prop.get_label(),ruleName]);var counter="";while(ConditionType.get(generatedCode+counter))
counter++;return new ConditionType.Warning(generatedCode+counter,$format("Generated condition type for {0} rule.",[ruleName]));};Rule.inferInputs=function Rule$inferInputs(rootType,func){var inputs=[];var expr=/this\.get_([a-zA-Z0-9_.]+)/g;var match=expr.exec(func.toString());while(match){inputs.push(new RuleInput(rootType.property(match[1]).lastProperty()));match=expr.exec(func.toString());}
return inputs;};ExoWeb.Model.Rule=Rule;Rule.registerClass("ExoWeb.Model.Rule");function RuleInput(property){this.property=property;}
RuleInput.prototype={set_dependsOnInit:function RuleInput$set_dependsOnInit(value){this._init=value;},get_dependsOnInit:function RuleInput$get_dependsOnInit(){return this._init===undefined?false:this._init;},set_dependsOnChange:function RuleInput$set_dependsOnChange(value){this._change=value;},get_dependsOnChange:function RuleInput$get_dependsOnChange(){return this._change===undefined?true:this._change;},set_dependsOnGet:function RuleInput$set_dependsOnGet(value){this._get=value;},get_dependsOnGet:function RuleInput$get_dependsOnGet(){return this._get===undefined?false:this._get;},get_isTarget:function RuleInput$get_isTarget(){return this._isTarget===undefined?false:this._isTarget;},set_isTarget:function RuleInput$set_isTarget(value){this._isTarget=value;}};ExoWeb.Model.RuleInput=RuleInput;RuleInput.registerClass("ExoWeb.Model.RuleInput");function RequiredRule(mtype,options,ctype){this.prop=mtype.property(options.property,true);if(!ctype){ctype=Rule.ensureError("required",this.prop);}
this.err=new Condition(ctype,this.prop.get_label()+" is required",[this.prop],this);Rule.register(this,[this.prop]);}
RequiredRule.hasValue=function RequiredRule$hasValue(obj,prop){var val=arguments.length===1?obj:prop.value(obj);if(val instanceof Array){return val.length>0;}
else if(val===undefined||val===null){return false;}
else if(val.constructor===String){return $.trim(val)!=="";}
else{return true;}};RequiredRule.prototype={execute:function(obj){obj.meta.conditionIf(this.err,!RequiredRule.hasValue(obj,this.prop));},toString:function(){return $format("{0}.{1} is required",[this.prop.get_containingType().get_fullName(),this.prop.get_name()]);}};Rule.required=RequiredRule;function RangeRule(mtype,options,ctype){this.prop=mtype.property(options.property,true);var properties=[this.prop];if(!ctype)
ctype=Rule.ensureError("range",this.prop);this.ctype=ctype;this.min=options.min;this.max=options.max;var hasMin=(this.min!==undefined&&this.min!==null);var hasMax=(this.max!==undefined&&this.max!==null);if(hasMin&&hasMax){this._formatString="{0} must be between {1} and {2}";this._formatArgs=function(){return[this.prop.format(this.min),this.prop.format(this.max)];};this._test=this._testMinMax;}
else if(hasMin){this._formatString="{0} must be at least {1}";this._formatArgs=function(){return[this.prop.format(this.min)];};this._test=this._testMin;}
else if(hasMax){this._formatString="{0} must be no more than {1}";this._formatArgs=function(){return[this.prop.format(this.max)];};this._test=this._testMax;}
Rule.register(this,properties);}
RangeRule.prototype={err:function(){return new Condition(this.ctype,$format(this._formatString,[this.prop.get_label()].concat(this._formatArgs.call(this))),[this.prop],this);},execute:function(obj){var val=this.prop.value(obj);obj.meta.conditionIf(this.err(),this._test(val));},_testMinMax:function(val){return val<this.min||val>this.max;},_testMin:function(val){return val<this.min;},_testMax:function(val){return val>this.max;},toString:function(){return $format("{0}.{1} in range, min: {2}, max: {3}",[this.prop.get_containingType().get_fullName(),this.prop.get_name(),this.min===undefined?"":this.min,this.max===undefined?"":this.max]);}};Rule.range=RangeRule;function AllowedValuesRule(mtype,options,ctype){this.prop=mtype.property(options.property,true);var properties=[this.prop];if(!ctype){ctype=Rule.ensureError("allowedValues",this.prop);}
this._allowedValuesPath=options.source;this._inited=false;this.err=new Condition(ctype,$format("{0} has an invalid value",[this.prop.get_label()]),properties,this);var register=(function AllowedValuesRule$register(type){AllowedValuesRule.load(this,type);}).bind(this);if(LazyLoader.isLoaded(this.prop.get_containingType())){register(this.prop.get_containingType().get_jstype());}
else{$extend(this.prop.get_containingType().get_fullName(),register);}}
AllowedValuesRule.load=function AllowedValuesRule$load(rule,loadedType){if(!loadedType.meta.baseType||LazyLoader.isLoaded(loadedType.meta.baseType)){var inputs=[];var targetInput=new RuleInput(rule.prop);targetInput.set_isTarget(true);if(rule.prop.get_origin()==="client")
targetInput.set_dependsOnInit(true);inputs.push(targetInput);Model.property(rule._allowedValuesPath,rule.prop.get_containingType(),true,function(chain){rule._allowedValuesProperty=chain;var allowedValuesInput=new RuleInput(rule._allowedValuesProperty);inputs.push(allowedValuesInput);Rule.register(rule,inputs);rule._inited=true;});}
else{$extend(loadedType.meta.baseType.get_fullName(),function(baseType){AllowedValuesRule.load(rule,baseType);});}};AllowedValuesRule.prototype={_enforceInited:function AllowedValues$_enforceInited(){if(this._inited!==true){ExoWeb.trace.logWarning("rule","AllowedValues rule on type \"{0}\" has not been initialized.",[this.prop.get_containingType().get_fullName()]);}
return this._inited;},addChanged:function AllowedValues$addChanged(handler,obj){this._allowedValuesProperty.addChanged(handler,obj);},execute:function AllowedValuesRule$execute(obj){if(this._enforceInited()===true){var val=this.prop.value(obj);var allowed=this.values(obj);if(allowed!==undefined&&LazyLoader.isLoaded(allowed)){obj.meta.conditionIf(this.err,!this.satisfies(obj,val));}}},satisfies:function AllowedValuesRule$satisfies(obj,value){this._enforceInited();if(value===undefined||value===null){return true;}
var allowed=this.values(obj);if(allowed===undefined||!LazyLoader.isLoaded(allowed)){return false;}
if(value instanceof Array){return value.every(function(item){return Array.contains(allowed,item);});}
else{return Array.contains(allowed,value);}},satisfiesAsync:function AllowedValuesRule$satisfiesAsync(obj,value,callback){this._enforceInited();this.valuesAsync(obj,false,function(allowed){if(value===undefined||value===null){callback(true);}
else if(allowed===undefined){callback(false);}
else if(value instanceof Array){callback(value.every(function(item){return Array.contains(allowed,item);}));}
else{callback(Array.contains(allowed,value));}});},values:function AllowedValuesRule$values(obj,exitEarly){if(this._enforceInited()&&this._allowedValuesProperty&&(this._allowedValuesProperty.get_isStatic()||this._allowedValuesProperty instanceof Property||this._allowedValuesProperty.lastTarget(obj,exitEarly))){var values=this._allowedValuesProperty.value(obj);return values;}},valuesAsync:function AllowedValuesRule$valuesAsync(obj,exitEarly,callback){if(this._enforceInited()){var values;if(this._allowedValuesProperty.get_isStatic()||this._allowedValuesProperty instanceof Property||this._allowedValuesProperty.lastTarget(obj,exitEarly)){values=this._allowedValuesProperty.value(obj);}
if(values!==undefined){LazyLoader.load(values,null,function(){callback(values);});}
else{callback(values);}}},toString:function AllowedValuesRule$toString(){return $format("{0}.{1} allowed values = {2}",[this.prop.get_containingType().get_fullName(),this.prop.get_name(),this._allowedValuesPath]);}};Rule.allowedValues=AllowedValuesRule;function CompareRule(mtype,options,ctype){this.prop=mtype.property(options.property,true);var properties=[this.prop];if(!ctype){ctype=Rule.ensureError($format("compare {0} {1}",[options.compareOperator,options.compareSource]),this.prop);}
this.ctype=ctype;this._comparePath=options.compareSource;this._compareOp=options.compareOperator;this._inited=false;var register=(function CompareRule$register(ctype){CompareRule.load(this,ctype);}).bind(this);if(LazyLoader.isLoaded(this.prop.get_containingType())){CompareRule.load(this,this.prop.get_containingType().get_jstype());}
else{$extend(this.prop.get_containingType().get_fullName(),register);}}
CompareRule.load=function CompareRule$load(rule,loadedType){if(!loadedType.meta.baseType||LazyLoader.isLoaded(loadedType.meta.baseType)){var inputs=[];var targetInput=new RuleInput(rule.prop);targetInput.set_isTarget(true);if(rule.prop.get_origin()==="client")
targetInput.set_dependsOnInit(true);inputs.push(targetInput);Model.property(rule._comparePath,rule.prop.get_containingType(),true,function(chain){rule._compareProperty=chain;var compareInput=new RuleInput(rule._compareProperty);inputs.push(compareInput);Rule.register(rule,inputs);rule._inited=true;if(chain.get_jstype()===Boolean&&rule._compareOp=="NotEqual"&&(rule._compareValue===undefined||rule._compareValue===null)){rule._compareOp="Equal";rule._compareValue=true;}});}
else{$extend(loadedType.meta.baseType.get_fullName(),function(baseType){CompareRule.load(rule,baseType);});}};CompareRule.compare=function CompareRule$compare(srcValue,cmpOp,cmpValue,defaultValue){if(cmpValue===undefined||cmpValue===null){switch(cmpOp){case"Equal":return!RequiredRule.hasValue(srcValue);case"NotEqual":return RequiredRule.hasValue(srcValue);}}
if(srcValue!==undefined&&srcValue!==null&&cmpValue!==undefined&&cmpValue!==null){switch(cmpOp){case"Equal":return srcValue==cmpValue;case"NotEqual":return srcValue!=cmpValue;case"GreaterThan":return srcValue>cmpValue;case"GreaterThanEqual":return srcValue>=cmpValue;case"LessThan":return srcValue<cmpValue;case"LessThanEqual":return srcValue<=cmpValue;}
return srcValue==cmpValue;}
return defaultValue;};CompareRule.prototype={satisfies:function Compare$satisfies(obj){if(!this._compareProperty){return true;}
var srcValue=this.prop.value(obj);var cmpValue=this._compareProperty.value(obj);return CompareRule.compare(srcValue,this._compareOp,cmpValue,true);},execute:function CompareRule$execute(obj){if(this._inited===true){var isValid=this.satisfies(obj);var message=isValid?'':$format("{0} must be {1}{2} {3}",[this.prop.get_label(),ExoWeb.makeHumanReadable(this._compareOp).toLowerCase(),(this._compareOp==="GreaterThan"||this._compareOp=="LessThan")?"":" to",this._compareProperty.get_label()]);this.err=new Condition(this.ctype,message,[this.prop],this);obj.meta.conditionIf(this.err,!isValid);}
else{ExoWeb.trace.logWarning("rule","Compare rule on type \"{0}\" has not been initialized.",[this.prop.get_containingType().get_fullName()]);}}};Rule.compare=CompareRule;function ErrorIfExpressionsRule(mtype,options,ctype){this.prop=mtype.property(options.property,true);var properties=[this.prop];this._evaluationFunction=options.fn;this._dependsOn=options.dependsOn;this._errorMessage=options.errorMessage;this._isWarning=options.isWarning;if(!ctype&&!this._isWarning){ctype=Rule.ensureError("errorIfExpressions",this.prop);}
else if(!ctype&&this._isWarning){ctype=Rule.ensureWarning("errorIfExpressions",this.prop);}
if(this._evaluationFunction===undefined||this._evaluationFunction===null||!(this._evaluationFunction instanceof Function)){ExoWeb.trace.logError("rule","Rule configuration error - {0}:  you must define an evaluation function.",[this._expressions]);return;}
if(this._dependsOn===undefined||this._dependsOn===null||!(this._dependsOn instanceof Array)){ExoWeb.trace.logError("rule","Rule configuration error - {0}:  you must setup dependencies for ErrorIfExpression",[this._expressions]);return;}
this._inited=false;this.err=new Condition(ctype,this._errorMessage,properties,this);var register=(function ErrorIfExpressionsRule$register(ctype){this.load(this,ctype);}).bind(this);if(LazyLoader.isLoaded(this.prop.get_containingType())){register(this.prop.get_containingType().get_jstype());}
else{$extend(this.prop.get_containingType().get_fullName(),register);}}
ErrorIfExpressionsRule.prototype={load:function ErrorIfExpressionsRule$load(rule,loadedType){if(!loadedType.meta.baseType||LazyLoader.isLoaded(loadedType.meta.baseType)){var inputs=[];var targetInput=new RuleInput(rule.prop);targetInput.set_isTarget(true);if(rule.prop.get_origin()==="client")
targetInput.set_dependsOnInit(true);inputs.push(targetInput);for(var i=0;i<rule._dependsOn.length;i++){Model.property(rule._dependsOn[i],rule.prop.get_containingType(),true,function(chain){rule._dependsOn[i]=chain;var watchPathInput=new RuleInput(rule._dependsOn[i]);inputs.push(watchPathInput);Rule.register(rule,inputs);rule._inited=true;});}}
else{$extend(loadedType.meta.baseType.get_fullName(),function(baseType){ErrorIfExpressionsRule.load(rule,baseType);});}},evaluate:function ErrorIfExpressionsRule$required(obj){return this._evaluationFunction.apply(obj,[obj["get_"+this.prop.get_name()]()]);},satisfies:function ErrorIfRule$satisfies(obj){return!this.evaluate(obj);},execute:function ErrorIfRule$execute(obj){if(this._inited===true){obj.meta.conditionIf(this.err,!this.satisfies(obj));}
else{ExoWeb.trace.logWarning("rule","ErrorIf rule on type \"{0}\" has not been initialized.",[this.prop.get_containingType().get_fullName()]);}}};Rule.errorIfExpressions=ErrorIfExpressionsRule;function RequiredIfRule(mtype,options,ctype){this.prop=mtype.property(options.property,true);var properties=[this.prop];if(!ctype){ctype=Rule.ensureError("requiredIf",this.prop);}
this._comparePath=options.compareSource;this._compareOp=options.compareOperator;this._compareValue=options.compareValue;if(this._compareOp===undefined||this._compareOp===null){if(this._compareValue!==undefined&&this._compareValue!==null){ExoWeb.trace.logWarning("rule","Possible rule configuration error - {0}:  if a compare value is specified, "+"then an operator should be specified as well.  Falling back to equality check.",[type.get_code()]);}
else{this._compareOp="NotEqual";}}
this._inited=false;this.err=new Condition(ctype,$format("{0} is required",[this.prop.get_label()]),properties,this);var register=(function RequiredIfRule$register(ctype){CompareRule.load(this,ctype);}).bind(this);if(LazyLoader.isLoaded(this.prop.get_containingType())){register(this.prop.get_containingType().get_jstype());}
else{$extend(this.prop.get_containingType().get_fullName(),register);}}
RequiredIfRule.prototype={required:function RequiredIfRule$required(obj){if(!this._compareProperty){ExoWeb.trace.logWarning("rule","Cannot determine requiredness since the property for path \"{0}\" has not been loaded.",[this._comparePath]);return;}
var cmpValue=this._compareProperty.value(obj);if(cmpValue&&cmpValue instanceof String){cmpValue=$.trim(cmpValue);}
return CompareRule.compare(cmpValue,this._compareOp,this._compareValue,false);},satisfies:function RequiredIfRule$satisfies(obj){return!this.required(obj)||RequiredRule.hasValue(obj,this.prop);},execute:function RequiredIfRule$execute(obj){if(this._inited===true){obj.meta.conditionIf(this.err,!this.satisfies(obj));}
else{ExoWeb.trace.logWarning("rule","RequiredIf rule on type \"{0}\" has not been initialized.",[this.prop.get_containingType().get_fullName()]);}}};Rule.requiredIf=RequiredIfRule;function RequiredIfExpressionsRule(mtype,options,ctype){this.prop=mtype.property(options.property,true);var properties=[this.prop];if(!ctype){ctype=Rule.ensureError("requiredIfExpressions",this.prop);}
this._evaluationFunction=options.fn;this._dependsOn=options.dependsOn;if(this._evaluationFunction===undefined||this._evaluationFunction===null||!(this._evaluationFunction instanceof Function)){ExoWeb.trace.logError("rule","Rule configuration error - {0}:  you must define an evaluation function.",[this._expressions]);return;}
if(this._dependsOn===undefined||this._dependsOn===null||!(this._dependsOn instanceof Array)){ExoWeb.trace.logError("rule","Rule configuration error - {0}:  you must setup depencies for RequiredIfExpression",[this._expressions]);return;}
this._inited=false;this.err=new Condition(ctype,$format("{0} is required",[this.prop.get_label()]),properties,this);var register=(function RequiredIfExpressionsRule$register(ctype){this.load(this,ctype);}).bind(this);if(LazyLoader.isLoaded(this.prop.get_containingType())){register(this.prop.get_containingType().get_jstype());}
else{$extend(this.prop.get_containingType().get_fullName(),register);}}
RequiredIfExpressionsRule.prototype={load:function RequiredIfExpressionsRule$load(rule,loadedType){if(!loadedType.meta.baseType||LazyLoader.isLoaded(loadedType.meta.baseType)){var inputs=[];var targetInput=new RuleInput(rule.prop);targetInput.set_isTarget(true);if(rule.prop.get_origin()==="client")
targetInput.set_dependsOnInit(true);inputs.push(targetInput);for(var i=0;i<rule._dependsOn.length;i++){Model.property(rule._dependsOn[i],rule.prop.get_containingType(),true,function(chain){rule._dependsOn[i]=chain;var watchPathInput=new RuleInput(rule._dependsOn[i]);inputs.push(watchPathInput);Rule.register(rule,inputs);rule._inited=true;});}}
else{$extend(loadedType.meta.baseType.get_fullName(),function(baseType){RequiredIfExpressionsRule.load(rule,baseType);});}},required:function RequiredIfExpressionsRule$required(obj){return this._evaluationFunction.apply(obj,[obj["get_"+this.prop.get_name()]()]);},satisfies:function RequiredIfRule$satisfies(obj){return!this.required(obj)||RequiredRule.hasValue(obj,this.prop);},execute:function RequiredIfRule$execute(obj){if(this._inited===true){obj.meta.conditionIf(this.err,!this.satisfies(obj));}
else{ExoWeb.trace.logWarning("rule","RequiredIf rule on type \"{0}\" has not been initialized.",[this.prop.get_containingType().get_fullName()]);}}};Rule.requiredIfExpressions=RequiredIfExpressionsRule;function StringLengthRule(mtype,options,ctype){this.prop=mtype.property(options.property,true);var properties=[this.prop];if(!ctype){ctype=Rule.ensureError("stringLength",this.prop);}
this.min=options.min;this.max=options.max;var hasMin=(this.min!==undefined&&this.min!==null);var hasMax=(this.max!==undefined&&this.max!==null);if(hasMin&&hasMax){this.err=new Condition(ctype,$format("{0} must be between {1} and {2} characters",[this.prop.get_label(),this.min,this.max]),properties,this);this._test=this._testMinMax;}
else if(hasMin){this.err=new Condition(ctype,$format("{0} must be at least {1} characters",[this.prop.get_label(),this.min]),properties,this);this._test=this._testMin;}
else if(hasMax){this.err=new Condition(ctype,$format("{0} must be no more than {1} characters",[this.prop.get_label(),this.max]),properties,this);this._test=this._testMax;}
Rule.register(this,properties);}
StringLengthRule.prototype={execute:function(obj){var val=this.prop.value(obj);obj.meta.conditionIf(this.err,this._test(val||""));},_testMinMax:function(val){return val.length<this.min||val.length>this.max;},_testMin:function(val){return val.length<this.min;},_testMax:function(val){return val.length>this.max;},toString:function(){return $format("{0}.{1} in range, min: {2}, max: {3}",[this.prop.get_containingType().get_fullName(),this.prop.get_name(),this.min==undefined?"":this.min,this.max===undefined?"":this.max]);}};Rule.stringLength=StringLengthRule;function ConditionTypeSet(name){if(allConditionTypeSets[name]){ExoWeb.trace.throwAndLog("conditions","A set with the name \"{0}\" has already been created.",[name]);}
this._name=name;this._types=[];this._active=false;allConditionTypeSets[name]=this;}
var allConditionTypeSets={};ConditionTypeSet.all=function ConditionTypeSet$all(){var all=[];for(var name in allConditionTypeSets){all.push(allConditionTypeSets[name]);}
return all;};ConditionTypeSet.get=function ConditionTypeSet$get(name){return allConditionTypeSets[name];};ConditionTypeSet.prototype={get_name:function ConditionTypeSet$get_name(){return this._name;},get_types:function ConditionTypeSet$get_types(){return this._types;},get_active:function ConditionTypeSet$get_active(){return this._active;},set_active:function ConditionTypeSet$set_active(value){if(value===true&&!this._active){this._raiseEvent("activated");}
else if(value===false&&this._active===true){this._raiseEvent("deactivated");}
this._active=value;},addActivated:function ConditionTypeSet$addActivated(handler){this._addEvent("activated",handler);},removeActivated:function ConditionTypeSet$removeActivated(handler){this._removeEvent("activated",handler);},addDeactivated:function ConditionTypeSet$addDeactivated(handler){this._addEvent("deactivated",handler);},removeDeactivated:function ConditionTypeSet$removeDeactivated(handler){this._removeEvent("deactivated",handler);}};ConditionTypeSet.mixin(ExoWeb.Functor.eventing);ExoWeb.Model.ConditionTypeSet=ConditionTypeSet;ConditionTypeSet.registerClass("ExoWeb.Model.ConditionTypeSet");function ConditionType(code,category,message,sets){if(arguments.length===0){return;}
if(allConditionTypes[code]){ExoWeb.trace.throwAndLog("conditions","A condition type with the code \"{0}\" has already been created.",[code]);}
this._code=code;this._category=category;this._message=message;this._sets=(sets===undefined||sets===null)?[]:sets;this._rules=[];if(sets&&sets.length>0){Array.forEach(sets,function(s){s._types.push(this);},this);}
allConditionTypes[code]=this;}
var allConditionTypes={};ConditionType.all=function ConditionType$all(){var all=[];for(var name in allConditionTypes){all.push(allConditionTypes[name]);}
return all;}
ConditionType.get=function ConditionType$get(code){return allConditionTypes[code];};ConditionType.prototype={get_code:function ConditionType$get_code(){return this._code;},get_category:function ConditionType$get_category(){return this._category;},get_message:function ConditionType$get_message(){return this._message;},get_sets:function ConditionType$get_sets(){return this._sets;},get_rules:function ConditionType$get_rules(){return this._rules;},extend:function ConditionType$extend(data){for(var prop in data){if(prop!=="type"&&prop!=="rule"&&!this["get_"+prop]){var fieldName="_"+prop;this[fieldName]=data[prop];this["get"+fieldName]=function ConditionType$getter(){return this[fieldName];}}}}}
ExoWeb.Model.ConditionType=ConditionType;ConditionType.registerClass("ExoWeb.Model.ConditionType");(function(){function Error(code,message,sets){ConditionType.call(this,code,"Error",message,sets);}
Error.prototype=new ConditionType();ExoWeb.Model.ConditionType.Error=Error;Error.registerClass("ExoWeb.Model.ConditionType.Error",ConditionType);function Warning(code,message,sets){ConditionType.call(this,code,"Warning",message,sets);}
Warning.prototype=new ConditionType();ExoWeb.Model.ConditionType.Warning=Warning;Warning.registerClass("ExoWeb.Model.ConditionType.Warning",ConditionType);function Permission(code,message,sets,permissionType,isAllowed){ConditionType.call(this,code,"Permission",message,sets);this._permissionType=permissionType;this._isAllowed=isAllowed;}
Permission.prototype=new ConditionType();Permission.mixin({get_permissionType:function Permission$get_permissionType(){return this._permissionType;},get_isAllowed:function Permission$get_isAllowed(){return this._isAllowed;}});ExoWeb.Model.ConditionType.Permission=Permission;Permission.registerClass("ExoWeb.Model.ConditionType.Permission",ConditionType);})();function Condition(type,message,relatedProperties,origin){this._type=type;this._properties=relatedProperties||[];this._message=message;this._origin=origin;this._targets=[];Sys.Observer.makeObservable(this._targets);}
Condition.prototype={get_type:function(){return this._type;},get_properties:function(){return this._properties;},get_message:function(){return this._message;},set_message:function(message){this._message=message;},get_origin:function(){return this._origin;},set_origin:function(origin){this._origin=origin;},get_targets:function(){return this._targets;},equals:function(o){return o.property.equals(this.property)&&o._message.equals(this._message);}};ExoWeb.Model.Condition=Condition;Condition.registerClass("ExoWeb.Model.Condition");function FormatError(message,invalidValue){this._message=message;this._invalidValue=invalidValue;}
var formatConditionType=new ConditionType("FormatError","Error","The value is not properly formatted.",[]);FormatError.mixin({createCondition:function FormatError$createCondition(origin,prop){return new Condition(formatConditionType,$format(this.get_message(),{value:prop.get_label()}),[prop],origin);},get_message:function FormateError$get_message(){return this._message;},get_invalidValue:function FormateError$get_invalidValue(){return this._invalidValue;},toString:function FormateError$toString(){return this._invalidValue;}});ExoWeb.Model.FormatError=FormatError;FormatError.registerClass("ExoWeb.Model.FormatError");Number.formats={};String.formats={};Date.formats={};TimeSpan.formats={};Boolean.formats={};Object.formats={};Array.formats={};Number.formats.Integer=new Format({description:"#,###",convert:function(val){return Math.round(val).toString();},convertBack:function(str){if(!/^([-\+])?(\d+)?\,?(\d+)?\,?(\d+)?\,?(\d+)$/.test(str)){throw new Error("invalid format");}
return parseInt(str,10);}});Number.formats.Float=new Format({description:"#,###.#",convert:function(val){return val.toString();},convertBack:function(str){if(!/^\s*([-\+])?(\d+)?\,?(\d+)?\,?(\d+)?\,?(\d+)?(\.(\d\d*))?\s*$/.test(str)){throw new Error("invalid format");}
var valString=str.replace(/,/g,"");var val=parseFloat(valString);if(isNaN(val)){throw new Error("invalid format");}
return val;}});Number.formats.Percent=new Format({description:"##.#%",convert:function(val){return(val*100).toPrecision(3).toString()+" %";}});Number.formats.Currency=new Format({description:"$#,###.##",convert:function(val){var valString=val.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,",");return"$"+valString;},convertBack:function(str){var valString=str.replace(/[\$,]/g,"");if(!/^\s*([-\+])?(\d+)?\,?(\d+)?\,?(\d+)?\,?(\d+)?(\.(\d){0,2})?\s*$/.test(valString)){throw new Error("invalid format");}
var val=parseFloat(valString);return val;}});Number.formats.$system=Number.formats.Float;String.formats.Phone=new Format({description:"###-###-#### x####",convertBack:function(str){if(!/^\s*\(?([1-9][0-9][0-9])\)?[ -]?([0-9]{3})-?([0-9]{4})( ?x[0-9]{1,8})?\s*$/.test(str)){throw new Error("invalid format");}
return str;}});String.formats.PhoneAreaCodeOptional=new Format({description:"###-###-#### x#### or ###-#### x####",convertBack:function(str){if(!/^\s*\(?([1-9][0-9][0-9])\)?[ -]?([0-9]{3})-?([0-9]{4})( ?x[0-9]{1,8})?\s*$/.test(str)&&!/^\s*([0-9]{3})-?([0-9]{4})( ?x[0-9]{1,8})?\s*$/.test(str)){throw new Error("invalid format");}
return str;}});String.formats.Email=new Format({description:"name@address.com",convertBack:function(str){if(!/^\s*([a-zA-Z0-9\!\#\$\%\&\'\*\+\-\/\=\?\^_\`\{\|\}\~]+(\.[a-zA-Z0-9\!\#\$\%\&\'\*\+\-\/\=\?\^_\`\{\|\}\~]+)*@([a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9](\.[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9])*\.[a-zA-Z]{2,6}|([0-9]{1,3}(\.[0-9]{1,3}){3})))\s*$/.test(str)){throw new Error("invalid format");}
return str;}});String.formats.ZipCode=new Format({description:"##### or #####-####",convertBack:function(str){if(!/^\s*(\d{5})(-\d{4})?\s*$/.test(str)){throw new Error("invalid format");}
return str;}});String.formats.$system=new Format({convertBack:function(val){return val?$.trim(val):val;}});Boolean.formats.YesNo=new Format({convert:function(val){return val?"Yes":"No";},convertBack:function(str){return str.toLowerCase()=="yes";}});Boolean.formats.TrueFalse=new Format({convert:function(val){return val?"true":"false";},convertBack:function(str){if(str.toLowerCase()=="true"){return true;}
else if(str.toLowerCase()=="false"){return false;}}});Boolean.formats.$system=Boolean.formats.TrueFalse;Boolean.formats.$display=Boolean.formats.YesNo;Date.formats.DateTime=new Format({description:"mm/dd/yyyy hh:mm AM/PM",convert:function(val){return val.format("MM/dd/yyyy h:mm tt");},convertBack:function(str){var val=Date.parseInvariant(str);if(val!==null){return val;}
throw new Error("invalid date");}});Date.formats.ShortDate=new Format({description:"mm/dd/yyyy",convert:function(val){return val.format("M/d/yyyy");},convertBack:function(str){var val=Date.parseInvariant(str);if(val!==null){return val;}
throw new Error("invalid date");}});Date.formats.Time=new Format({description:"HH:MM AM/PM",convert:function(val){return val.format("h:mm tt");},convertBack:function(str){var parser=/^(1[0-2]|0?[1-9]):([0-5][0-9]) *(AM?|(PM?))$/i;var parts=str.match(parser);if(!parts){throw new Error("invalid time");}
var val=new Date();if(parts[4]){val.setHours((parseInt(parts[1],10)%12)+12);}
else{val.setHours(parseInt(parts[1],10)%12);}
val.setMinutes(parseInt(parts[2],10));val.setSeconds(0);val.setMilliseconds(0);return val;}});Date.formats.$system=Date.formats.DateTime;Date.formats.$display=Date.formats.DateTime;TimeSpan.formats.Meeting=new ExoWeb.Model.Format({convert:function(val){var num;var label;if(val.totalHours<1){num=Math.round(val.totalMinutes);label="minute";}
else if(val.totalDays<1){num=Math.round(val.totalHours*100)/100;label="hour";}
else{num=Math.round(val.totalDays*100)/100;label="day";}
return num==1?(num+" "+label):(num+" "+label+"s");},convertBack:function(str){var parser=/^([0-9]+(\.[0-9]+)?) *(m((inute)?s)?|h((our)?s?)|hr|d((ay)?s)?)$/i;var parts=str.match(parser);if(!parts){throw new Error("invalid format");}
var num=parseFloat(parts[1]);var ms;if(parts[3].startsWith("m")){ms=num*60*1000;}
else if(parts[3].startsWith("h")){ms=num*60*60*1000;}
else if(parts[3].startsWith("d")){ms=num*24*60*60*1000;}
return new TimeSpan(ms);}});TimeSpan.formats.$display=TimeSpan.formats.Meeting;TimeSpan.formats.$system=TimeSpan.formats.Meeting;Array.formats.$display=new ExoWeb.Model.Format({convert:function(val){if(!val)
return"";var builder=[];for(var i=0;i<val.length;++i)
builder.push(val[i].toString());return builder.join(", ");}});function LazyLoader(){}
LazyLoader.eval=function LazyLoader$eval(target,path,successCallback,errorCallback,scopeChain,thisPtr){if(path===undefined||path===null){path="";}
if(ExoWeb.isType(path,String)){path=new PathTokens(path);}
else if(ExoWeb.isType(path,Array)){path=new PathTokens(path.join("."));}
else if(!ExoWeb.isType(path,PathTokens)){ExoWeb.trace.throwAndLog("lazyLoad","Unknown path \"{0}\" of type {1}.",[path,ExoWeb.parseFunctionName(path.constructor)]);}
scopeChain=scopeChain||[window];if(target===undefined||target===null){target=Array.dequeue(scopeChain);}
var performedLoading=false;var continueFn=LazyLoader.eval;if(arguments.length==8){continueFn=arguments[6]instanceof Function?arguments[6]:continueFn;performedLoading=arguments[7]instanceof Boolean?arguments[7]:performedLoading;}
while(path.steps.length>0){if(continueFn==LazyLoader.evalAll&&target instanceof Array){continueFn(target,path,successCallback,errorCallback,scopeChain,thisPtr,continueFn,performedLoading);return;}
var step=Array.dequeue(path.steps);if(!LazyLoader.isLoaded(target,step.property)){performedLoading=true;LazyLoader.load(target,step.property,function(){var nextTarget=ExoWeb.getValue(target,step.property);if(nextTarget===undefined){if(scopeChain.length>0){Array.insert(path.steps,0,step);continueFn(Array.dequeue(scopeChain),path,successCallback,errorCallback,scopeChain,thisPtr,continueFn,performedLoading);}
else if(errorCallback){errorCallback.call(thisPtr,"Property is undefined: "+step.property);}
else{ExoWeb.trace.throwAndLog(["lazyLoad"],"Cannot complete property evaluation because a property is undefined: {0}",[step.property]);}}
else if(nextTarget!==null&&(!step.cast||ExoWeb.isType(nextTarget,step.cast))){continueFn(nextTarget,path,successCallback,errorCallback,[],thisPtr,continueFn,performedLoading);}
else if(successCallback){successCallback.call(thisPtr,null);}});return;}
else{var propValue=ExoWeb.getValue(target,step.property);if(propValue===undefined){if(scopeChain.length>0){Array.insert(path.steps,0,step);target=Array.dequeue(scopeChain);}
else{if(errorCallback){errorCallback.call(thisPtr,"Property is undefined: "+step.property);}
else{ExoWeb.trace.throwAndLog(["lazyLoad"],"Cannot complete property evaluation because a property is undefined: {0}",[step.property]);}
return;}}
else if(propValue===null||(step.cast&&!ExoWeb.isType(propValue,step.cast))){if(successCallback){successCallback.call(thisPtr,null);}
return;}
else{if(scopeChain.length>0){scopeChain=[];}
target=propValue;}}}
if(target!==undefined&&target!==null&&!LazyLoader.isLoaded(target)){performedLoading=true;LazyLoader.load(target,null,successCallback.prepare(thisPtr,[target,performedLoading]));}
else if(successCallback){successCallback.call(thisPtr,target,performedLoading);}};LazyLoader.evalAll=function LazyLoader$evalAll(target,path,successCallback,errorCallback,scopeChain,thisPtr){var performedLoading=arguments.length==8&&arguments[7]instanceof Boolean?arguments[7]:false;if(target instanceof Array){if(LazyLoader.isLoaded(target)){var signal=new ExoWeb.Signal("evalAll - "+path);var results=[];var errors=[];var successCallbacks=[];var errorCallbacks=[];var allSucceeded=true;Array.forEach(target,function(subTarget,i){results.push(null);errors.push(null);successCallbacks.push(signal.pending(function(result,performedLoadingOne){performedLoading=performedLoading||performedLoadingOne;results[i]=result;}));errorCallbacks.push(signal.orPending(function(err){allSucceeded=false;errors[i]=err;}));});Array.forEach(target,function(subTarget,i){if(path instanceof PathTokens){path=path.buildExpression();}
LazyLoader.eval(subTarget,path,successCallbacks[i],errorCallbacks[i],scopeChain,thisPtr,LazyLoader.evalAll,performedLoading);});signal.waitForAll(function(){if(allSucceeded){if(successCallback){successCallback.call(thisPtr,results,performedLoading);}}
else if(errorCallback){errorCallback.call(thisPtr,errors);}
else{var numErrors=0;Array.forEach(errors,function(e){if(e){ExoWeb.trace.logError(["lazyLoad"],e);numErrors+=1;}
ExoWeb.trace.throwAndLog(["lazyLoad"],"{0} errors encountered while attempting to eval paths for all items in the target array.",[numErrors]);});}});}
else{LazyLoader.load(target,null,function(){LazyLoader.evalAll(target,path,successCallback,errorCallback,scopeChain,thisPtr,LazyLoader.evalAll,performedLoading);});}}
else{LazyLoader.evalAll([target],path,successCallback,errorCallback,scopeChain,thisPtr,LazyLoader.evalAll,performedLoading);}};LazyLoader.isLoaded=function LazyLoader$isLoaded(obj,propName){if(obj===undefined||obj===null){return;}
var reg=obj._lazyLoader;if(!reg){return true;}
var loader;if(propName&&reg.byProp){loader=reg.byProp[propName];}
if(!loader){loader=reg.allProps;}
return!loader||(!!loader.isLoaded&&obj._lazyLoader.isLoaded(obj,propName));};LazyLoader.load=function LazyLoader$load(obj,propName,callback,thisPtr){var reg=obj._lazyLoader;if(!reg){if(callback&&callback instanceof Function){callback.call(thisPtr||this);}}
else{var loader;if(propName&&reg.byProp){loader=reg.byProp[propName];}
if(!loader){loader=reg.allProps;}
if(!loader){ExoWeb.trace.throwAndLog(["lazyLoad"],"Attempting to load object but no appropriate loader is registered. object: {0}, property: {1}",[obj,propName]);}
loader.load(obj,propName,callback,thisPtr);}};LazyLoader.isRegistered=function LazyLoader$isRegistered(obj,loader,propName){var reg=obj._lazyLoader;if(!reg){return false;}
if(propName){return reg.byProp&&reg.byProp[propName]===loader;}
return reg.allProps===loader;};LazyLoader.register=function LazyLoader$register(obj,loader,propName){var reg=obj._lazyLoader;if(!reg){reg=obj._lazyLoader={};}
if(propName){if(!reg.byProp){reg.byProp={};}
reg.byProp[propName]=loader;}
else{obj._lazyLoader.allProps=loader;}};LazyLoader.unregister=function LazyLoader$unregister(obj,loader,propName){var reg=obj._lazyLoader;if(!reg){return;}
if(propName){delete reg.byProp[propName];}else if(reg.byProp){var allDeleted=true;for(var p in reg.byProp){if(reg.byProp[p]===loader){delete reg.byProp[p];}
else{allDeleted=false;}}
if(allDeleted){delete reg.byProp;}}
if(reg.allProps===loader){delete reg.allProps;}
if(!reg.byProp&&!reg.allProps){delete obj._lazyLoader;}};ExoWeb.Model.LazyLoader=LazyLoader;LazyLoader.registerClass("ExoWeb.Model.LazyLoader");var objectProviderFn=function objectProviderFn(type,ids,paths,inScope,changes,onSuccess,onFailure){throw"Object provider has not been implemented.  Call ExoWeb.Mapper.setObjectProvider(fn);";};function objectProvider(type,ids,paths,inScope,changes,onSuccess,onFailure,thisPtr){var scopeQueries;if(onSuccess!==undefined&&onSuccess!==null&&!(onSuccess instanceof Function)){scopeQueries=onSuccess;onSuccess=onFailure;onFailure=thisPtr;thisPtr=arguments.length>8?arguments[8]:null;}
else{scopeQueries=context.server._scopeQueries;}
if(onFailure!==undefined&&onFailure!==null&&!(onFailure instanceof Function)){thisPtr=onFailure;onFailure=null;}
var batch=ExoWeb.Batch.suspendCurrent("objectProvider");objectProviderFn.call(this,type,ids,paths,inScope,changes,scopeQueries,function objectProviderSuccess(){ExoWeb.Batch.resume(batch);if(onSuccess)onSuccess.apply(thisPtr||this,arguments);},function objectProviderFailure(){ExoWeb.Batch.resume(batch);if(onFailure)onFailure.apply(thisPtr||this,arguments);});}
ExoWeb.Mapper.setObjectProvider=function setObjectProvider(fn){objectProviderFn=fn;};var queryProviderFn=function queryProviderFn(queries,changes,onSuccess,onFailure){throw"Query provider has not been implemented.  Call ExoWeb.Mapper.setQueryProvider(fn);";};function queryProvider(queries,changes,onSuccess,onFailure,thisPtr,thisPtr){var scopeQueries;if(onSuccess!==undefined&&onSuccess!==null&&!(onSuccess instanceof Function)){scopeQueries=onSuccess;onSuccess=onFailure;onFailure=thisPtr;thisPtr=arguments.length>5?arguments[5]:null;}
else{scopeQueries=context.server._scopeQueries;}
if(onFailure!==undefined&&onFailure!==null&&!(onFailure instanceof Function)){thisPtr=onFailure;onFailure=null;}
var batch=ExoWeb.Batch.suspendCurrent("queryProvider");queryProviderFn.call(this,queries,changes,scopeQueries,function queryProviderSuccess(){ExoWeb.Batch.resume(batch);if(onSuccess)onSuccess.apply(thisPtr||this,arguments);},function queryProviderFailure(){ExoWeb.Batch.resume(batch);if(onFailure)onFailure.apply(thisPtr||this,arguments);});}
ExoWeb.Mapper.setQueryProvider=function setQueryProvider(fn){queryProviderFn=fn;};var typeProviderFn=function typeProviderFn(type,onSuccess,onFailure){throw"Type provider has not been implemented.  Call ExoWeb.Mapper.setTypeProvider(fn);";};function typeProvider(type,onSuccess,onFailure,thisPtr){if(onFailure!==undefined&&onFailure!==null&&!(onFailure instanceof Function)){thisPtr=onFailure;onFailure=null;}
var batch=ExoWeb.Batch.suspendCurrent("typeProvider");var cachedType=ExoWeb.cache(type);if(cachedType){if(ExoWeb.cacheHash&&cachedType.cacheHash!==ExoWeb.cacheHash){ExoWeb.cache(type,null);}
else{onSuccess.call(thisPtr||this,cachedType);return;}}
typeProviderFn.call(this,type,function typeProviderSuccess(){ExoWeb.Batch.resume(batch);arguments[0].cacheHash=ExoWeb.cacheHash;ExoWeb.cache(type,arguments[0]);if(onSuccess)onSuccess.apply(thisPtr||this,arguments);},function typeProviderFailure(){ExoWeb.Batch.resume(batch);if(onFailure)onFailure.apply(thisPtr||this,arguments);});}
ExoWeb.Mapper.setTypeProvider=function setTypeProvider(fn){typeProviderFn=fn;};var listProviderFn=function listProvider(ownerType,ownerId,paths,changes,onSuccess,onFailure){throw"List provider has not been implemented.  Call ExoWeb.Mapper.setListProvider(fn);";};function listProvider(ownerType,ownerId,listProp,otherProps,changes,onSuccess,onFailure,thisPtr){var scopeQueries;if(onSuccess!==undefined&&onSuccess!==null&&!(onSuccess instanceof Function)){scopeQueries=onSuccess;onSuccess=onFailure;onFailure=thisPtr;thisPtr=arguments.length>7?arguments[7]:null;}
else{scopeQueries=context.server._scopeQueries;}
if(onFailure!==undefined&&onFailure!==null&&!(onFailure instanceof Function)){thisPtr=onFailure;onFailure=null;}
var batch=ExoWeb.Batch.suspendCurrent("listProvider");var listPath=(ownerId=="static"?ownerType:"this")+"."+listProp;var paths=[listPath];if(otherProps.length>0){Array.forEach(otherProps,function(p){paths.push(p.startsWith("this.")?listPath+"."+p.substring(5):p);});}
listProviderFn.call(this,ownerType,ownerId=="static"?null:ownerId,paths,changes,scopeQueries,function listProviderSuccess(){ExoWeb.Batch.resume(batch);if(onSuccess)onSuccess.apply(thisPtr||this,arguments);},function listProviderFailure(){ExoWeb.Batch.resume(batch);if(onFailure)onFailure.apply(thisPtr||this,arguments);});}
ExoWeb.Mapper.setListProvider=function setListProvider(fn){listProviderFn=fn;};var roundtripProviderFn=function roundtripProviderFn(changes,onSuccess,onFailure){throw"Roundtrip provider has not been implemented.  Call ExoWeb.Mapper.setRoundtripProvider(fn);";};function roundtripProvider(changes,onSuccess,onFailure,thisPtr){var scopeQueries;if(onSuccess!==undefined&&onSuccess!==null&&!(onSuccess instanceof Function)){scopeQueries=onSuccess;onSuccess=onFailure;onFailure=thisPtr;thisPtr=arguments.length>4?arguments[4]:null;}
else{scopeQueries=context.server._scopeQueries;}
if(onFailure!==undefined&&onFailure!==null&&!(onFailure instanceof Function)){thisPtr=onFailure;onFailure=null;}
var batch=ExoWeb.Batch.suspendCurrent("roundtripProvider");roundtripProviderFn.call(this,changes,scopeQueries,function roundtripProviderSucess(){ExoWeb.Batch.resume(batch);if(onSuccess)onSuccess.apply(thisPtr||this,arguments);},function roundtripProviderFailure(){ExoWeb.Batch.resume(batch);if(onFailure)onFailure.apply(thisPtr||this,arguments);});}
ExoWeb.Mapper.setRoundtripProvider=function setRoundtripProvider(fn){roundtripProviderFn=fn;};var saveProviderFn=function saveProviderFn(root,changes,onSuccess,onFailure){throw"Save provider has not been implemented.  Call ExoWeb.Mapper.setSaveProvider(fn);";};function saveProvider(root,changes,onSuccess,onFailure,thisPtr){var scopeQueries;if(onSuccess!==undefined&&onSuccess!==null&&!(onSuccess instanceof Function)){scopeQueries=onSuccess;onSuccess=onFailure;onFailure=thisPtr;thisPtr=arguments.length>5?arguments[5]:null;}
else{scopeQueries=context.server._scopeQueries;}
if(onFailure!==undefined&&onFailure!==null&&!(onFailure instanceof Function)){thisPtr=onFailure;onFailure=null;}
var batch=ExoWeb.Batch.suspendCurrent("saveProvider");saveProviderFn.call(this,root,changes,scopeQueries,function saveProviderSuccess(){ExoWeb.Batch.resume(batch);if(onSuccess)onSuccess.apply(thisPtr||this,arguments);},function saveProviderFailure(){ExoWeb.Batch.resume(batch);if(onFailure)onFailure.apply(thisPtr||this,arguments);});}
ExoWeb.Mapper.setSaveProvider=function setSaveProvider(fn){saveProviderFn=fn;};var eventProviderFn=function eventProviderFn(eventType,instance,event,paths,changes,onSuccess,onFailure){throw"Event provider has not been implemented.  Call ExoWeb.Mapper.setEventProvider(fn);";};function eventProvider(eventType,instance,event,paths,changes,onSuccess,onFailure,thisPtr){var scopeQueries;if(onSuccess!==undefined&&onSuccess!==null&&!(onSuccess instanceof Function)){scopeQueries=onSuccess;onSuccess=onFailure;onFailure=thisPtr;thisPtr=arguments.length>8?arguments[8]:null;}
else{scopeQueries=context.server._scopeQueries;}
if(onFailure!==undefined&&onFailure!==null&&!(onFailure instanceof Function)){thisPtr=onFailure;onFailure=null;}
var batch=ExoWeb.Batch.suspendCurrent("eventProvider");eventProviderFn.call(this,eventType,instance,event,paths,changes,scopeQueries,function eventProviderSuccess(){ExoWeb.Batch.resume(batch);if(onSuccess)onSuccess.apply(thisPtr||this,arguments);},function eventProviderFailure(){ExoWeb.Batch.resume(batch);if(onFailure)onFailure.apply(thisPtr||this,arguments);});}
ExoWeb.Mapper.setEventProvider=function setEventProvider(fn){eventProviderFn=fn;};function ResponseHandler(model,serverSync,options){if(options===undefined||options===null){throw new Error("Options cannot be null or undefined.");}
this._model=model;this._serverSync=serverSync;this._options=options;}
ResponseHandler.mixin({execute:ExoWeb.FunctionChain.prepare(function loadTypes(callback,thisPtr){if(this._options.types){ExoWeb.trace.log("responseHandler","Loading types.");typesFromJson(this._model,this._options.types);}
callback.call(thisPtr||this);},function applyInitChanges(callback,thisPtr){if(this._options.changes){ExoWeb.trace.log("responseHandler","Applying \"init new\" changes.");var changes=Array.prototype.slice.apply(this._options.changes);var initChanges=changes.filter(function(change){return change.type==="InitNew";});this._serverSync._changeLog.applyChanges(initChanges,this._options.source,this._serverSync);callback.call(thisPtr);}
else{callback.call(thisPtr||this);}},function loadInstances(callback,thisPtr){if(this._options.instances){ExoWeb.trace.log("responseHandler","Loading instances.");objectsFromJson(this._model,this._options.instances,callback,thisPtr);}
else{callback.call(thisPtr||this);}},function applyNonInitChanges(callback,thisPtr){if(this._options.changes){ExoWeb.trace.log("responseHandler","Applying non-\"init new\" changes.");var changes=Array.prototype.slice.apply(this._options.changes);var initChanges=changes.filter(function(change){return change.type!=="InitNew";});this._serverSync._changeLog.applyChanges(initChanges,this._options.source,this._serverSync);callback.call(thisPtr);}
else{callback.call(thisPtr||this);}},function loadConditions(callback,thisPtr){if(this._options.conditions){ExoWeb.trace.log("reponseHandler","Loading conditions.");conditionsFromJson(this._model,this._options.conditions,callback,thisPtr);}
else{callback.call(thisPtr||this);}})});ExoWeb.Mapper.ResponseHandler=ResponseHandler;ExoWeb.Model.Entity.formats.$load=new ExoWeb.Model.Format({convert:function(obj){return obj.meta.type.toIdString(obj.meta.id);},convertBack:function(val){var ids=val.split("|");var jstype=ExoWeb.Model.Model.getJsType(ids[0]);var obj=jstype.meta.get(ids[1]);if(!obj){obj=new jstype(ids[1]);ObjectLazyLoader.register(obj);}
return obj;}});function toExoGraph(translator,val){if(val===undefined||val===null)
return;if(val instanceof ExoWeb.Model.Entity){var result={id:val.meta.id,type:val.meta.type.get_fullName()};if(val.meta.isNew){result.isNew=true;}
result.id=translator.forward(result.type,result.id)||result.id;return result;}
return val;}
function translateId(translator,type,id){var serverId=translator.forward(type,id)||id;var clientId=translator.reverse(type,serverId)||serverId;return clientId;}
function fromExoGraph(val,translator){if(val!==undefined&&val!==null&&val.type&&val.id){var type=ExoWeb.Model.Model.getJsType(val.type);if(type.meta&&type.meta instanceof ExoWeb.Model.Type&&translator){var id=translateId(translator,val.type,val.id);var obj=type.meta.get(id);if(!obj){obj=new type(id);ObjectLazyLoader.register(obj);ExoWeb.trace.log(["entity","server"],"{0}({1})  (ghost)",[type.meta.get_fullName(),id]);}
return obj;}
return val;}
return val;}
function ExoGraphEventListener(model,translator){this._model=model;this._translator=translator;model.addListChanged(this.onListChanged.bind(this));model.addAfterPropertySet(this.onPropertyChanged.bind(this));model.addObjectRegistered(this.onObjectRegistered.bind(this));model.addObjectUnregistered(this.onObjectUnregistered.bind(this));}
ExoGraphEventListener.mixin(ExoWeb.Functor.eventing);ExoGraphEventListener.mixin({addChangeCaptured:function ExoGraphEventListener$onEvent(handler){this._addEvent("changeCaptured",handler);},onListChanged:function ExoGraphEventListener$onListChanged(obj,property,listChanges){if(property.get_containingType().get_origin()!="server"||property.get_origin()!=="server"||property.get_isStatic()){return;}
if(obj instanceof Function){}
else{}
for(var i=0;i<listChanges.length;++i){var listChange=listChanges[i];var change={type:"ListChange",instance:toExoGraph(this._translator,obj),property:property.get_name(),added:[],removed:[]};var _this=this;if(listChange.newStartingIndex>=0||listChange.newItems){Array.forEach(listChange.newItems,function ExoGraphEventListener$onListChanged$addedItem(obj){change.added.push(toExoGraph(_this._translator,obj));});}
if(listChange.oldStartingIndex>=0||listChange.oldItems){Array.forEach(listChange.oldItems,function ExoGraphEventListener$onListChanged$removedItem(obj){change.removed.push(toExoGraph(_this._translator,obj));});}
this._raiseEvent("changeCaptured",[change]);}},onObjectRegistered:function ExoGraphEventListener$onObjectRegistered(obj){if(obj.meta.type.get_origin()!="server"){return;}
if(obj.meta.isNew){var change={type:"InitNew",instance:toExoGraph(this._translator,obj)};this._raiseEvent("changeCaptured",[change]);}},onObjectUnregistered:function ExoGraphEventListener$onObjectUnregistered(obj){if(obj.meta.type.get_origin()!="server"){return;}
ExoWeb.trace.throwAndLog("server","Unregistering server-type objects is not currently supported: {type.fullName}({id})",obj.meta);},onPropertyChanged:function ExoGraphEventListener$onPropertyChanged(obj,property,newValue,oldValue){if(property.get_containingType().get_origin()!="server"||property.get_origin()!=="server"||property.get_isStatic()){return;}
if(property.get_isValueType()){if(obj instanceof Function){}
else{}
var valueChange={type:"ValueChange",instance:toExoGraph(this._translator,obj),property:property.get_name(),oldValue:oldValue,newValue:newValue};this._raiseEvent("changeCaptured",[valueChange]);}
else{if(obj instanceof Function){}
else{}
var refChange={type:"ReferenceChange",instance:toExoGraph(this._translator,obj),property:property.get_name(),oldValue:toExoGraph(this._translator,oldValue),newValue:toExoGraph(this._translator,newValue)};this._raiseEvent("changeCaptured",[refChange]);}}});function ChangeSet(source,initialChanges){if(!source||source.constructor!==String){ExoWeb.trace.throwAndLog("changeLog","Creating a change set requires a string source argument.");}
this._source=source;this._changes=(initialChanges&&initialChanges instanceof Array)?[].concat(initialChanges):[];}
ChangeSet.mixin({add:function(change){this._changes.push(change);},changes:function(){return this._changes;},count:function(filter,thisPtr){if(!filter){return this._changes.length;}
return this._changes.filter(filter,thisPtr).length;},lastChange:function(){return this._changes.length>0?this._changes[this._changes.length-1]:null;},serialize:function(filter,thisPtr){return{source:(this._source==="init"||this._source==="client")?this._source:"server",changes:filter?this._changes.filter(filter,thisPtr):Array.prototype.slice.call(this._changes)};},source:function(){return this._source;},truncate:function(filter,thisPtr){for(var i=0;i<this._changes.length;i++){if(!filter||filter.call(thisPtr||this,this._changes[i])===true){this._changes.splice(i--,1);}}},undo:function(){if(this._changes.length>0){var change=this._changes[this._changes.length-1];this._changes.splice(this._changes.length-1,1);return change;}
return null;}});function ChangeLog(){this._activeSet=null;this._sets=[];}
ChangeLog.mixin({activeSet:function(){return this._activeSet;},add:function(change){if(this._activeSet===null){ExoWeb.trace.throwAndLog("server","The change log is not currently active.");}
this._activeSet.add(change);},addSet:function(source,changes){this._sets.push(new ChangeSet(source,changes));},count:function(filter,thisPtr){var result=0;forEach(this._sets,function(set){result+=set.count(filter,thisPtr);},this);return result;},lastChange:function(){for(var i=this._sets.length-1;i>=0;i--){var set=this._sets[i];var change=set.lastChange();if(change!==null&&change!==undefined){return change;}}
return null;},serialize:function(filter,thisPtr){return this._sets.map(function(set){return set.serialize(filter,thisPtr);});},sets:function(){return this._sets;},start:function(source){if(!source||source.constructor!==String){ExoWeb.trace.throwAndLog("changeLog","ChangeLog.start requires a string source argument.");}
var set=new ChangeSet(source);this._sets.push(set);this._activeSet=set;return set;},truncate:function(filter,thisPtr){for(var i=0;i<this._sets.length;i++){this._sets[i].truncate(filter,thisPtr);if(this._sets[i].changes().length===0){this._sets.splice(i--,1);if(this._sets[i]===this._activeSet){this._activeSet=null;}}}
this.start("client");},undo:function(){if(!this._activeSet){ExoWeb.trace.throwAndLog("server","The change log is not currently active.");}
var currentSet=this._activeSet,currentSetIndex=this._sets.indexOf(currentSet);while(currentSet.changes().length===0){this._sets.splice(currentSetIndex,1);if(--currentSetIndex<0){return null;}
currentSet=this._sets[currentSetIndex];this._activeSet=currentSet;}
return currentSet.undo();},applyChanges:function(changes,source,serverSync){if(!changes||!(changes instanceof Array)){return;}
try{var batch=ExoWeb.Batch.start("apply changes");if((source!==undefined&&source!==null&&(!this.activeSet()||this.activeSet().source()!==source))||serverSync.isCapturingChanges()){if(source){this.start(source);}
else{this.start("unknown");ExoWeb.trace.logWarning("server","Changes to apply but no source is specified.");}}
var newChanges=0;var currentChanges=this.count(serverSync.canSave,serverSync);var totalChanges=changes.length;var saveChanges=changes.filter(function(c,i){return c.type==="Save";});var numSaveChanges=saveChanges.length;if(numSaveChanges>0){this.truncate(serverSync.canSave,serverSync);saveChanges.forEach(function(change){if(!change.idChanges)return;change.idChanges.forEach(function(idChange){var jstype=ExoWeb.Model.Model.getJsType(idChange.type,true);if(jstype&&ExoWeb.Model.LazyLoader.isLoaded(jstype.meta)){var serverOldId=idChange.oldId;var clientOldId=!(idChange.oldId in jstype.meta._pool)?serverSync._translator.reverse(idChange.type,serverOldId):idChange.oldId;serverSync._scopeQueries.forEach(function(query){query.ids=query.ids.map(function(id){return(id===clientOldId)?idChange.newId:id;},this);},this);}},this);},this);}
changes.forEach(function(change,changeIndex){if(change.type==="InitNew"){this.applyInitChange(change,serverSync);}
else if(change.type==="ReferenceChange"){this.applyRefChange(change,serverSync);}
else if(change.type==="ValueChange"){this.applyValChange(change,serverSync);}
else if(change.type==="ListChange"){this.applyListChange(change,serverSync);}
else if(change.type==="Save"){this.applySaveChange(change,serverSync);numSaveChanges--;}
if(change.type!=="Save"&&numSaveChanges<=0){newChanges++;this.add(change);}},this);if(serverSync.isCapturingChanges()){this.start("client");}
ExoWeb.Batch.end(batch);if(newChanges>0){Sys.Observer.raisePropertyChanged(serverSync,"HasPendingChanges");}}
catch(e){ExoWeb.Batch.end(batch);ExoWeb.trace.throwAndLog(["server"],e);}},applySaveChange:function(change,serverSync){if(!change.idChanges)
return;change.idChanges.forEach(function(idChange,idChangeIndex){ensureJsType(serverSync._model,idChange.type,serverSync.ignoreChanges(function(jstype){var serverOldId=idChange.oldId;var clientOldId=!(idChange.oldId in jstype.meta._pool)?serverSync._translator.reverse(idChange.type,serverOldId):idChange.oldId;if(clientOldId){var type=serverSync._model.type(idChange.type);var obj=type.get(clientOldId);if(!obj){ExoWeb.trace.throwAndLog("server","Unable to change id for object of type \"{0}\" from \"{1}\" to \"{2}\" since the object could not be found.",[jstype.meta.get_fullName(),idChange.oldId,idChange.newId]);}
type.changeObjectId(clientOldId,idChange.newId);Sys.Observer.setValue(obj.meta,"isNew",false);serverSync._scopeQueries.forEach(function(query){query.ids=query.ids.map(function(id){return(id===clientOldId)?idChange.newId:id;},this);},this);}
else{ExoWeb.trace.logWarning("server","Cannot apply id change on type \"{type}\" since old id \"{oldId}\" was not found.",idChange);}}),this);},this);},applyInitChange:function(change,serverSync){tryGetJsType(serverSync._model,change.instance.type,null,false,serverSync.ignoreChanges(function(jstype){if(!jstype.meta.get(change.instance.id)){var newObj=new jstype();var serverOldId=serverSync._translator.forward(change.instance.type,change.instance.id)||change.instance.id;serverSync._translator.add(change.instance.type,newObj.meta.id,serverOldId);}}),this);},applyRefChange:function(change,serverSync){tryGetJsType(serverSync._model,change.instance.type,change.property,false,function(srcType){tryGetEntity(serverSync._model,serverSync._translator,srcType,change.instance.id,change.property,LazyLoadEnum.None,serverSync.ignoreChanges(function(srcObj){if(change.newValue){tryGetJsType(serverSync._model,change.newValue.type,null,true,serverSync.ignoreChanges(function(refType){var refObj=fromExoGraph(change.newValue,serverSync._translator);Sys.Observer.setValue(srcObj,change.property,refObj);}),this);}
else{Sys.Observer.setValue(srcObj,change.property,null);}}),this);},this);},applyValChange:function(change,serverSync){tryGetJsType(serverSync._model,change.instance.type,change.property,false,function(srcType){tryGetEntity(serverSync._model,serverSync._translator,srcType,change.instance.id,change.property,LazyLoadEnum.None,serverSync.ignoreChanges(function(srcObj){if(srcObj.meta.property(change.property).get_jstype()==Date&&change.newValue&&change.newValue.constructor==String&&change.newValue.length>0){change.newValue=change.newValue.replace(dateRegex,dateRegexReplace);change.newValue=new Date(change.newValue);}
Sys.Observer.setValue(srcObj,change.property,change.newValue);}),this);},this);},applyListChange:function(change,serverSync){tryGetJsType(serverSync._model,change.instance.type,change.property,false,function(srcType){tryGetEntity(serverSync._model,serverSync._translator,srcType,change.instance.id,change.property,LazyLoadEnum.None,serverSync.ignoreChanges(function(srcObj){var prop=srcObj.meta.property(change.property,true);var list=prop.value(srcObj);list.beginUpdate();var listSignal=new ExoWeb.Signal("applyListChange-items");change.added.forEach(function(item){tryGetJsType(serverSync._model,item.type,null,true,listSignal.pending(serverSync.ignoreChanges(function(itemType){var itemObj=fromExoGraph(item,serverSync._translator);if(list.indexOf(itemObj)<0){list.add(itemObj);}})),this);},this);change.removed.forEach(function(item){tryGetJsType(serverSync._model,item.type,null,false,serverSync.ignoreChanges(function(itemType){var itemObj=fromExoGraph(item,serverSync._translator);list.remove(itemObj);}),this);},this);listSignal.waitForAll(serverSync.ignoreChanges(function(){list.endUpdate();}),this);}),this);},this);}});function ServerSync(model){this._model=model;this._changeLog=new ChangeLog();this._pendingServerEvent=false;this._pendingRoundtrip=false;this._pendingSave=false;this._scopeQueries=[];this._objectsExcludedFromSave=[];this._translator=new ExoWeb.Translator();this._listener=new ExoGraphEventListener(this._model,this._translator);var applyingChanges=0;this.isApplyingChanges=function ServerSync$isApplyingChanges(){return applyingChanges>0;};this.beginApplyingChanges=function ServerSync$beginApplyingChanges(){applyingChanges++;};this.endApplyingChanges=function ServerSync$endApplyingChanges(){applyingChanges--;if(applyingChanges<0)
ExoWeb.trace.throwAndLog("Error in transaction log processing: unmatched begin and end applying changes.");};var isCapturingChanges=false;this.isCapturingChanges=function ServerSync$isCapturingChanges(){return isCapturingChanges;};this.beginCapturingChanges=function ServerSync$beginCapturingChanges(){isCapturingChanges=true;startChangeSet.call(this,"client");};this.ignoreChanges=function(callback,thisPtr){return function(){try{applyingChanges++;callback.apply(thisPtr||this,arguments);}
finally{applyingChanges--;}};};model.addObjectRegistered(function(obj){if(!obj.meta.isNew&&obj.meta.type.get_origin()=="server"&&isCapturingChanges&&!applyingChanges){ObjectLazyLoader.register(obj);}});model._server=this;this._listener.addChangeCaptured(this._captureChange.bind(this));Sys.Observer.makeObservable(this);}
ServerSync.mixin(ExoWeb.Functor.eventing);var pendingRequests=0;ExoWeb.registerActivity(function(){return pendingRequests>0;});function serializeChanges(includeAllChanges,simulateInitRoot){var changes=this._changeLog.serialize(includeAllChanges?null:this.canSave,this);if(simulateInitRoot&&simulateInitRoot.meta.isNew){function isRootChange(change){return change.type==="InitNew"&&change.instance.type===simulateInitRoot.meta.type.get_fullName()&&(change.instance.id===simulateInitRoot.meta.id||this._translator.reverse(change.instance.type,change.instance.id)===simulateInitRoot.meta.id);}
var found=false;var initSet=changes.filter(function(set){return set.source==="init";})[0];if(!initSet||!initSet.changes.some(isRootChange,this)){changes.forEach(function(set){if(found===true)return;set.changes.forEach(function(change,index){if(found===true)return;else if(isRootChange.call(this,change)){set.changes.splice(index,1);if(!initSet){initSet={changes:[change],source:"init"};changes.splice(0,0,initSet);}
else{initSet.changes.push(change);}
found=true;}},this);},this);}}
return changes;}
function startChangeSet(source){if(source){this._changeLog.start(source);}
else{this._changeLog.start("unknown");ExoWeb.trace.logWarning("server","Changes to apply but no source is specified.");}}
function ServerSync$addScopeQuery(query){this._scopeQueries.push(query);}
function ServerSync$storeInitChanges(changes){var activeSet=this._changeLog.activeSet();this._changeLog.addSet("init",changes);if(activeSet)
startChangeSet.call(this,activeSet.source());}
ServerSync.mixin({enableSave:function ServerSync$enableSave(obj){if(Array.contains(this._objectsExcludedFromSave,obj)){Array.remove(this._objectsExcludedFromSave,obj);Sys.Observer.raisePropertyChanged(this,"HasPendingChanges");return true;}},disableSave:function ServerSync$disableSave(obj){if(!Array.contains(this._objectsExcludedFromSave,obj)){this._objectsExcludedFromSave.push(obj);Sys.Observer.raisePropertyChanged(this,"HasPendingChanges");return true;}},canSaveObject:function ServerSync$canSaveObject(objOrMeta){var obj;var errorFmt="Unable to test whether object can be saved:  {0}.";if(arguments.length===0){ExoWeb.trace.throwAndLog("server",errorFmt,["argument not given"]);}
else if(objOrMeta===undefined||objOrMeta===null){ExoWeb.trace.throwAndLog("server",errorFmt,["argument is null or undefined"]);}
else if(objOrMeta instanceof ExoWeb.Model.ObjectMeta){obj=objOrMeta._obj;}
else if(objOrMeta instanceof ExoWeb.Model.Entity){obj=objOrMeta;}
else{ExoWeb.trace.throwAndLog("server",errorFmt,["argument is not of correct type"]);}
return!Array.contains(this._objectsExcludedFromSave,obj);},canSave:function ServerSync$canSave(change){if(change.type=="ListChange"){if(change.added.length>0||change.removed.length>0){var ignore=true;Array.forEach(change.added,function(item){var jstype=ExoWeb.Model.Model.getJsType(item.type,true);if(!jstype||this.canSaveObject(fromExoGraph(item,this._translator))){ignore=false;}},this);Array.forEach(change.removed,function(item){var jstype=ExoWeb.Model.Model.getJsType(item.type,true);if(!jstype||this.canSaveObject(fromExoGraph(item,this._translator))){ignore=false;}},this);if(ignore){return false;}}}
else if(change.type=="ReferenceChange:#ExoGraph"){var oldJsType=change.oldValue&&ExoWeb.Model.Model.getJsType(change.oldValue.type,true);if(oldJsType){var oldValue=fromExoGraph(change.oldValue,this._translator);if(oldValue&&!this.canSaveObject(oldValue)){return false;}}
var newJsType=change.newValue&&ExoWeb.Model.Model.getJsType(change.newValue.type,true);if(newJsType){var newValue=fromExoGraph(change.newValue,this._translator);if(newValue&&!this.canSaveObject(newValue)){return false;}}}
var jstype=ExoWeb.Model.Model.getJsType(change.instance.type,true);if(!jstype){return true;}
var instanceObj=fromExoGraph(change.instance,this._translator);return this.canSaveObject(instanceObj);},_handleResult:function ServerSync$handleResult(result,source,callback)
{var signal=new ExoWeb.Signal("Success");if(result.instances){var batch=ExoWeb.Batch.start();objectsFromJson(this._model,result.instances,signal.pending(function(){function processChanges(){ExoWeb.Batch.end(batch);if(result.changes&&result.changes.length>0){this._changeLog.applyChanges(result.changes,source,this);}
else if(source){startChangeSet.call(this,source);startChangeSet.call(this,"client");}}
if(result.conditions){conditionsFromJson(this._model,result.conditions,processChanges,this);}
else{processChanges.call(this);}}),this);}
else if(result.changes&&result.changes.length>0){this._changeLog.applyChanges(result.changes,source,this);if(result.conditions){conditionsFromJson(this._model,result.conditions,signal.pending());}}
else{if(source){startChangeSet.call(this,source);startChangeSet.call(this,"client");}
if(result.conditions){conditionsFromJson(this._model,result.conditions,signal.pending());}}
signal.waitForAll(function(){if(callback&&callback instanceof Function){callback.call(this);}},this);},_raiseBeginEvents:function(method,args){this._raiseEvent("requestBegin",[this,args]);this._raiseEvent(method+"Begin",[this,args]);},_raiseEndEvents:function(method,result,args){this._raiseEvent("requestEnd",[this,args]);this._raiseEvent("request"+result,[this,args]);this._raiseEvent(method+"End",[this,args]);this._raiseEvent(method+result,[this,args]);},addRequestBegin:function(handler){this._addEvent("requestBegin",handler);},addRequestEnd:function(handler){this._addEvent("requestEnd",handler);},addRequestSuccess:function(handler){this._addEvent("requestSuccess",handler);},addRequestFailed:function(handler){this._addEvent("requestFailed",handler);},raiseServerEvent:function ServerSync$raiseServerEvent(name,obj,event,includeAllChanges,success,failed,paths){pendingRequests++;Sys.Observer.setValue(this,"PendingServerEvent",true);var args={eventTarget:obj,eventName:name,eventRaised:event,includeAllChanges:includeAllChanges};this._raiseBeginEvents("raiseServerEvent",args);if(event===undefined||event===null){event={};}
for(var key in event){var arg=event[key];if(arg instanceof Array){for(var i=0;i<arg.length;++i){arg[i]=toExoGraph(this._translator,arg[i]);}}
else{event[key]=toExoGraph(this._translator,arg);}}
eventProvider(name,toExoGraph(this._translator,obj),event,paths,serializeChanges.call(this,includeAllChanges,obj),this._onRaiseServerEventSuccess.bind(this).appendArguments(args,success),this._onRaiseServerEventFailed.bind(this).appendArguments(args,failed||success));},_onRaiseServerEventSuccess:function ServerSync$_onRaiseServerEventSuccess(result,args,callback){Sys.Observer.setValue(this,"PendingServerEvent",false);args.responseObject=result;this._handleResult(result,args.name,function(){var event=result.events[0];if(event instanceof Array){for(var i=0;i<event.length;++i){event[i]=fromExoGraph(event[i],this._translator);}}
else{event=fromExoGraph(event,this._translator);}
restoreDates(event);result.event=event;args.eventResponse=event;this._raiseEndEvents("raiseServerEvent","Success",args);if(callback&&callback instanceof Function)
callback.call(this,result);pendingRequests--;});},_onRaiseServerEventFailed:function ServerSync$_onRaiseServerEventFailed(error,args,callback){Sys.Observer.setValue(this,"PendingServerEvent",false);args.error=error;this._raiseEndEvents("raiseServerEvent","Failed",args);if(callback&&callback instanceof Function)
callback.call(this,error);pendingRequests--;},addRaiseServerEventBegin:function(handler){this._addEvent("raiseServerEventBegin",handler);},addRaiseServerEventEnd:function(handler){this._addEvent("raiseServerEventEnd",handler);},addRaiseServerEventSuccess:function(handler){this._addEvent("raiseServerEventSuccess",handler);},addRaiseServerEventFailed:function(handler){this._addEvent("raiseServerEventFailed",handler);},roundtrip:function ServerSync$roundtrip(success,failed){pendingRequests++;Sys.Observer.setValue(this,"PendingRoundtrip",true);var args={};this._raiseBeginEvents("roundtrip",args);roundtripProvider(serializeChanges.call(this),this._onRoundtripSuccess.bind(this).appendArguments(args,success),this._onRoundtripFailed.bind(this).appendArguments(args,failed||success));},_onRoundtripSuccess:function ServerSync$_onRoundtripSuccess(result,args,callback){Sys.Observer.setValue(this,"PendingRoundtrip",false);args.responseObject=result;this._handleResult(result,"roundtrip",function(){this._raiseEndEvents("roundtrip","Success",args);if(callback&&callback instanceof Function)
callback.call(this,result);pendingRequests--;});},_onRoundtripFailed:function ServerSync$_onRoundtripFailed(error,args,callback){Sys.Observer.setValue(this,"PendingRoundtrip",false);args.error=error;this._raiseEndEvents("roundtrip","Failed",args);if(callback&&callback instanceof Function)
callback.call(this,error);pendingRequests--;},startAutoRoundtrip:function ServerSync$startAutoRoundtrip(interval){this.stopAutoRoundtrip();function doRoundtrip(){this.roundtrip(function(){this._roundtripTimeout=window.setTimeout(doRoundtrip.bind(this),interval);});}
this._roundtripTimeout=window.setTimeout(doRoundtrip.bind(this),interval);},stopAutoRoundtrip:function ServerSync$stopAutoRoundtrip(){if(this._roundtripTimeout){window.clearTimeout(this._roundtripTimeout);}},save:function ServerSync$save(root,success,failed){pendingRequests++;Sys.Observer.setValue(this,"PendingSave",true);var args={root:root};this._raiseBeginEvents("save",args);saveProvider(toExoGraph(this._translator,root),serializeChanges.call(this,true,root),this._onSaveSuccess.bind(this).appendArguments(args,success),this._onSaveFailed.bind(this).appendArguments(args,failed||success));},_onSaveSuccess:function ServerSync$_onSaveSuccess(result,args,callback){Sys.Observer.setValue(this,"PendingSave",false);args.responseObject=result;this._handleResult(result,"save",function(){this._raiseEndEvents("save","Success",args);if(callback&&callback instanceof Function)
callback.call(this,result);pendingRequests--;});},_onSaveFailed:function(error,args,callback){Sys.Observer.setValue(this,"PendingSave",false);args.error=error;this._raiseEndEvents("save","Failed",args);if(callback&&callback instanceof Function)
callback.call(this,error);pendingRequests--;},startAutoSave:function ServerSync$startAutoSave(root,interval){this.stopAutoSave();this._saveInterval=interval;this._saveRoot=root;},stopAutoSave:function ServerSync$stopAutoSave(){if(this._saveTimeout){window.clearTimeout(this._saveTimeout);this._saveTimeout=null;}
this._saveInterval=null;this._saveRoot=null;},_queueAutoSave:function ServerSync$_queueAutoSave(){if(this._saveTimeout)
return;function doAutoSave(){this.save(this._saveRoot,function ServerSync$doAutoSave$callback(){this._saveTimeout=null;});}
this._saveTimeout=window.setTimeout(doAutoSave.bind(this),this._saveInterval);},addSaveBegin:function(handler){this._addEvent("saveBegin",handler);},addSaveEnd:function(handler){this._addEvent("saveEnd",handler);},addSaveSuccess:function(handler){this._addEvent("saveSuccess",handler);},addSaveFailed:function(handler){this._addEvent("saveFailed",handler);},rollback:function ServerSync$rollback(steps,callback){var depth=0;try{this.beginApplyingChanges();var signal=new ExoWeb.Signal("ServerSync.rollback");function processNextChange(){var change=null;if(steps===undefined||depth<steps){change=this._changeLog.undo();depth++;}
if(change){var callback=signal.pending(processNextChange,this);if(change.type=="InitNew"){this.rollbackInitChange(change,callback);}
else if(change.type=="ReferenceChange"){this.rollbackRefChange(change,callback);}
else if(change.type=="ValueChange"){this.rollbackValChange(change,callback);}
else if(change.type=="ListChange"){this.rollbackListChange(change,callback);}}}
processNextChange.call(this);signal.waitForAll(function(){this.endApplyingChanges();if(callback&&callback instanceof Function){callback();}
Sys.Observer.raisePropertyChanged(this,"HasPendingChanges");},this);}
catch(e){this.endApplyingChanges();ExoWeb.trace.throwAndLog(["server"],e);}},rollbackValChange:function ServerSync$rollbackValChange(change,callback){var obj=fromExoGraph(change.instance,this._translator);Sys.Observer.setValue(obj,change.property,change.oldValue);callback();},rollbackRefChange:function ServerSync$rollbackRefChange(change,callback){var obj=fromExoGraph(change.instance,this._translator);var ref=fromExoGraph(change.oldValue,this._translator);Sys.Observer.setValue(obj,change.property,ref);callback();},rollbackInitChange:function ServerSync$rollbackInitChange(change,callback){delete change.instance;callback();},rollbackListChange:function ServerSync$rollbackListChange(change,callback){var obj=fromExoGraph(change.instance,this._translator);var prop=obj.meta.property(change.property,true);var list=prop.value(obj);var translator=this._translator;list.beginUpdate();Array.forEach(change.added,function ServerSync$rollbackListChanges$added(item){var childObj=fromExoGraph(item,translator);list.remove(childObj);});Array.forEach(change.removed,function ServerSync$rollbackListChanges$added(item){var childObj=fromExoGraph(item,translator);list.add(childObj);});list.endUpdate();callback();},_captureChange:function ServerSync$_captureChange(change){if(!this.isApplyingChanges()&&this.isCapturingChanges()){this._changeLog.add(change);Sys.Observer.raisePropertyChanged(this,"HasPendingChanges");if(this._saveInterval)
this._queueAutoSave();}},get_Changes:function ServerSync$get_Changes(includeAllChanges){if(arguments.length<2||arguments[1]!==true){ExoWeb.trace.logWarning("server","Method get_Changes is not intended for long-term use - it will be removed in the near future.");}
var list=[];var sets=this._changeLog.serialize(includeAllChanges?null:this.canSave,this);sets.forEach(function(set){list.addRange(set.changes);});return list;},get_HasPendingChanges:function ServerSync$get_HasPendingChanges(){return this._changeLog.sets().some(function(set){return set.changes().some(function(change){return this.canSave(change);},this);},this);},get_PendingAction:function ServerSync$get_PendingAction(){return this._pendingServerEvent||this._pendingRoundtrip||this._pendingSave;},get_PendingServerEvent:function ServerSync$get_PendingServerEvent(){return this._pendingServerEvent;},set_PendingServerEvent:function ServerSync$set_PendingServerEvent(value){var oldValue=this._pendingServerEvent;this._pendingServerEvent=value;if(oldValue!==value){Sys.Observer.raisePropertyChanged(this,"PendingAction");}},get_PendingRoundtrip:function ServerSync$get_PendingRoundtrip(){return this._pendingRoundtrip;},set_PendingRoundtrip:function ServerSync$set_PendingRoundtrip(value){var oldValue=this._pendingRoundtrip;this._pendingRoundtrip=value;if(oldValue!==value){Sys.Observer.raisePropertyChanged(this,"PendingAction");}},get_PendingSave:function ServerSync$get_PendingSave(){return this._pendingSave;},set_PendingSave:function ServerSync$set_PendingSave(value){var oldValue=this._pendingSave;this._pendingSave=value;if(oldValue!==value){Sys.Observer.raisePropertyChanged(this,"PendingAction");}}});ExoWeb.Mapper.ServerSync=ServerSync;ServerSync.Roundtrip=function ServerSync$Roundtrip(root,success,failed){if(root instanceof ExoWeb.Model.Entity){root=root.meta.type.get_model();}
if(root instanceof ExoWeb.Model.Model){if(root._server){if(!root._server.isApplyingChanges()){root._server.roundtrip(success,failed);}}
else{ExoWeb.trace.logWarning("server","Unable to perform roundtrip:  root is not a model or entity.");}}};ServerSync.Save=function ServerSync$Save(root,success,failed){var model;if(root instanceof ExoWeb.Model.Entity){model=root.meta.type.get_model();}
if(model&&model instanceof ExoWeb.Model.Model){if(model._server){model._server.save(root,success,failed);}
else{}}};function TriggerRoundtripRule(property){var prop=this.prop=property;ExoWeb.Model.Rule.register(this,[property],true);}
TriggerRoundtripRule.prototype={execute:function(obj,callback){ServerSync.Roundtrip(obj,callback,callback);},toString:function(){return"trigger roundtrip";}};ExoWeb.Mapper.TriggerRoundtripRule=ExoWeb.Model.Rule.triggerRoundtrip=TriggerRoundtripRule;ExoWeb.Model.Property.mixin({triggersRoundtrip:function(){if(!this._triggersRoundtrip){var rule=new TriggerRoundtripRule(this);this._triggersRoundtrip=true;}}});var STATIC_ID="static";function ensureJsType(model,typeName,callback,thisPtr){var mtype=model.type(typeName);if(!mtype){fetchType(model,typeName,function(jstype){callback.apply(thisPtr||this,[jstype]);});}
else if(!ExoWeb.Model.LazyLoader.isLoaded(mtype)){ExoWeb.Model.LazyLoader.load(mtype,null,function(jstype){callback.apply(thisPtr||this,[jstype]);});}
else{callback.apply(thisPtr||this,[mtype.get_jstype()]);}}
function conditionsFromJson(model,json,callback,thisPtr){var signal=new Signal("conditionsFromJson");for(var code in json){conditionFromJson(model,code,json[code],signal.pending());}
signal.waitForAll(function(){if(callback&&callback instanceof Function){callback.call(thisPtr||this);}});}
function conditionFromJson(model,code,json,callback,thisPtr){var type=ExoWeb.Model.ConditionType.get(code);if(!type){ExoWeb.trace.logWarning(["server","conditions"],"A condition type with code \"{0}\" could not be found.",[code]);callback.call(thisPtr||this);return;}
var signal=new Signal("conditionFromJson - "+code);var serverSync=model._server;json.forEach(function(condition){var conditionObj=null;condition.targets.forEach(function(target){tryGetJsType(serverSync._model,target.instance.type,null,false,function(jstype){tryGetEntity(serverSync._model,serverSync._translator,jstype,target.instance.id,null,LazyLoadEnum.None,function(inst){var propsSignal=new Signal("conditionFromJson.properties");var props=[];distinct(target.properties).forEach(function(p,i){Model.property("this."+p,inst.meta.type,true,propsSignal.pending(function(chain){props[i]=chain;}));});propsSignal.waitForAll(signal.pending(function(){if(!conditionObj){conditionObj=new ExoWeb.Model.Condition(type,condition.message?condition.message:type.get_message(),props);}
else{conditionObj.get_properties().addRange(props);}
inst.meta.conditionIf(conditionObj,true);}));});});});});signal.waitForAll(function(){if(callback&&callback instanceof Function){callback.call(thisPtr||this);}});}
function objectsFromJson(model,json,callback,thisPtr){var signal=new ExoWeb.Signal("objectsFromJson");try{for(var typeName in json){var poolJson=json[typeName];for(var id in poolJson){objectFromJson(model,typeName,id,poolJson[id],signal.pending(),thisPtr);}}}
finally{signal.waitForAll(function(){callback.apply(thisPtr||this,arguments);});}}
function objectFromJson(model,typeName,id,json,callback,thisPtr){var obj;var mtype=model.type(typeName);if(!mtype){fetchType(model,typeName,function(){objectFromJson(model,typeName,id,json,callback);});return;}
if(!ExoWeb.Model.LazyLoader.isLoaded(mtype)){ExoWeb.Model.LazyLoader.load(mtype,null,function(){objectFromJson(model,typeName,id,json,callback,thisPtr);});return;}
if(id===STATIC_ID){obj=null;}
else{obj=getObject(model,typeName,id,null,true);}
var loadedProperties=[];for(var t=mtype;t!==null;t=t.baseType){var props=obj?t.get_instanceProperties():t.get_staticProperties();for(var propName in props){if(loadedProperties.contains(propName))
continue;loadedProperties.push(propName);var prop=props[propName];if(!prop){ExoWeb.trace.throwAndLog(["objectInit"],"Cannot load object {0}({2}) because it has an unexpected property '{1}'",[typeName,propName,id]);}
if(prop.get_origin()!=="server")
continue;var propData;if(obj){propData=json[prop.get_index()];}
else{propData=json[propName];if(propData===undefined)
continue;}
if(propData===null){prop.init(obj,null);}
else{var propType=prop.get_jstype();if(prop.get_isList()){var list=prop.value(obj);if(propData=="?"){if(!list){list=ListLazyLoader.register(obj,prop);prop.init(obj,list,false);}}
else{if(!list||!ExoWeb.Model.LazyLoader.isLoaded(list)){var doInit=undefined;if(list){ListLazyLoader.unregister(list);doInit=false;}
else{list=[];doInit=true;}
for(var i=0;i<propData.length;i++){var ref=propData[i];list.push(getObject(model,propType,(ref&&ref.id||ref),(ref&&ref.type||propType)));}
if(doInit){prop.init(obj,list);}}}}
else{var ctor=prop.get_jstype(true);if(!ctor||ctor.meta){prop.init(obj,getObject(model,propType,(propData&&propData.id||propData),(propData&&propData.type||propType)));}
else{if(ctor==Date&&propData&&propData.constructor==String&&propData.length>0){propData=propData.replace(dateRegex,dateRegexReplace);propData=new Date(propData);}
prop.init(obj,propData);}}}}}
if(obj){ObjectLazyLoader.unregister(obj);}
if(callback&&callback instanceof Function){callback(thisPtr||this);}}
function typesFromJson(model,json){for(var typeName in json){typeFromJson(model,typeName,json[typeName]);}}
function typeFromJson(model,typeName,json){var mtype=getType(model,typeName,json.baseType,true);for(var propName in json.properties){var propJson=json.properties[propName];var propType=propJson.type;if(propJson.type.endsWith("[]"))
{propType=propType.toString().substring(0,propType.length-2);propJson.isList=true;}
propType=getJsType(model,propType);var format=(propJson.format&&propType.formats)?propType.formats[propJson.format]:null;var prop=mtype.addProperty({name:propName,type:propType,isList:propJson.isList,label:propJson.label,format:format,isStatic:propJson.isStatic,index:propJson.index});if(propJson.isStatic){if(propJson.isList){prop.init(null,ListLazyLoader.register(null,prop));}}
if(propJson.rules){for(var i=0;i<propJson.rules.length;++i){ruleFromJson(propJson.rules[i],prop);}}}
mtype.set_originForNewProperties("client");for(var methodName in json.methods){var methodJson=json.methods[methodName];mtype.addMethod({name:methodName,parameters:methodJson.parameters,isStatic:methodJson.isStatic});}
if(json.conditionTypes)
conditionTypesFromJson(model,mtype,json.conditionTypes);}
function conditionTypesFromJson(model,mtype,json){for(var code in json){conditionTypeFromJson(model,mtype,code,json[code]);}}
function conditionTypeFromJson(model,mtype,code,json){var conditionType=ExoWeb.Model.ConditionType.get(code);if(!conditionType){var sets=!json.sets?[]:json.sets.map(function(name){var set=ExoWeb.Model.ConditionTypeSet.get(name);if(!set){set=new ExoWeb.Model.ConditionTypeSet(name);}
return set;});if(json.category=="Error"){conditionType=new ExoWeb.Model.ConditionType.Error(code,json.message,sets);}
else if(json.category=="Warning"){conditionType=new ExoWeb.Model.ConditionType.Warning(code,json.message,sets);}
else if(json.category=="Permission"){conditionType=new ExoWeb.Model.ConditionType.Permission(code,json.message,sets,json.permissionType,json.isAllowed);}
else{conditionType=new ExoWeb.Model.ConditionType(code,json.category,json.message,sets);}
conditionType.extend(json);}
if(json.rule&&json.rule.hasOwnProperty("type")){var ruleType=ExoWeb.Model.Rule[json.rule.type];var rule=new ruleType(mtype,json.rule,conditionType);conditionType.get_rules().push(rule);}}
function getJsType(model,typeName,forLoading){var family=typeName.split(">");var jstype=ExoWeb.Model.Model.getJsType(family[0],true);if(jstype===undefined){jstype=getType(model,null,family,forLoading).get_jstype();}
return jstype;}
function flattenTypes(types,flattened){function add(item){if(flattened.indexOf(item)<0){flattened.push(item);}}
if(types instanceof Array){Array.forEach(types,add);}
else if(typeof(types)==="string"){Array.forEach(types.split(">"),add);}
else if(types){add(types);}}
function getType(model,finalType,propType){var family=[];flattenTypes(finalType,family);flattenTypes(propType,family);var mtype;var baseType;while(family.length>0){baseType=mtype;var type=family.pop();if(type instanceof ExoWeb.Model.Type){mtype=type;}
else if(type.meta){mtype=type.meta;}
else{mtype=model.type(type);if(!mtype){mtype=model.addType(type,baseType,"server");TypeLazyLoader.register(mtype);}}}
return mtype;}
function getObject(model,propType,id,finalType,forLoading){if(id===STATIC_ID){ExoWeb.trace.throwAndLog(["objectInit","lazyLoad"],"getObject() can only be called for instances (id='{0}')",[id]);}
var mtype=getType(model,finalType,propType);var obj=mtype.get(id);if(!obj){obj=new(mtype.get_jstype())(id);if(!forLoading){ObjectLazyLoader.register(obj);}}
return obj;}
function fetchTypeImpl(model,typeName,callback,thisPtr){var signal=new ExoWeb.Signal("fetchType("+typeName+")");var errorObj;function success(result){typesFromJson(model,result.types);model.type(typeName).eachBaseType(function(mtype){if(!ExoWeb.Model.LazyLoader.isLoaded(mtype)){ExoWeb.Model.LazyLoader.load(mtype,null,signal.pending());}});}
function error(error){errorObj=error;}
typeProvider(typeName,signal.pending(success),signal.orPending(error));signal.waitForAll(function(){if(errorObj!==undefined){ExoWeb.trace.throwAndLog("typeInit","Failed to load {typeName} (HTTP: {error._statusCode}, Timeout: {error._timedOut})",{typeName:typeName,error:errorObj});}
var mtype=model.type(typeName);TypeLazyLoader.unregister(mtype);raiseExtensions(mtype);if(callback&&callback instanceof Function){callback.call(thisPtr||this,mtype.get_jstype());}});}
var fetchType=fetchTypeImpl.dontDoubleUp({callbackArg:2,thisPtrArg:3});function fetchPathTypes(model,jstype,path,callback){var step=Array.dequeue(path.steps);while(step){var prop=jstype.meta.property(step.property,true);if(!prop){ExoWeb.trace.throwAndLog("typeInit","Could not find property \"{0}\" on type \"{1}\".",[step.property,jstype.meta.get_fullName()]);}
if(prop.get_isValueType()){break;}
var mtype;if(step.cast){mtype=model.type(step.cast);if(!mtype){Array.insert(path.steps,0,step);fetchType(model,step.cast,function(){fetchPathTypes(model,jstype,path,callback);});return;}}
else{mtype=prop.get_jstype().meta;}
if(!ExoWeb.Model.LazyLoader.isLoaded(mtype)){fetchType(model,mtype.get_fullName(),function(jstype){fetchPathTypes(model,jstype,path,callback);});return;}
jstype=mtype.get_jstype();step=Array.dequeue(path.steps);}
if(callback&&callback instanceof Function){callback();}}
function fetchTypes(model,typeName,paths,callback){var signal=new ExoWeb.Signal("fetchTypes");function rootTypeLoaded(jstype){if(paths){Array.forEach(paths,function(path){if(path.steps[0].property==="this"){var step=Array.dequeue(path.steps);var mtype=jstype.meta;var fetchRootTypePaths=function fetchRootTypePaths(){fetchPathTypes(model,mtype.get_jstype(),path,signal.pending());};if(step.cast){mtype=model.type(step.cast);if(!mtype){fetchType(model,step.cast,signal.pending(function(){mtype=model.type(step.cast);fetchRootTypePaths();}));}
else{fetchRootTypePaths();}}
else{fetchRootTypePaths();}}
else{var step=null,typeName="";while(path.steps.length>1){step=Array.dequeue(path.steps);typeName+=(typeName.length>0?".":"")+step.property;}
var mtype=model.type(typeName);var fetchStaticPathTypes=function fetchStaticPathTypes(){fetchPathTypes(model,(mtype||model.type(typeName)).get_jstype(),path,signal.pending());};if(!mtype){fetchType(model,typeName,signal.pending(fetchStaticPathTypes));}
else if(!ExoWeb.Model.LazyLoader.isLoaded(mtype)){ExoWeb.Model.LazyLoader.load(mtype,null,signal.pending(fetchStaticPathTypes));}
else{fetchStaticPathTypes();}}});}}
var rootType=model.type(typeName);if(!rootType){fetchType(model,typeName,signal.pending(rootTypeLoaded));}
else if(!ExoWeb.Model.LazyLoader.isLoaded(rootType)){ExoWeb.Model.LazyLoader.load(rootType,null,signal.pending(rootTypeLoaded));}
else{rootTypeLoaded(rootType.get_jstype());}
signal.waitForAll(callback);}
function ruleFromJson(rulesJson,prop){for(var name in rulesJson){var json=rulesJson[name];var ruleType=ExoWeb.Model.Rule[json.type];var rule=new ruleType(json,[prop]);}}
var dateRegex=/^(\d{4})-(\d{2})-(\d{2})T(\d{2})\:(\d{2})\:(\d{2})(\.\d{3})?Z$/g;var dateRegexReplace="$2/$3/$1 $4:$5:$6 GMT";function restoreDates(value){if(value instanceof Array){for(var i=0;i<value.length;i++)
{var element=value[i];if(element&&element.constructor==String&&dateRegex.test(element)){dateRegex.lastIndex=0;element=element.replace(dateRegex,dateRegexReplace);value[i]=new Date(element);}}}
else if(value instanceof Object){for(var field in value){if(value.hasOwnProperty(field)){var element=value[field];if(element&&element.constructor==String&&dateRegex.test(element)){dateRegex.lastIndex=0;element=element.replace(dateRegex,dateRegexReplace);value[field]=new Date(element);}}}}}
function tryGetJsType(model,name,property,forceLoad,callback,thisPtr){var jstype=ExoWeb.Model.Model.getJsType(name,true);if(jstype&&ExoWeb.Model.LazyLoader.isLoaded(jstype.meta)){callback.call(thisPtr||this,jstype);}
else if(jstype&&forceLoad){ExoWeb.Model.LazyLoader.load(jstype.meta,property,callback,thisPtr);}
else if(!jstype&&forceLoad){ensureJsType(model,name,callback,thisPtr);}
else{$extend(name,function(){callback.apply(this,arguments);},thisPtr);}}
var LazyLoadEnum={None:0,Force:1,ForceAndWait:2};function tryGetEntity(model,translator,type,id,property,lazyLoad,callback,thisPtr){var obj=type.meta.get(translateId(translator,type.meta.get_fullName(),id));if(obj&&ExoWeb.Model.LazyLoader.isLoaded(obj)){callback.call(thisPtr||this,obj);}
else if(lazyLoad==LazyLoadEnum.Force){if(!obj){ExoWeb.trace.log("server","Forcing creation of object \"{0}|{1}\".",[type.meta.get_fullName(),id]);obj=fromExoGraph({type:type.meta.get_fullName(),id:id},translator);}
callback.call(thisPtr||this,obj);ExoWeb.trace.log("server","Forcing lazy loading of object \"{0}|{1}\".",[type.meta.get_fullName(),id]);ExoWeb.Model.LazyLoader.load(obj,property);}
else if(lazyLoad==LazyLoadEnum.ForceAndWait){if(!obj){ExoWeb.trace.log("server","Forcing creation of object \"{0}|{1}\".",[type.meta.get_fullName(),id]);obj=fromExoGraph({type:type.meta.get_fullName(),id:id},translator);}
ExoWeb.trace.log("server","Forcing lazy loading of object \"{0}|{1}\".",[type.meta.get_fullName(),id]);ExoWeb.Model.LazyLoader.load(obj,property,thisPtr?callback.bind(thisPtr):callback);}
else{ExoWeb.trace.log("server","Waiting for existance of object \"{0}|{1}\".",[type.meta.get_fullName(),id]);function invokeCallback(){if(filter(obj)!==true)
return;propertyFilter=function(){return false;};callback.call(thisPtr||this,obj);}
var objSignal=new Signal("wait for object to exist");if(!obj){model.addObjectRegistered(objSignal.pending(null,null,true),function(newObj){if(newObj.meta.type===type.meta&&newObj.meta.id===id){obj=newObj;return true;}},true);}
objSignal.waitForAll(function(){if(property&&type.meta.property(property,true).isInited(obj)!==true){type.meta.property(property,true).addChanged(callback.bind(thisPtr),obj,true);return;}
callback.call(thisPtr||this,obj);},null,true);}}
function TypeLazyLoader(){}
function typeLoad(mtype,propName,callback,thisPtr){fetchType(mtype.get_model(),mtype.get_fullName(),callback,thisPtr);}
TypeLazyLoader.mixin({load:typeLoad.dontDoubleUp({callbackArg:2,thisPtrArg:3,groupBy:function(mtype){return[mtype];}})});(function(){var instance=new TypeLazyLoader();TypeLazyLoader.register=function(obj){ExoWeb.Model.LazyLoader.register(obj,instance);};TypeLazyLoader.unregister=function(obj){ExoWeb.Model.LazyLoader.unregister(obj,instance);};})();function ObjectLazyLoader(){this._requests={};this._typePaths={};}
var pendingObjects=0;ExoWeb.registerActivity(function(){return pendingObjects>0;});function objLoad(obj,propName,callback,thisPtr){pendingObjects++;var signal=new ExoWeb.Signal("object lazy loader");var id=obj.meta.id||STATIC_ID;var mtype=obj.meta.type||obj.meta;var paths=ObjectLazyLoader.getRelativePaths(obj);if(propName&&paths.indexOf("this."+propName)<0){paths.push("this."+propName);}
ExoWeb.trace.log(["objectInit","lazyLoad"],"Lazy load: {0}({1})",[mtype.get_fullName(),id]);objectProvider(mtype.get_fullName(),[id],paths,false,serializeChanges.call(context.server,true),function(result){mtype.get_model()._server._handleResult(result,null,function(){ExoWeb.Model.LazyLoader.unregister(obj,this);pendingObjects--;callback.call(thisPtr||this,obj);});},function(e){pendingObjects--;var message=$format("Failed to load {0}({1}): ",[mtype.get_fullName(),id]);if(e!==undefined&&e!==null&&e.get_message!==undefined&&e.get_message!==null&&e.get_message instanceof Function){message+=e.get_message();}
else{message+="unknown error";}
ExoWeb.trace.logError("lazyLoad",message);});if(!ExoWeb.Model.LazyLoader.isLoaded(mtype)){ExoWeb.Model.LazyLoader.load(mtype,null,signal.pending());}}
ObjectLazyLoader.mixin({load:objLoad.dontDoubleUp({callbackArg:2,thisPtrArg:3,groupBy:function(obj){return[obj];}})});(function(){var instance=new ObjectLazyLoader();ObjectLazyLoader.addPaths=function ObjectLazyLoader$addPaths(rootType,paths){var typePaths=instance._typePaths[rootType];if(!typePaths){typePaths=instance._typePaths[rootType]=[];}
for(var i=0;i<paths.length;i++){var path=paths[i];if(typePaths.indexOf(path)<0){typePaths.push(path);}}};ObjectLazyLoader.getRelativePaths=function getRelativePaths(obj){return ObjectLazyLoader.getRelativePathsForType(obj.meta.type);};ObjectLazyLoader.getRelativePathsForType=function getRelativePathsForType(type){var relPaths=[];for(var typeName in instance._typePaths){var jstype=ExoWeb.Model.Model.getJsType(typeName);if(jstype&&jstype.meta){var paths=instance._typePaths[typeName];for(var i=0;i<paths.length;i++){var path=paths[i].expression;var chain=ExoWeb.Model.Model.property(path,jstype.meta);if(!chain.get_isStatic()){var rootedPath=chain.rootedPath(type);if(rootedPath){relPaths.push(rootedPath);}}}}}
return relPaths;};ObjectLazyLoader.register=function(obj){if(!ExoWeb.Model.LazyLoader.isRegistered(obj,instance)){ExoWeb.Model.LazyLoader.register(obj,instance);}};ObjectLazyLoader.unregister=function(obj){ExoWeb.Model.LazyLoader.unregister(obj,instance);};})();function ListLazyLoader(){}
function listLoad(list,propName,callback,thisPtr){var signal=new ExoWeb.Signal("list lazy loader");var model=list._ownerProperty.get_containingType().get_model();var ownerId=list._ownerId;var ownerType=list._ownerProperty.get_containingType().get_fullName();var prop=list._ownerProperty;var propIndex=list._ownerProperty.get_index();var propName=list._ownerProperty.get_name();var propType=list._ownerProperty.get_jstype().meta;ExoWeb.trace.log(["listInit","lazyLoad"],"Lazy load: {0}({1}).{2}",[ownerType,ownerId,propName]);var objectJson,conditionsJson;listProvider(ownerType,list._ownerId,propName,list._ownerId===STATIC_ID?[]:ObjectLazyLoader.getRelativePathsForType(propType),serializeChanges.call(context.server,true),signal.pending(function(result){objectJson=result.instances;conditionsJson=result.conditions;}),signal.orPending(function(e){var message=$format("Failed to load {0}({1}).{2}: ",[ownerType,ownerId,propName]);if(e!==undefined&&e!==null&&e.get_message!==undefined&&e.get_message!==null&&e.get_message instanceof Function){message+=e.get_message();}
else{message+="unknown error";}
ExoWeb.trace.logError("lazyLoad",message);}));if(!ExoWeb.Model.LazyLoader.isLoaded(propType)){ExoWeb.Model.LazyLoader.load(propType,null,signal.pending());}
signal.waitForAll(function(){if(!objectJson){return;}
var jsonId=ownerId;var jsonType=ownerType;function searchJson(mtype,id){if(objectJson[mtype.get_fullName()]){if(objectJson[mtype.get_fullName()][id]){jsonType=mtype.get_fullName();jsonId=id;return true;}
for(var varId in objectJson[mtype.get_fullName()]){if(varId.toLowerCase()==id.toLowerCase()){jsonType=mtype.get_fullName();jsonId=varId;return true;}}}
for(var i=0;i<mtype.derivedTypes.length;i++){if(searchJson(mtype.derivedTypes[i],id)){return true;}}}
if(!searchJson(ExoWeb.Model.Model.getJsType(ownerType).meta,ownerId)){ExoWeb.trace.throwAndLog(["list","lazyLoad"],"Data could not be found for {0}:{1}.",[ownerType,ownerId]);}
var listJson=list._ownerProperty.get_isStatic()?objectJson[jsonType][jsonId][propName]:objectJson[jsonType][jsonId][propIndex];for(var i=0;i<listJson.length;i++){var ref=listJson[i];var item=getObject(model,propType,(ref&&ref.id||ref),(ref&&ref.type||propType));list.push(item);if(ExoWeb.Model.LazyLoader.isLoaded(item)){delete objectJson[jsonType][ref.id];}}
var owner=ownerId===STATIC_ID?propType.get_jstype():getObject(model,ownerType,ownerId,null);if(ExoWeb.Model.LazyLoader.isLoaded(owner)){delete objectJson[jsonType][jsonId];}
ListLazyLoader.unregister(list,this);var batch=ExoWeb.Batch.start($format("{0}({1}).{2}",[ownerType,ownerId,propName]));var done=function(){prop._raiseEvent("changed",[owner,{property:prop,newValue:list,oldValue:undefined,wasInited:true,collectionChanged:true}]);ExoWeb.Batch.end(batch);callback.call(thisPtr||this,list);}
objectsFromJson(model,objectJson,function(){if(conditionsJson){conditionsFromJson(model,conditionsJson,done);}
else{done();}});});}
ListLazyLoader.mixin({load:listLoad.dontDoubleUp({callbackArg:2,thisPtrArg:3,groupBy:function(list){return[list];}})});(function(){var instance=new ListLazyLoader();ListLazyLoader.register=function(obj,prop){var list=[];list._ownerId=prop.get_isStatic()?STATIC_ID:obj.meta.id;list._ownerProperty=prop;ExoWeb.Model.LazyLoader.register(list,instance);return list;};ListLazyLoader.unregister=function(list){ExoWeb.Model.LazyLoader.unregister(list,instance);delete list._ownerId;delete list._ownerType;delete list._ownerProperty;};})();var allSignals=new ExoWeb.Signal("createContext allSignals");ExoWeb.registerActivity(function(){return allSignals.isActive();});function Context(){var model=new ExoWeb.Model.Model();this.model={meta:model};this.server=new ServerSync(model);this._addEvent("beforeModel",this.server.beginCapturingChanges.bind(this.server),null,true);}
Context.mixin(ExoWeb.Functor.eventing);Context.mixin({isModelReady:function(){var result=false;eachProp(this.model,function(prop,val){if(prop!="meta"){result=true;return false;}},this);return result;},addModelReady:function Context$ready(callback,thisPtr){this._addEvent("modelReady",thisPtr?callback.bind(thisPtr):callback,null,true);if(this.isModelReady())
this.onModelReady();},onModelReady:function(){allSignals.waitForAll(function(){this._raiseEvent("modelReady");},this);},onBeforeModel:function(){this._raiseEvent("beforeModel");}});function Context$query(options){var contextQuery=new ContextQuery(this,options);contextQuery.execute(options.model?this.onModelReady.bind(this):null);}
function ContextQuery(context,options){this.context=context;this.options=options;this.batch=null;this.state={};}
ContextQuery.mixin({execute:ExoWeb.FunctionChain.prepare(function ContextQuery$setup(callback,thisPtr){ExoWeb.trace.log("context","Starting context query batch.");this.batch=ExoWeb.Batch.start("context query");if(this.options.changes)
ServerSync$storeInitChanges.call(this.context.server,this.options.changes);callback.call(thisPtr||this);},function ContextQuery$initModels(callback,thisPtr){if(this.options.model){this.context.onBeforeModel();ExoWeb.trace.log("context","Running init step for model queries.");ExoWeb.eachProp(this.options.model,function(varName,query){if(!query.hasOwnProperty("from")||(!query.hasOwnProperty("id")&&!query.hasOwnProperty("ids")))
ExoWeb.trace.throwAndLog("types","The model query \"{0}\" requires a from and id or ids clause.",[varName]);if(query.hasOwnProperty("id")&&query.hasOwnProperty("ids"))
ExoWeb.trace.throwAndLog("types","The model query \"{0}\" specifies both id or ids.",[varName]);this.state[varName]={signal:new ExoWeb.Signal("createContext."+varName),isArray:false};allSignals.pending(null,this,true);if(query.hasOwnProperty("ids")&&!(query.ids instanceof Array)){query.ids=[query.ids];}
else if(query.hasOwnProperty("id")&&!(query.id instanceof Array)){query.ids=[query.id];delete query.id;}
else{this.state[varName].isArray=true;var arr=[];Sys.Observer.makeObservable(arr);this.context.model[varName]=arr;}
query.ids=filter(query.ids,not(isNullOrEmpty));query.newIds=purge(query.ids,equals($newId()));query.normalized=ExoWeb.Model.PathTokens.normalizePaths(query.include);ObjectLazyLoader.addPaths(query.from,query.normalized);if(query.inScope!==false){if(query.ids.length>0){this.state[varName].scopeQuery={from:query.from,ids:query.ids,include:query.include?query.include.filter(function(p){return p.startsWith("this.");}):[],inScope:true,forLoad:false};}}},this);}
callback.call(thisPtr||this);},function ContextQuery$processEmbedded(callback,thisPtr){ExoWeb.trace.log("context","Processing embedded data in query.");if(this.options.instances||this.options.conditions||(this.options.types&&!(this.options.types instanceof Array))){var handler=new ResponseHandler(this.context.model.meta,this.context.server,{instances:this.options.instances,conditions:this.options.conditions,types:this.options.types});handler.execute(callback,thisPtr);}
else{callback.call(thisPtr||this);}},function ContextQuery$doBatchRequest(callback,thisPtr){if(this.options.model&&ExoWeb.config.individualQueryLoading!==true){var pendingQueries=[];var batchQuerySignal;ExoWeb.trace.log("context","Looking for potential loading requests in query.");ExoWeb.eachProp(this.options.model,function(varName,query){if(!query.load&&query.ids.length>0){var jstype=ExoWeb.Model.Model.getJsType(query.from,true);var batchIds=filter(query.ids,function(id,index){if(!jstype)return true;var obj=jstype.meta.get(translateId(this.context.server._translator,query.from,id));if(obj===undefined)return true;if(this.state[varName].isArray){this.context.model[varName][index]=obj;}
else{this.context.model[varName]=obj;}},this);if(batchIds.length>0){if(batchQuerySignal===undefined){batchQuerySignal=new ExoWeb.Signal("batch query");batchQuerySignal.pending(null,this,true);}
batchQuerySignal.waitForAll(this.state[varName].signal.pending(null,this,true),this,true);pendingQueries.push({from:query.from,ids:batchIds,include:query.include||[],inScope:true,forLoad:true});}}},this);if(pendingQueries.length>0){queryProvider(pendingQueries,null,function context$objects$callback(result){objectsFromJson(this.context.model.meta,result.instances,function(){if(result.conditions){conditionsFromJson(this.context.model.meta,result.conditions,function(){batchQuerySignal.oneDone();});}
else{batchQuerySignal.oneDone();}},this);},function context$objects$callback(error){ExoWeb.trace.logError("objectInit","Failed to load batch query (HTTP: {_statusCode}, Timeout: {_timedOut})",error);batchQuerySignal.oneDone();},this);}}
callback.call(thisPtr||this);},function ContextQuery$doIndividualRequests(callback,thisPtr){if(this.options.model){ExoWeb.eachProp(this.options.model,function(varName,query){if(query.load){this.state[varName].objectJson=query.load.instances;this.state[varName].conditionsJson=query.load.conditions;}
else if(ExoWeb.config.individualQueryLoading===true){tryGetJsType(this.context.model.meta,query.from,null,true,function(type){var individualIds=filter(query.ids,function(id,index){var obj=type.meta.get(translateId(this.context.server._translator,query.from,id));if(obj===undefined)return true;if(this.state[varName].isArray){this.context.model[varName][index]=obj;}
else{this.context.model[varName]=obj;}},this);if(individualIds.length>0){var scopeQueries=[];var currentVarName=varName;ExoWeb.eachProp(this.options.model,function(varName,query){if(varName!==currentVarName&&this.state[varName].scopeQuery){scopeQueries.push(this.state[varName].scopeQuery);}},this);objectProvider(query.from,individualIds,query.include||[],true,null,scopeQueries,this.state[varName].signal.pending(function context$objects$callback(result){this.state[varName].objectJson=result.instances;this.state[varName].conditionsJson=result.conditions;},this,true),this.state[varName].signal.orPending(function context$objects$callback(error){ExoWeb.trace.logError("objectInit","Failed to load {query.from}({query.ids}) (HTTP: {error._statusCode}, Timeout: {error._timedOut})",{query:query,error:error});},this,true),this);}},this);}},this);}
callback.call(thisPtr||this);},function ContextQuery$doStaticRequests(callback,thisPtr){if(this.options.model){ExoWeb.eachProp(this.options.model,function(varName,query){if(!query.load&&query.ids.length===0){var staticPaths=query.include?query.include.filter(function(p){return!p.startsWith("this.");}):null;if(staticPaths&&staticPaths.length>0)
{objectProvider(null,null,staticPaths,false,null,allSignals.pending(function context$objects$callback(result){objectsFromJson(this.context.model.meta,result.instances,allSignals.pending(function(){if(result.conditions){conditionsFromJson(this.context.model.meta,result.conditions,allSignals.pending());}}),this);},this,true),allSignals.orPending(function context$objects$callback(error){ExoWeb.trace.logError("objectInit","Failed to load {query.from}({query.ids}) (HTTP: {error._statusCode}, Timeout: {error._timedOut})",{query:query,error:error});},this,true));}}},this);}
callback.call(thisPtr||this);},function ContextQuery$fetchPathTypes(callback,thisPtr){if(this.options.model&&(!this.options.types||this.options.types instanceof Array)){ExoWeb.eachProp(this.options.model,function(varName,query){fetchTypes(this.context.model.meta,query.from,query.normalized,this.state[varName].signal.pending(null,this,true));},this);}
callback.call(thisPtr||this);},function ContextQuery$processResults(callback,thisPtr){if(this.options.model){ExoWeb.eachProp(this.options.model,function(varName,query){this.state[varName].signal.waitForAll(function context$model(){if(query.newIds)allSignals.pending();if((!this.state[varName].isArray&&this.context.model[varName])||(this.state[varName].isArray&&!query.ids.some(function(id,index){return!this.context.model[varName][index];}))){allSignals.oneDone();return;}
else if(query.ids.length>0){var processResponse=new Signal("processing response");if(this.state[varName].objectJson){objectsFromJson(this.context.model.meta,this.state[varName].objectJson,processResponse.pending(null,this),this,true);delete this.state[varName].objectJson;}
processResponse.waitForAll(this.state[varName].signal.pending(function context$model$callback(){var mtype=this.context.model.meta.type(query.from);if(!mtype){ExoWeb.trace.throwAndLog("context",$format("Could not get type {0} required to process query results.",[query.from]));}
forEach(query.ids,function(id,index){var clientId=translateId(this.context.server._translator,query.from,id);var obj=mtype.get(clientId);if(obj===undefined)
ExoWeb.trace.throwAndLog("context","Could not get {0} with id = {1}{2}.",[query.from,clientId,(id!==clientId?"("+id+")":"")]);if(!this.state[varName].isArray&&!this.context.model[varName]){this.context.model[varName]=obj;}
else if(this.state[varName].isArray&&!this.context.model[varName][index]){this.context.model[varName][index]=obj;}},this);if(this.state[varName].conditionsJson){conditionsFromJson(this.context.model.meta,this.state[varName].conditionsJson,function(){allSignals.oneDone();},this);}
else{allSignals.oneDone();}},this),this);}
else{allSignals.oneDone();}
if(this.state[varName].objectJson){objectsFromJson(this.context.model.meta,this.state[varName].objectJson,allSignals.pending());}
if(query.newIds){this.state[varName].signal.waitForAll(function(){if(this.state[varName].isArray){foreach(query.newIds,function(index){this.context.model[varName][index]=new(this.context.model.meta.type(query.from).get_jstype())();},this);}
else{this.context.model[varName]=new(this.context.model.meta.type(query.from).get_jstype())();}},this);allSignals.oneDone();}},this);},this,true);}
callback.call(thisPtr||this);},function ContextQuery$fetchTypes(callback,thisPtr){if(this.options.types&&this.options.types instanceof Array){for(var i=0;i<this.options.types.length;i++){var typeQuery=this.options.types[i];typeQuery.normalized=ExoWeb.Model.PathTokens.normalizePaths(typeQuery.include);ObjectLazyLoader.addPaths(typeQuery.from,typeQuery.normalized);fetchTypes(this.context.model.meta,typeQuery.from,typeQuery.normalized,allSignals.pending(null,this,true));var staticPaths=typeQuery.include?typeQuery.include.filter(function(p){return!p.startsWith("this.");}):null;if(staticPaths&&staticPaths.length>0){objectProvider(typeQuery.from,null,staticPaths,false,null,allSignals.pending(function context$objects$callback(result){objectsFromJson(this.context.model.meta,result.instances,allSignals.pending(function(){if(result.conditions){conditionsFromJson(this.context.model.meta,result.conditions,allSignals.pending());}}),this);},this,true),allSignals.orPending(function context$objects$callback(error){ExoWeb.trace.logError("objectInit","Failed to load {query.from}({query.ids}) (HTTP: {error._statusCode}, Timeout: {error._timedOut})",{query:typeQuery,error:error});},this,true),this);}}}
callback.call(thisPtr||this);},function ContextQuery$postQueries(callback,thisPtr){if(this.options.model){ExoWeb.trace.log("context","Running post query step for model queries.");ExoWeb.eachProp(this.options.model,function(varName,query){if(this.state[varName].scopeQuery){ServerSync$addScopeQuery.call(this.context.server,this.state[varName].scopeQuery);}},this);}
callback.call(thisPtr||this);},function ContextQuery$registerLazyLoader(callback,thisPtr){ExoWeb.Model.LazyLoader.register(this.context,{load:function context$load(obj,propName,callback,thisPtr){allSignals.waitForAll(function context$load$callback(){ExoWeb.Model.LazyLoader.unregister(obj,this);if(callback&&callback instanceof Function){callback.call(thisPtr||this);}},this,true);}});callback.call(thisPtr||this);},function ContextQuery$cleanup(callback,thisPtr){allSignals.waitForAll(function(){this.context.model.meta.notifyBeforeContextReady();ExoWeb.Batch.end(this.batch);},this,true);callback.call(thisPtr||this);})});Sys.activateDom=false;window.$newId=function(){return"$newId";};var activated=false;var pendingOptions;function modelReadyHandler(contextReady,extendContext,domReady){return function(){var readySignal=new Signal();if(extendContext)
extendContext(window.context,readySignal.pending());readySignal.waitForAll(function(){if(contextReady)
contextReady(window.context);$(function(){if(!activated){activated=true;Sys.Application.activateElement(document.documentElement);}
if(domReady)
domReady(window.context);});});};}
window.$exoweb=function(options){if(options instanceof Function)
options={init:options};if(!pendingOptions)
pendingOptions=options;else{pendingOptions.init=mergeFunctions(pendingOptions.init,options.init);pendingOptions.extendContext=mergeFunctions(pendingOptions.extendContext,options.extendContext,{async:true,callbackIndex:1});pendingOptions.contextReady=mergeFunctions(pendingOptions.contextReady,options.contextReady);pendingOptions.domReady=mergeFunctions(pendingOptions.domReady,options.domReady);pendingOptions.types=pendingOptions.types?(options.types?pendingOptions.types.concat(options.types):pendingOptions.types):options.types;pendingOptions.model=pendingOptions.model?$.extend(pendingOptions.model,options.model):options.model;pendingOptions.changes=pendingOptions.changes?(options.changes?pendingOptions.changes.concat(options.changes):pendingOptions.changes):options.changes;pendingOptions.conditions=pendingOptions.conditions?$.extend(pendingOptions.conditions,options.conditions):options.conditions;pendingOptions.instances=pendingOptions.instances?$.extend(pendingOptions.instances,options.instances):options.instances;}
if(!(pendingOptions.model||pendingOptions.types||pendingOptions.instances||pendingOptions.conditions||pendingOptions.changes)){if(window.context&&pendingOptions.init){pendingOptions.init(window.context);pendingOptions.init=null;}
if(window.context&&window.context.isModelReady()&&(pendingOptions.contextReady||pendingOptions.extendContext||pendingOptions.domReady)){window.context.addModelReady(modelReadyHandler(pendingOptions.contextReady,pendingOptions.extendContext,pendingOptions.domReady));pendingOptions.contextReady=null;pendingOptions.extendContext=null;pendingOptions.domReady=null;}
return;}
var currentOptions=pendingOptions;pendingOptions=null;window.context=window.context||new Context();if(currentOptions.init)
currentOptions.init(window.context);Context$query.call(window.context,{model:currentOptions.model,types:currentOptions.types,changes:currentOptions.changes,conditions:currentOptions.conditions,instances:currentOptions.instances});if(currentOptions.contextReady||currentOptions.extendContext||currentOptions.domReady||!activated)
window.context.addModelReady(modelReadyHandler(currentOptions.contextReady,currentOptions.extendContext,currentOptions.domReady));};var pendingTypeExtensions={};var pendingSubtypeExtensions={};function raiseExtensions(mtype){var exts=pendingTypeExtensions[mtype.get_fullName()];if(exts){delete pendingTypeExtensions[mtype.get_fullName()];exts(mtype.get_jstype());}
mtype.eachBaseType(function(baseType){var subExts=pendingSubtypeExtensions[baseType.get_fullName()];if(subExts){subExts(mtype.get_jstype());}});}
function extendOne(typeName,callback,thisPtr){var jstype=ExoWeb.Model.Model.getJsType(typeName,true);if(jstype&&ExoWeb.Model.LazyLoader.isLoaded(jstype.meta)){callback.call(thisPtr||this,jstype);}
else{var pending=pendingTypeExtensions[typeName];if(!pending){pending=pendingTypeExtensions[typeName]=ExoWeb.Functor();}
pending.add(thisPtr?callback.bind(thisPtr):callback);}}
window.$extend=function Mapper$extend(typeInfo,callback,thisPtr){if(!typeInfo){ExoWeb.trace.throwAndLog("extend","Invalid value passed into $extend, argument must be of type String or String[].");}
if(typeInfo instanceof Array){var signal=new ExoWeb.Signal("extend");var types=[];Array.forEach(typeInfo,function(item,index){if(item.constructor!==String){ExoWeb.trace.throwAndLog("extend","Invalid value passed into $extend, item in array must be of type String.");}
extendOne(item,signal.pending(function(type){types[index]=type;}),thisPtr);});signal.waitForAll(function(){callback.apply(thisPtr||this,types);});}
else{if(typeInfo.constructor!==String){ExoWeb.trace.throwAndLog("extend","Invalid value passed into $extend, argument must be of type String or String[].");}
extendOne(typeInfo,callback,thisPtr);}};window.$extendSubtypes=function extendSubtypes(typeName,callback,thisPtr){if(!typeName||typeName.constructor!==String){ExoWeb.trace.throwAndLog("extend","Invalid value passed into $extendSubtypes, argument must be of type String.");}
var jstype=ExoWeb.Model.Model.getJsType(typeName,true);if(jstype){Array.forEach(jstype.meta.derivedTypes||[],function(mtype){if(mtype&&ExoWeb.Model.LazyLoader.isLoaded(mtype)){callback.call(thisPtr||this,mtype.get_jstype());Array.forEach(mtype.derivedTypes||[],arguments.callee.spliceArguments(1,2));}});}
var pending=pendingSubtypeExtensions[typeName];if(!pending){pending=pendingSubtypeExtensions[typeName]=ExoWeb.Functor();}
pending.add(thisPtr?callback.bind(thisPtr):callback);};})();