@prefix = File.dirname(__FILE__)

@src_dir = ENV["SRC_DIR"] || File.join(@prefix, "src")
@dist_dir = ENV["DIST_DIR"] || File.join(@prefix, "dist")

@no_jslint = ENV["NO_JSLINT"]

# returns the contents of the given file, with each line
# indented with the given number of tabs
def read file, indent=0, exports=nil
	result = ""
	File.open(file, "r") do |f|
		last_line = nil
		while (line = f.gets)
			# ignore export statements
			if (line =~ /^\s*exports\.(.*\s*=\s*.*;)\s*\/\/\s*IGNORE$/) == 0 then next end
			# translate export statements
			if (line =~ /^\s*exports\.(.*\s*=\s*.*;)$/) == 0
				line = line.sub(/^\s*exports\.(.*\s*=\s*.*;)$/, exports + ".\\1")
			end
			# ignore require statements
			if (line =~ /(var [A-Za-z_$][A-Za-z_$0-9]* = )?require\(/) == 0 then next end
			# indent all non-empty lines
			if indent > 0 and (line =~ /\A\s*\Z/) == nil and (line =~ /\A\/\/\t+/) == nil
				result += ("\t" * indent)
			end
			result += line
		end
	end
	return result
end

# define the files in each module
@src_files = {
	"base/core" => %w{
		Function
		Array
		String
		Trace
		Cache
		Activity
		Batch
		Signal
		Functor
		FunctionChain
		EventQueue 
		EvalWrapper
		Transform
		Translator
		Utilities
		TimeSpan
		Object
		PropertyObserver
		MsAjax},

	"base/model" => %w{
		Format
		Model
		Entity
		Type
		Property
		PathTokens
		PropertyChain
		ObjectMeta
		Rule
		RuleInput
		RequiredRule
		RangeRule
		AllowedValuesRule
		CompareRule
		ErrorIfExpressionsRule
		RequiredIfRule
		RequiredIfExpressionsRule
		StringLengthRule
		ConditionTypeSet
		ConditionType
		Condition
		FormatError
		Formats
		LazyLoader},

	"base/mapper" => %w{
		ObjectProvider
		QueryProvider
		TypeProvider
		ListProvider
		RoundtripProvider
		SaveProvider
		EventProvider
		ResponseHandler
		Translation
		ExoGraphEventListener
		ChangeSet
		ChangeLog
		ServerSync
		TriggersRoundtripRule
		Internals
		TypeLazyLoader
		ObjectLazyLoader
		ListLazyLoader
		Context
		ContextQuery
		ExoWeb
		Extend},

	"base/ui" => %w{
		Toggle
		ToggleGroup
		Template
		Content
		DataView
		Html
		Behavior
		Utilities
		MsAjax},

	"base/view" => %w{
		AdapterMarkupExtension
		MetaMarkupExtension
		ConditionMarkupExtension
		LazyMarkupExtension
		Adapter
		OptionAdapter
		MsAjax},

	"extensions/jquery-msajax" => %w{
		Validation
		Selectors
		MsAjax},

	"base/mock" => %w{Mock},
	
	"extensions/dotnet" => %w{WebService}
}

@exports = {
	"base/core" => "ExoWeb",
	"base/mapper" => "ExoWeb.Mapper",
	"base/model" => "ExoWeb.Model",
	"base/view" => "ExoWeb.View",
	"base/ui" => "ExoWeb.UI",
	"extensions/jquery-msajax" => nil,
	"extensions/dotnet" => "ExoWeb.DotNet"
}

def build_content(header_args, dir, files, indent, exports)
	return files.map do |file|
			str = "\n" + ("\t" * indent) + "// #region " + file
			str += "\n" + ("\t" * indent) + ("/" * 50) + "\n\n"
			str += read(File.join(dir, file + ".js"), indent, exports)
			str += "\n" + ("\t" * indent) + "// #endregion\n"
			str
		end.join("")
end

def jshint(file_name)
	if system("node --version")
		in_path = File.join(@dist_dir, file_name + ".js")
		sh "node runjshint.js " + in_path
	end
end

def minify(file_name)
#	if system("dir")
#		run = File.join(@prefix, 'ref/jsmin/jsmin.exe')
#	else
#		run = File.join(@prefix, 'ref/jsmin/jsmin')
#	end
#
#	path = File.join(@dist_dir, file_name)
#	sh run + " < " + path + ".js > " + path + ".min.js"
end

def get_test_files(dir_name, prefix)
	res = []
	Dir.entries(File.join(dir_name, prefix)).each do |item|
		if (item =~ /^\.*$/) == nil && File::directory?(File.join(File.join(dir_name, prefix), item))
			get_test_files(dir_name, File.join(prefix, item)).each do |file|
				res.push(file)
			end
		elsif (item =~ /^test_([^\.]*)\.js$/) == 0
			res.push(File.join(prefix, item))
		end
	end
	return res
end

task :run_tests do
	if system("node --version")
		get_test_files(File.join(Dir.pwd, 'specs'), '').each do |file|
			sh "node specs" + file + " -no-date-time"
		end
	end
end

task :build_jquery_msajax_plugin do
	File.open(File.join(@dist_dir, "jquery.exoweb-msajax.js"), "w") do |f|
		f.write("\n// jquery plugin for msajax helper\n" + ("/" * 50) + "\n(function() {\n")
		src_dir = File.join(File.join(@src_dir, "extensions"), "jquery-msajax")
		header = "jquery plugin for msajax helper"
		f.write(build_content([header], src_dir, @src_files["extensions/jquery-msajax"], 1, @exports["extensions/jquery-msajax"]))
		f.write("\n})();")
	end
	puts("completed build_jquery_msajax_plugin task")
	jshint("jquery.exoweb-msajax")
	minify("jquery.exoweb-msajax")
end

task :build_msajax_nojquery do
	File.open(File.join(@dist_dir, "exoweb-msajax-nojquery.js"), "w") do |f|
		f.write("Type.registerNamespace(\"ExoWeb\");\n")
		["Model", "Mapper", "UI", "View", "DotNet"].each { |ns| f.write("Type.registerNamespace(\"ExoWeb." + ns + "\");\n") }
		f.write("\n(function() {\n")
		
		["base/core", "base/model", "base/mapper", "base/ui", "base/view", "extensions/dotnet"].each do |name|
			src_dir = @src_dir
			names = name.split("/")
			names.each { |step| src_dir = File.join(src_dir, step) }
			
			f.write(build_content([names[names.length - 1]], src_dir, @src_files[name], 1, @exports[name]))
		end

		f.write("})();\n");
	end
	puts("completed build_msajax_nojquery task")
	jshint("exoweb-msajax-nojquery")
	minify("exoweb-msajax-nojquery")
end

task :build_msajax do
	File.open(File.join(@dist_dir, "exoweb-msajax.js"), "w") do |f|
		f.write("Type.registerNamespace(\"ExoWeb\");\n")
		["Model", "Mapper", "UI", "View", "DotNet"].each { |ns| f.write("Type.registerNamespace(\"ExoWeb." + ns + "\");\n") }
		f.write("\n(function() {\n")
		
		["base/core", "base/model", "base/mapper", "base/ui", "base/view", "extensions/jquery-msajax", "extensions/dotnet"].each do |name|
			src_dir = @src_dir
			names = name.split("/")
			names.each { |step| src_dir = File.join(src_dir, step) }
			
			f.write(build_content([names[names.length - 1]], src_dir, @src_files[name], 1, @exports[name]))
		end
		
		f.write("})();\n");
	end
	puts("completed build_msajax task")
	jshint("exoweb-msajax")
	minify("exoweb-msajax")
end

task :build_base do
	File.open(File.join(@dist_dir, "exoweb-base.js"), "w") do |f|
		f.write("Type.registerNamespace(\"ExoWeb\");\n")
		["Model", "Mapper"].each { |ns| f.write("Type.registerNamespace(\"ExoWeb." + ns + "\");\n") }
		f.write("\n(function() {\n")
		
		["base/core", "base/model", "base/mapper"].each do |name|
			src_dir = @src_dir
			names = name.split("/")
			names.each { |step| src_dir = File.join(src_dir, step) }
			
			f.write(build_content([names[names.length - 1]], src_dir, @src_files[name], 1, @exports[name]))
		end
		f.write("})();\n");
	end
	puts("completed build_base task")
	jshint("exoweb-base")
	minify("exoweb-base")
end

task :default => [:run_tests, :build_msajax, :build_msajax_nojquery, :build_jquery_msajax_plugin, :build_base] do
	puts("completed default task")
end
