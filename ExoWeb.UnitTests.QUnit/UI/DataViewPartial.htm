<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>DataView Partial Update Test</title>
		<link href="../Common/Styles/qunit.css" type="text/css" rel="stylesheet" />
		<style type="text/css">
			.sys-template {display:none;}
		</style>
		<script type="text/javascript" src="../Common/Scripts/JQuery/jquery-1.3.2.js"></script>
		<script type="text/javascript" src="../Common/Scripts/QUnit/qunit.js"></script>
		<script type="text/javascript" src="../Common/Scripts/Microsoft/MicrosoftAjax.debug.js"></script>
		<script type="text/javascript" src="../Common/Scripts/Microsoft/MicrosoftAjaxTemplates.debug.js"></script>
		<script type="text/javascript" src="../Common/Scripts/ExoWeb/exoweb-msajax.js"></script>
		<script type="text/javascript" src="../Common/Scripts/QUnit/qunit.ext.js"></script>
		<script type="text/javascript" src="../Common/Model/types.js"></script>
		<script type="text/javascript" src="../Common/Model/instances.js"></script>
		<script type="text/javascript">

			defineTest("Body #1 does partial update", {
				description: "span",
				expect: 4,
				setUp: function() {
					context.model.movie.get_Genres().insert(0, new Genre({ Name: "Romance" }));
				},
				fn: function() {
					equals($("table.genres").find("tbody:nth-child(2) tr:first-child td:first-child").text(), "4", "checking rendering index");
					equals($("table.genres").find("tbody:nth-child(2) tr:first-child td:last-child").text(), "Romance", "checking rendering index");
					equals($("table.genres").find("tbody:nth-child(2) tr:last-child td:first-child").text(), "3", "checking rendering index");
					equals($("table.genres").find("tbody:nth-child(2) tr:last-child td:last-child").text(), "Drama", "checking rendering index");
				}
			});

			defineTest("Body #2 does not do partial update", {
				description: "span",
				expect: 4,
				fn: function() {
					equals($("table.genres").find("tbody:nth-child(6) tr:first-child td:first-child").text(), "1", "checking rendering index");
					equals($("table.genres").find("tbody:nth-child(6) tr:first-child td:last-child").text(), "Romance", "checking rendering index");
					equals($("table.genres").find("tbody:nth-child(6) tr:last-child td:first-child").text(), "4", "checking rendering index");
					equals($("table.genres").find("tbody:nth-child(6) tr:last-child td:last-child").text(), "Drama", "checking rendering index");
				}
			});

			timeoutTests(2000);

			window.RENDER_INDEX_DATAVIEW = 1;
			window.RENDER_INDEX_CONTENT = 1;

			ExoWeb.config.debug = true;

			$exoweb({
				model: {
					movie: { from: "Movie", id: "robin_hood" }
				},
				domReady: function() {
					executeAllTests();
				}
			});

		</script>
	</head>
	<body xmlns:sys="javascript:Sys" xmlns:dataview="javascript:Sys.UI.DataView"
		xmlns:content="javascript:ExoWeb.UI.Content" xmlns:template="javascript:ExoWeb.UI.Template" sys:activate="*">
		
		<!-- QUnit Display -->
		<h1 id="qunit-header">Test Results:</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>

		<div class="sys-template account" sys:attach="dataview" dataview:data="{~ context.model.movie, source=window }">
			<h3>{binding Title}</h3>
			<img alt="Poster" sys:src="{binding PosterUrl}" height="100" />
			<div>
				<table class="genres">
					<tbody>
						<tr>
							<th>Rendered Index</th>
							<th>Name</th>
						</tr>
					</tbody>
					<tbody class="sys-template" sys:attach="dataview" dataview:data="{binding Genres}">
						<tr>
							<td>{{ RENDER_INDEX_DATAVIEW++ }}</td>
							<td>{binding Name}</td>
						</tr>
					</tbody>
					<tbody>
						<tr>
							<th>Rendered Index</th>
							<th>Name</th>
						</tr>
					</tbody>
					<tbody class="sys-template genres-render-index" sys:attach="dataview" dataview:data="{binding Genres}">
						<tr sys:attach="content" content:data="{{ $dataItem }}"></tr>
					</tbody>
					<tbody>
						<tr>
							<th>Positional Index</th>
							<th>Name</th>
						</tr>
					</tbody>
					<tbody class="sys-template" sys:attach="dataview" dataview:data="{binding Genres}">
						<tr>
							<td>{{ $index + 1 }}</td>
							<td>{binding Name}</td>
						</tr>
					</tbody>
					<tbody>
						<tr>
							<th>Positional Index</th>
							<th>Name</th>
						</tr>
					</tbody>
					<tbody class="sys-template genres-positional-index" sys:attach="dataview" dataview:data="{binding Genres}">
						<tr sys:attach="content" content:data="{{ $dataItem }}"></tr>
					</tbody>
				</table>
			</div>
		</div>

		<table>
			<tbody>
				<tr class="sys-template" sys:attach="template" template:for=".genres-render-index tr">
					<td>{{ RENDER_INDEX_CONTENT++ }}</td>
					<td>{binding Name}</td>
				</tr>
			</tbody>
			<tbody>
				<tr class="sys-template" sys:attach="template" template:for=".genres-positional-index tr">
					<td>{{ $index + 1 }}</td>
					<td>{binding Name}</td>
				</tr>
			</tbody>
		</table>
	</body>
</html>
