<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>DataView Partial Update Test</title>
		<link href="../Common/Styles/qunit.css" type="text/css" rel="stylesheet" />
		
		<script src="../Common/Scripts/JQuery/jquery-1.3.2.js" type="text/javascript"></script>
		<script src="../Common/Scripts/QUnit/qunit.js" type="text/javascript"></script>
		<script src="../Common/Scripts/Microsoft/MicrosoftAjax.debug.js" type="text/javascript"></script>
		<script src="../Common/Scripts/Microsoft/MicrosoftAjaxTemplates.debug.js" type="text/javascript"></script>
		<script src="../Common/Scripts/ExoWeb/exoweb-msajax.js" type="text/javascript"></script>
		<script src="../Common/Scripts/QUnit/qunit.ext.js" type="text/javascript"></script>
		<script type="text/javascript">
			var account = {
				Name: "Checking",
				Owner: {
					Name: "John Doe"
				},
				Transactions: [
					{
						Type: "Debit",
						Amount: 1000000
					}
				]
			};

			Sys.Observer.makeObservable(account.Transactions);

			window.RENDER_INDEX_DATAVIEW = 1;
			window.RENDER_INDEX_CONTENT = 1;
		</script>
		<script type="text/javascript">

			defineTest("Body #1 does partial update", { description: "span", expect: 4 }, function() {
				equals($("table.transactions").find("tbody:nth-child(2) tr:first-child td:first-child").text(), "2", "checking rendering index");
				equals($("table.transactions").find("tbody:nth-child(2) tr:first-child td:last-child").text(), "-400", "checking rendering index");
				equals($("table.transactions").find("tbody:nth-child(2) tr:last-child td:first-child").text(), "1", "checking rendering index");
				equals($("table.transactions").find("tbody:nth-child(2) tr:last-child td:last-child").text(), "1000000", "checking rendering index");
			});

			defineTest("Body #2 does not do partial update", { description: "span", expect: 4 }, function() {
				equals($("table.transactions").find("tbody:nth-child(6) tr:first-child td:first-child").text(), "1", "checking rendering index");
				equals($("table.transactions").find("tbody:nth-child(6) tr:first-child td:last-child").text(), "-400", "checking rendering index");
				equals($("table.transactions").find("tbody:nth-child(6) tr:last-child td:first-child").text(), "2", "checking rendering index");
				equals($("table.transactions").find("tbody:nth-child(6) tr:last-child td:last-child").text(), "1000000", "checking rendering index");
			});

			timeoutTests(2000);

			function renderComplete(sender) {
				setTimeout(function() {
					account.Transactions.insert(0, { Type: "Credit", Amount: -400 });
					executeTest("Body #1 does partial update");
					executeTest("Body #2 does not do partial update");
				}, 1000);
			}

			$(function() {
				Sys.Application.activateElement(document.documentElement);
			});

		</script>
	</head>
	<body xmlns:sys="javascript:Sys" xmlns:dataview="javascript:Sys.UI.DataView"
		xmlns:content="javascript:ExoWeb.UI.Content" xmlns:template="javascript:ExoWeb.UI.Template" sys:activate="*">
		
		<!-- QUnit Display -->
		<h1 id="qunit-header">Test Results:</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>

		<div class="sys-template account" sys:attach="dataview" dataview:data="{{ account }}" dataview:onrendered="{{ renderComplete }}">
			<h3>{ binding Name }</h3>
			<div>{ binding Owner.Name }</div>
			<div>
				<div></div>
				<table class="transactions">
					<tbody>
						<tr>
							<th>Rendered Index</th>
							<th>Type</th>
							<th>Amount</th>
						</tr>
					</tbody>
					<tbody class="sys-template" sys:attach="dataview" dataview:data="{binding Transactions}">
						<tr>
							<td>{{ RENDER_INDEX_DATAVIEW++ }}</td>
							<td>{binding Type}</td>
							<td>{binding Amount}</td>
						</tr>
					</tbody>
					<tbody>
						<tr>
							<th>Rendered Index</th>
							<th>Type</th>
							<th>Amount</th>
						</tr>
					</tbody>
					<tbody class="transactions-render-index" sys:attach="content" content:data="{binding Transactions}"></tbody>
					<tbody>
						<tr>
							<th>Positional Index</th>
							<th>Type</th>
							<th>Amount</th>
						</tr>
					</tbody>
					<tbody class="sys-template" sys:attach="dataview" dataview:data="{binding Transactions}">
						<tr>
							<td>{{ $index + 1 }}</td>
							<td>{binding Type}</td>
							<td>{binding Amount}</td>
						</tr>
					</tbody>
					<tbody>
						<tr>
							<th>Positional Index</th>
							<th>Type</th>
							<th>Amount</th>
						</tr>
					</tbody>
					<tbody class="transactions-positional-index" sys:attach="content" content:data="{binding Transactions}"></tbody>
				</table>
				<div></div>
				<div></div>
			</div>
		</div>

		<table>
			<tbody class="sys-template" sys:attach="template" template:for=".transactions-render-index">
				<tr>
					<td>{{ RENDER_INDEX_CONTENT++ }}</td>
					<td>{binding Type}</td>
					<td>{binding Amount}</td>
				</tr>
			</tbody>
			<tbody class="sys-template" sys:attach="template" template:for=".transactions-positional-index">
				<tr>
					<td>{{ $index + 1 }}</td>
					<td>{binding Type}</td>
					<td>{binding Amount}</td>
				</tr>
			</tbody>
		</table>
	</body>
</html>
