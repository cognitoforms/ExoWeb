<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Client-Server Sync Tests</title>
		<script src="../Scripts/JQuery/jquery-1.3.2.js" type="text/javascript"></script>
		<link href="../Styles/QUnit/qunit.css" type="text/css" rel="stylesheet" />
		<script src="../Scripts/QUnit/qunit.js" type="text/javascript"></script>
		<script src="../Scripts/MsAjax/MicrosoftAjax.debug.js" type="text/javascript"></script>
		<script src="../Scripts/ExoWeb/exoweb.js" type="text/javascript"></script>
		<script src="Common/exoweb.qunit.js" type="text/javascript"></script>
		<script src="../Scripts/ExoWeb/exoweb.model.js" type="text/javascript"></script>
		<script src="../Scripts/ExoWeb/exoweb.mapper.js" type="text/javascript"></script>
		<script src="../Scripts/ExoWeb/exoweb.mock.js" type="text/javascript"></script>
		<script src="../Scripts/mock-driver.js" type="text/javascript"></script>
		<script src="../Scripts/changeset.js" type="text/javascript"></script>
		<script type="text/javascript">
			ExoWeb.trace.flags.sync = true;

			var model = $model({ driver: { id: "1", from: "Driver", 
				and: ["this.Owner.Partner.Location", "this.Owner.Location.Address.State", "this.Cars", "this.Dealer", "this.Dealer.AvailableCars"]} });
			
			var undefined;

			setupTest("test1", { description: "Init with ID Translation", expect: 3 }, function() {
				equals(Dealer.meta.get("+c0"), undefined, "Dealer should not exist before init");
				
				model.sync.apply(new ChangeSet().init("Dealer", "?1").build());
				
				equals(model.sync._idMap["Dealer"]["?1"], "+c0", "Previously created object's id should be mapped from ?1 to +c0");

				ok(Dealer.meta.get("+c0"), "Dealer should exist after init");
			});

			setupTest("test2", { description: "Reference Property Changes", expect: 2 }, function() {
				equals(model.driver.Owner.Location.meta.id, "1", "Driver's owner's location should be 1");

				model.sync.apply(new ChangeSet().ref("CarOwner", "1", "Location", "OwnerLocation", "1", "2").build());

				equals(model.driver.Owner.Location.meta.id, "2", "Driver's owner's location should be 2");
			});

			setupTest("test3", { description: "Value Property Changes", expect: 2 }, function() {
				equals(model.driver.Owner.Location.Name, "Work", "Driver's owner's location name should be Work");

				model.sync.apply(new ChangeSet().val("OwnerLocation", "2", "Name", "Work", "Play").build());

				equals(model.driver.Owner.Location.Name, "Play", "Driver's owner's location name should be Play");
			});

			setupTest("test4", { description: "List Property Changes", expect: 7 }, function() {
				equals(model.driver.Cars.length, 2, "Driver should have 2 cars");
				equals(model.driver.Cars[0].Name, "Sentra", "First car is Sentra");
				equals(model.driver.Cars[1].Name, "Bike", "Second car is Bike");

				model.sync.apply(new ChangeSet().delRef("Driver", "1", "Cars", "Car", "2").build());

				equals(model.driver.Cars.length, 1, "Driver should now have 1 car");
				equals(model.driver.Cars[0].Name, "Sentra", "First car is Sentra");

				model.sync.apply(new ChangeSet().addRef("Driver", "1", "Cars", "Car", "3").build());

				equals(model.driver.Cars.length, 2, "Driver should now have 2 cars");
				equals(model.driver.Cars[1].Name, "Tank", "Second car is Tank");
			});
			
			timeoutTests(5);

			model.ready(function() {
				executeTest("test1");
				executeTest("test2");
				executeTest("test3");
				executeTest("test4");
			});
		</script>
	</head>
	<body xmlns:sys="javascript:Sys" xmlns:dataview="javascript:Sys.UI.DataView" sys:activate="*">
		
		<!-- QUnit Display -->
		<h1 id="qunit-header">Test Results:</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
	</body>
</html>
